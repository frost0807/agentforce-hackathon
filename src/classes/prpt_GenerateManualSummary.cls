/**
 * Created by ìµœì¤€ì„ on 2025-06-08.
 */

public with sharing class prpt_GenerateManualSummary {
    /**
     * ContentDocument IDë¡œ PDF ë§¤ë‰´ì–¼ê³¼ ActionRecommendation ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
     * ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œ
     * @param contentDocumentId PDF ë§¤ë‰´ì–¼ì˜ ContentDocument ID
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID (ActionRecommendation ì¡°íšŒìš©)
     * @return String ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ ìš”ì•½ í…ìŠ¤íŠ¸
     */
    public static String generateManualSummary(Id contentDocumentId, Id riskAnalyzeReportId) {
        try {
            // 1. PDF ë°ì´í„° ì¡°íšŒ
            Blob pdfData;
            String fileName = '';
            List<ContentVersion> contentVersions = [
                    SELECT Id, VersionData, Title
                    FROM ContentVersion
                    WHERE ContentDocumentId = :contentDocumentId
                    AND IsLatest = true
                    LIMIT 1
            ];

            if (contentVersions.isEmpty()) {
                System.debug(LoggingLevel.WARN, 'ContentDocumentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + contentDocumentId);
                return null;
            }

            pdfData = contentVersions[0].VersionData;
            fileName = contentVersions[0].Title;

            // 2. ActionRecommendation ë°ì´í„° ì¡°íšŒ (í•˜ìœ„ Itemë“¤ê³¼ í•¨ê»˜)
            List<ActionRecommendation__c> actionRecommendations = [
                    SELECT Id, AnalysisSummary__c,
                    (SELECT Id, Detail__c, faultDetailType__c, faultLocation__c,
                            actionIndex__c, actionDescription__c, faultType__c, faultReason__c
                    FROM ActionRecommendationItem__r
                    WHERE isChecked__c = true)
                    FROM ActionRecommendation__c
                    WHERE RiskAnalyzeReport__c = :riskAnalyzeReportId
            ];

            if (actionRecommendations.isEmpty()) {
                System.debug(LoggingLevel.WARN, 'ActionRecommendation ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + riskAnalyzeReportId);
                return null;
            }

            // 3. PDFë¥¼ Base64ë¡œ ì¸ì½”ë”©
            String pdfBase64 = EncodingUtil.base64Encode(pdfData);

            // 4. Gemini API ìš”ì²­ ìƒì„±
            String systemPrompt = buildSystemPrompt();
            String userPrompt = buildUserPrompt(actionRecommendations, fileName, riskAnalyzeReportId);

            Gemini2_5FlashApiController.Gemini2_5Request geminiRequest =
                    new Gemini2_5FlashApiController.Gemini2_5Request(systemPrompt, userPrompt, null);

            // PDF ë°ì´í„°ë¥¼ ìš”ì²­ì— ì¶”ê°€
            geminiRequest = addPdfToRequest(geminiRequest, pdfBase64);

            // ë§¤ë‰´ì–¼ ìƒì„±ì— ìµœì í™”ëœ ì„¤ì •
            geminiRequest.generationConfig.temperature = 0.2; // ì¼ê´€ì„±ì„ ìœ„í•œ ë‚®ì€ ì˜¨ë„
            geminiRequest.generationConfig.maxOutputTokens = 8192; // ì¶©ë¶„í•œ ì‘ë‹µ ê¸¸ì´
            geminiRequest.generationConfig.responseMimeType = 'text/plain'; // í…ìŠ¤íŠ¸ ì‘ë‹µ

            // 5. Gemini API í˜¸ì¶œ
            String response = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);

            if (String.isBlank(response)) {
                System.debug(LoggingLevel.WARN, 'Gemini APIë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return null;
            }

            return response;

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'generateManualSummary ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
            return null;
        }
    }

    /**
     * ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„± - LSMtron ì‚¬ì¶œì„±í˜•ê¸° ìê°€ìˆ˜ë¦¬ ì „ë¬¸ê°€
     */
    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ LSMtronì˜ ì‚¬ì¶œì„±í˜•ê¸° ìê°€ìˆ˜ë¦¬ ì „ë¬¸ ê°€ì´ë“œì…ë‹ˆë‹¤. ' +
                '20ë…„ ì´ìƒì˜ ì‚¬ì¶œì„±í˜•ê¸° ì •ë¹„ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ, ë³µì¡í•œ ê¸°ìˆ  ë§¤ë‰´ì–¼ì„ ' +
                'ì‘ì—…ìê°€ ì´í•´í•˜ê¸° ì‰½ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ê³„ë³„ ìê°€ìˆ˜ë¦¬ ê°€ì´ë“œë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ' +
                'ì œê³µëœ PDF ë§¤ë‰´ì–¼ê³¼ ë¶„ì„ëœ ìœ„í—˜ ìš”ì†Œ ë° ì„¸ë¶€ ì•¡ì…˜ ì•„ì´í…œì„ ë°”íƒ•ìœ¼ë¡œ, ' +
                'ì•ˆì „í•˜ê³  íš¨ê³¼ì ì¸ ìê°€ìˆ˜ë¦¬ ì ˆì°¨ë¥¼ ëª…í™•í•œ ë§¤ë‰´ì–¼ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ' +
                'ëª¨ë“  ì§€ì‹œì‚¬í•­ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ë©°, ì‘ì—…ìì˜ ì•ˆì „ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.';
    }

    /**
     * ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ìƒì„±
     */
    private static String buildUserPrompt(List<ActionRecommendation__c> actionRecommendations,
            String fileName,
            Id riskAnalyzeReportId) {
        String prompt = 'ğŸ”§ **ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ ìƒì„± ìš”ì²­** ğŸ”§\n\n';

        // ê¸°ë³¸ ì •ë³´
        prompt += 'ğŸ“‹ **[ë§¤ë‰´ì–¼ ìƒì„± ì •ë³´]**\n';
        prompt += 'â€¢ ìœ„í—˜ë¶„ì„ë³´ê³ ì„œ ID: ' + riskAnalyzeReportId + '\n';
        prompt += 'â€¢ ì°¸ì¡° ë§¤ë‰´ì–¼ íŒŒì¼: ' + (String.isNotBlank(fileName) ? fileName.escapeXml() : 'N/A') + '\n\n';

        // ìˆ˜í–‰í•´ì•¼ í•  ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ (ActionRecommendationItem í¬í•¨)
        prompt += 'âš ï¸ **[ìˆ˜í–‰í•´ì•¼ í•  ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ ìƒì„¸]**\n';
        if (actionRecommendations != null && !actionRecommendations.isEmpty()) {
            Integer actionNum = 1;
            for (ActionRecommendation__c action : actionRecommendations) {
                prompt += '--- ì¡°ì¹˜ì‚¬í•­ #' + actionNum + ' ---\n';
                prompt += 'â€¢ ë¶„ì„ ìš”ì•½: ' + (action.AnalysisSummary__c != null ? action.AnalysisSummary__c.escapeXml() : 'N/A') + '\n';

                // ActionRecommendationItem ë°ì´í„° ì¶”ê°€
                if (action.ActionRecommendationItem__r != null && !action.ActionRecommendationItem__r.isEmpty()) {
                    prompt += 'â€¢ ì²´í¬ëœ ì„¸ë¶€ ì•¡ì…˜ ì•„ì´í…œ:\n';
                    Integer itemNum = 1;
                    for (ActionRecommendationItem__c item : action.ActionRecommendationItem__r) {
                        prompt += '  â—¦ ì•„ì´í…œ #' + itemNum + ':\n';
                        prompt += '    - ì„¸ë¶€ë‚´ìš©: ' + (item.Detail__c != null ? item.Detail__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ì•¡ì…˜ì„¤ëª…: ' + (item.actionDescription__c != null ? item.actionDescription__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ê³ ì¥ìœ í˜•: ' + (item.faultType__c != null ? item.faultType__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ê³ ì¥ìœ„ì¹˜: ' + (item.faultLocation__c != null ? item.faultLocation__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ê³ ì¥ìƒì„¸: ' + (item.faultDetailType__c != null ? item.faultDetailType__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ê³ ì¥ì›ì¸: ' + (item.faultReason__c != null ? item.faultReason__c.escapeXml() : 'N/A') + '\n';
                        prompt += '    - ì•¡ì…˜ì¸ë±ìŠ¤: ' + (item.actionIndex__c != null ? item.actionIndex__c.escapeXml() : 'N/A') + '\n';
                        itemNum++;
                    }
                } else {
                    prompt += 'â€¢ ì²´í¬ëœ ì„¸ë¶€ ì•¡ì…˜ ì•„ì´í…œ: ì—†ìŒ\n';
                }
                prompt += '-------------------------\n';
                actionNum++;
            }
        } else {
            prompt += 'ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.\n';
        }
        prompt += '\n';

        // ë§¤ë‰´ì–¼ ìƒì„± ìš”êµ¬ì‚¬í•­
        prompt += 'âœ… **[ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ ìƒì„± ìš”êµ¬ì‚¬í•­]**\n\n';
        prompt += 'ğŸ“ **ë§¤ë‰´ì–¼ êµ¬ì„± í˜•ì‹:**\n';
        prompt += '1. **ì•ˆì „ ì£¼ì˜ì‚¬í•­** - ì‘ì—… ì „ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ì•ˆì „ ìˆ˜ì¹™\n';
        prompt += '2. **í•„ìš” ë„êµ¬ ë° ë¶€í’ˆ** - ì‘ì—…ì— í•„ìš”í•œ ë„êµ¬ì™€ êµì²´ ë¶€í’ˆ ëª©ë¡\n';
        prompt += '3. **ì‚¬ì „ ì¤€ë¹„ì‚¬í•­** - ì‘ì—… ì „ ì¤€ë¹„í•´ì•¼ í•  ì ˆì°¨\n';
        prompt += '4. **ë‹¨ê³„ë³„ ìˆ˜ë¦¬ ì ˆì°¨** - ë²ˆí˜¸ê°€ ë§¤ê²¨ì§„ ìƒì„¸í•œ ì‘ì—… ë‹¨ê³„\n';
        prompt += '5. **ì‘ì—… ì™„ë£Œ í™•ì¸** - ìˆ˜ë¦¬ í›„ ì ê²€ ë° í…ŒìŠ¤íŠ¸ ë°©ë²•\n';
        prompt += '6. **ë¬¸ì œ í•´ê²°** - ì‘ì—… ì¤‘ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì™€ í•´ê²°ë°©ë²•\n\n';

        prompt += 'ğŸ¯ **ì‘ì„± ì§€ì¹¨:**\n';
        prompt += 'â€¢ ì²¨ë¶€ëœ PDF ë§¤ë‰´ì–¼ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±\n';
        prompt += 'â€¢ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ê³¼ ì²´í¬ëœ ì„¸ë¶€ ì•¡ì…˜ ì•„ì´í…œì— ë§ëŠ” êµ¬ì²´ì ì¸ ìˆ˜ë¦¬ ì ˆì°¨ í¬í•¨\n';
        prompt += 'â€¢ ê³ ì¥ ìœ í˜•, ìœ„ì¹˜, ì›ì¸ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì •í™•í•œ ì§„ë‹¨ê³¼ ìˆ˜ë¦¬ ë°©ë²• ì œì‹œ\n';
        prompt += 'â€¢ ì‘ì—…ìê°€ ì§ì ‘ ìˆ˜í–‰ ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì „í•œ ì‘ì—…ë§Œ í¬í•¨\n';
        prompt += 'â€¢ ì „ë¬¸ ê¸°ìˆ ì í˜¸ì¶œì´ í•„ìš”í•œ ê²½ìš° ëª…í™•íˆ í‘œì‹œ\n';
        prompt += 'â€¢ ê° ë‹¨ê³„ë§ˆë‹¤ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ ê¸°ì¤€ ì œì‹œ\n';
        prompt += 'â€¢ ìœ„í—˜í•œ ì‘ì—…ì— ëŒ€í•´ì„œëŠ” âš ï¸ ê²½ê³  í‘œì‹œ ì‚¬ìš©\n';
        prompt += 'â€¢ ë²ˆí˜¸ê°€ ë§¤ê²¨ì§„ ë‹¨ê³„ë³„ ì ˆì°¨ë¡œ ëª…í™•í•˜ê²Œ êµ¬ì„±\n\n';

        prompt += 'ğŸ“‹ **ì‘ë‹µ í˜•ì‹:**\n';
        prompt += 'ë§¤ë‰´ì–¼ í˜•ì‹ì˜ í…ìŠ¤íŠ¸ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”. JSONì´ë‚˜ ë‹¤ë¥¸ êµ¬ì¡°í™”ëœ í˜•ì‹ì´ ì•„ë‹Œ ' +
                'ì‘ì—…ìê°€ ë°”ë¡œ ì½ê³  ë”°ë¼í•  ìˆ˜ ìˆëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ ë§¤ë‰´ì–¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n';

        prompt += 'ğŸš¨ **ì¤‘ìš”ì‚¬í•­:**\n';
        prompt += 'â€¢ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±\n';
        prompt += 'â€¢ ì•ˆì „ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•œ ì ˆì°¨ ì œì‹œ\n';
        prompt += 'â€¢ ì‹¤ì œ ì‘ì—… í˜„ì¥ì—ì„œ ë°”ë¡œ í™œìš© ê°€ëŠ¥í•œ ì‹¤ìš©ì ì¸ ë‚´ìš©\n';
        prompt += 'â€¢ LSMtron ì‚¬ì¶œì„±í˜•ê¸°ì˜ íŠ¹ì„±ì„ ê³ ë ¤í•œ ë§ì¶¤í˜• ê°€ì´ë“œ\n';
        prompt += 'â€¢ ì œê³µëœ ê³ ì¥ ì •ë³´(ìœ í˜•, ìœ„ì¹˜, ì›ì¸)ë¥¼ ë°˜ë“œì‹œ ë§¤ë‰´ì–¼ì— ë°˜ì˜\n';

        return prompt;
    }

    /**
     * Gemini ìš”ì²­ì— PDF ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” í—¬í¼ ë©”ì†Œë“œ
     */
    private static Gemini2_5FlashApiController.Gemini2_5Request addPdfToRequest(
            Gemini2_5FlashApiController.Gemini2_5Request request,
            String pdfBase64) {

        // ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ì— PDF ì¶”ê°€
        if (request.contents != null && !request.contents.isEmpty()) {
            for (Integer i = request.contents.size() - 1; i >= 0; i--) {
                if (request.contents[i].role == 'user') {
                    if (request.contents[i].parts == null) {
                        request.contents[i].parts = new List<Gemini2_5FlashApiController.Gemini2_5RequestPart>();
                    }
                    // PDFë¥¼ ì²« ë²ˆì§¸ë¡œ ì¶”ê°€
                    request.contents[i].parts.add(0,
                            new Gemini2_5FlashApiController.Gemini2_5RequestPart(pdfBase64, 'application/pdf'));
                    break;
                }
            }
        }

        return request;
    }
}