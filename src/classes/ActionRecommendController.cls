/************************************************************************************
* File Name   	    : ActionRecommendController
* Author	  		: Jiae.Tak
* Date				: 2025-06-04
* Tester	  		:
* Target	  		:
* Description 	    : Updated for HTML/Document download with PDF corruption fix
* Modification Log
* ===================================================================================
* Ver      Date            Author          Modification
* ===================================================================================
* 1.0      2025-06-04         Jiae.Tak          Create
* 1.1      2025-06-08         Updated           Change to Document-based approach
* 1.2      2025-06-08         Updated           Fix PDF corruption issues
************************************************************************************/
public with sharing class ActionRecommendController {
    @AuraEnabled
    public static Map<String, Object> processActionRecAndProduct(Id reportId) {
        Map<String, Object> mapReturn = new Map<String, Object>();
        if (String.isBlank(reportId)) return null;
        try {
            RiskAnalyzeReport__c objReport = [
                    SELECT Id, MailContent__c, MailSubject__c, Account__c, Asset__c, Asset__r.Product2Id, Asset__r.ManufactureDate, Asset__r.InstallDate, Asset__r.Product2.Name
                    FROM RiskAnalyzeReport__c
                    WHERE Id = :reportId
                    LIMIT 1
            ];

            List<ActionRecommendation__c> listActionRecommendation = new List<ActionRecommendation__c>([
                    SELECT Id, AnalysisSummary__c
                    FROM ActionRecommendation__c
                    WHERE RiskAnalyzeReport__c = :objReport.Id
                    LIMIT 1
            ]);

            if (!listActionRecommendation.isEmpty()) {
                System.debug('ì¡´ì¬í•¨!');
                ActionRecommendation__c objActionRecommendation = listActionRecommendation[0];

                List<ActionRecommendationItem__c> listActionRecommendationItems = new List<ActionRecommendationItem__c>([
                        SELECT Id, faultDetailType__c, faultLocation__c, actionIndex__c, actionDescription__c, faultType__c, faultReason__c, isChecked__c
                        FROM ActionRecommendationItem__c
                        WHERE ActionRecommendation__c = :objActionRecommendation.Id
                ]);

                // SelectedPartItem__c ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•´ ActionRecommendationItem__c IDë“¤ì„ ìˆ˜ì§‘
                Set<Id> setActionItemIds = new Set<Id>();
                for (ActionRecommendationItem__c obj : listActionRecommendationItems) {
                    setActionItemIds.add(obj.Id);
                }

                // ActionRecommendationItem__c IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ SelectedPartItem__c ì¡°íšŒ
                List<SelectedPartItem__c> listSelectedPartItems = new List<SelectedPartItem__c>();
                if (!setActionItemIds.isEmpty()) {
                    listSelectedPartItems = [
                            SELECT Id, Product__c, PartCode__c, Quantity__c, ActionRecommendationItem__c, Product__r.ProductCode
                            FROM SelectedPartItem__c
                            WHERE ActionRecommendationItem__c IN :setActionItemIds
                    ];
                }

                // SelectedPartItem__cë¥¼ ActionRecommendationItem__c IDë³„ë¡œ ê·¸ë£¹í™”
                Map<Id, List<SelectedPartItem__c>> mapPartsByActionItem = new Map<Id, List<SelectedPartItem__c>>();
                for (SelectedPartItem__c part : listSelectedPartItems) {
                    if (!mapPartsByActionItem.containsKey(part.ActionRecommendationItem__c)) {
                        mapPartsByActionItem.put(part.ActionRecommendationItem__c, new List<SelectedPartItem__c>());
                    }
                    mapPartsByActionItem.get(part.ActionRecommendationItem__c).add(part);
                }

                // processGeminiResponseì™€ ë™ì¼í•œ êµ¬ì¡°ë¡œ ë°ì´í„° êµ¬ì„±
                mapReturn.put('hasPredictions', true);
                mapReturn.put('analysisSummary', objActionRecommendation.AnalysisSummary__c);
                mapReturn.put('actionRecommendationId', objActionRecommendation.Id);

                List<Map<String, Object>> displayRecommendedActions = new List<Map<String, Object>>();
                for (ActionRecommendationItem__c actionItem : listActionRecommendationItems) {
                    Map<String, Object> itemToDisplay = new Map<String, Object>();
                    itemToDisplay.put('Id', actionItem.Id);
                    itemToDisplay.put('actionIndex', actionItem.actionIndex__c);
                    itemToDisplay.put('faultType', actionItem.faultType__c);
                    itemToDisplay.put('faultDetailType', actionItem.faultDetailType__c);
                    itemToDisplay.put('faultReason', actionItem.faultReason__c);
                    itemToDisplay.put('faultLocation', actionItem.faultLocation__c);
                    itemToDisplay.put('actionDescription', actionItem.actionDescription__c);
                    itemToDisplay.put('isChecked', actionItem.isChecked__c);

                    List<Map<String, String>> partsNeededFormatted = new List<Map<String, String>>();
                    List<SelectedPartItem__c> partsForThisAction = mapPartsByActionItem.get(actionItem.Id);
                    if (partsForThisAction != null) {
                        for (SelectedPartItem__c part : partsForThisAction) {
                            Map<String, String> formattedPart = new Map<String, String>();
                            formattedPart.put('Id', part.Id);
                            formattedPart.put('Product__c', part.Product__c);
                            formattedPart.put('productCode', part.Product__r.ProductCode);
                            formattedPart.put('quantity', String.valueOf(part.Quantity__c));
                            partsNeededFormatted.add(formattedPart);
                        }
                    }
                    itemToDisplay.put('partsNeeded', partsNeededFormatted);
                    displayRecommendedActions.add(itemToDisplay);
                }
                mapReturn.put('recommendedActions', displayRecommendedActions);
                mapReturn.put('message', 'ê¸°ì¡´ Action Recommendation ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');

                System.debug('Existing Action Recommendation loaded: ' + JSON.serializePretty(mapReturn));

            } else {
                System.debug('ì¡´ì¬í•˜ì§€ ì•ŠìŒ!');

                List<SelfCheckItem__c> listCheckItem = new List<SelfCheckItem__c>([
                        SELECT Id, IsChecked__c, Description__c
                        FROM SelfCheckItem__c
                        WHERE RiskAnalyzeReport__c = :objReport.Id
                ]);
                System.debug('listCheckItem :: ' + listCheckItem);

                List<Product2> listProduct = new List<Product2>([
                        SELECT Id, Name, ProductCode, Price__c, Stock__c, Quantity__c, Replacement_Cycle__c
                        FROM Product2
                        WHERE Family = :objReport.Asset__r.Product2.Name
                ]);
                System.debug('listProduct :: ' + listProduct);

                List<Case> listCase = new List<Case>([
                        SELECT Id, AssetId, Subject, Description, Part_Code__c, Part_Name__c, malfuction_type__c
                                , Malfunction_Type_Detail__c, CreatedDate, Fault_Code__c, Manufacturer__c, Price__c
                                , Date_Time_Open__c, Date_Time_Close__c
                        FROM Case
                        WHERE AssetId = :objReport.Asset__c
                        AND CreatedDate = LAST_N_DAYS:365
                        ORDER BY AssetId, CreatedDate DESC
                ]);
                System.debug('listCase :: ' + listCase);

                List<Alarm_history__c> listAlarmHistories = new List<Alarm_history__c>([
                        SELECT Error_alarm__c
                        FROM Alarm_history__c
                        WHERE Asset__c = :objReport.Asset__c
                ]);
                System.debug('listAlarmHistories :: ' + listAlarmHistories.size());

                Set<Id> setErrorAlarmId = new Set<Id>();
                for (Alarm_history__c obj : listAlarmHistories) {
                    setErrorAlarmId.add(obj.Error_alarm__c);
                }

                List<Error_alarm__c> listErrorAlarm = new List<Error_alarm__c>([
                        SELECT Id, Code_L__c, Code_M__c, Code_Name_L__c, Code_Name_M__c, Alarm_Ex__c,
                                Occurrence__c, Expectation_1st__c, Expectation_2nd__c, Expectation_3rd__c,
                                Message__c, Reason_1__c, Reason_2__c, Reason_3__c
                        FROM Error_alarm__c
                        WHERE Id = :setErrorAlarmId
                ]);
                System.debug('listErrorAlarm :: ' + listErrorAlarm);

                String strSystemPrompt = buildSystemPrompt();
                String strUserPrompt = buildUserPrompt(objReport, listCheckItem, listProduct, listCase, listErrorAlarm);

                Gemini2_5FlashApiController.Gemini2_5Request geminiRequest = new Gemini2_5FlashApiController.Gemini2_5Request(strSystemPrompt, strUserPrompt, null);
                geminiRequest.generationConfig.temperature = 0.0;
                geminiRequest.generationConfig.maxOutputTokens = 60000;
                geminiRequest.generationConfig.responseMimeType = 'application/json';
                geminiRequest.generationConfig.responseSchema = getProcessActionRecAndProduct();
                String strResponse = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);

                if (String.isNotBlank(strResponse)) {
                    mapReturn = processGeminiResponse(objReport, strResponse);
                    mapReturn.put('reportId', objReport.Id);

                    System.debug('strResponse : ' + JSON.serializePretty(strResponse));
                } else {
                    mapReturn.put('hasPredictions', false);
                    mapReturn.put('reportId', objReport.Id);
                    mapReturn.put('message', 'Gemini APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    System.debug(LoggingLevel.WARN, 'Gemini API received no valid response.');
                }
            }
        } catch (Exception e) {
            System.debug('General Error updating SelfCheckItem__c: ' + e.getMessage());
            throw new AuraHandledException('An unexpected error occurred: ' + e.getMessage());
        }
        return mapReturn;
    }

    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ ì‚°ì—…ìš© ì‚¬ì¶œì„±í˜•ê¸°ì˜ ê³ ì¥ ë° ìœ„í—˜ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ' +
                'ì‚¬ì¶œì„±í˜•ê¸°ì˜ êµ¬ì¡°, ì‘ë™ ì›ë¦¬, ì¼ë°˜ì ì¸ ê³ ì¥ íŒ¨í„´ì— ëŒ€í•œ ê¹Šì€ ì§€ì‹ì„ ë³´ìœ í•˜ê³  ìˆìœ¼ë©°, ' +
                'Error Alarm ë°ì´í„°ì™€ Case ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í–¥í›„ 1-2ê°œì›” ë‚´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ' +
                'ê¸°ê³„ì  ê³ ì¥, ì„±ëŠ¥ ì €í•˜, ë¶€í’ˆ ë§ˆëª¨ ë“±ì˜ ìœ„í—˜ì„ ì •í™•íˆ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ' +
                'ë°ì´í„° íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¼ë³¸ ì›ì¸ì„ íŒŒì•…í•˜ê³ , ì˜ˆë°© ì •ë¹„ ë°©ì•ˆì„ ì œì‹œí•˜ë©°, ' +
                'ë¹„ìš© íš¨ê³¼ì ì¸ í•´ê²°ì±…ì„ ë„ì¶œí•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ì…ë‹ˆë‹¤. ' +
                'ê³ ê°ì—ê²ŒëŠ” LSMtronì˜ ìœ„í—˜ ë¶„ì„ ì „ë¬¸ Agentë¼ëŠ” ë¸Œëœë“œ ì´ë¯¸ì§€ë¡œ ì†Œê°œë˜ì§€ë§Œ, ' +
                'ì‹¤ì œë¡œëŠ” ì‚¬ì¶œì„±í˜•ê¸° ë¶„ì•¼ì˜ ê¹Šì€ ê¸°ìˆ ì  ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ' +
                'ì‘ë‹µì€ ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.';
    }

    private static String buildUserPrompt(
            RiskAnalyzeReport__c objReport,
            List<SelfCheckItem__c> listCheckItem,
            List<Product2> listProduct,
            List<Case> listCase,
            List<Error_alarm__c> listErrorAlarm
    ) {
        String prompt = 'ğŸ” **ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­** ğŸ”\n\n';
        prompt += 'ğŸ­ **[ASSET ì •ë³´: ' + objReport.Asset__c + ']**\n';
        prompt += 'â€¢ Asset ì œì¡°ì¼ì: ' + (objReport.Asset__r.ManufactureDate != null ? objReport.Asset__r.ManufactureDate.format() : 'N/A') + '\n';
        prompt += 'â€¢ Asset ì„¤ì¹˜ì¼ì: ' + (objReport.Asset__r.InstallDate != null ? objReport.Asset__r.InstallDate.format() : 'N/A') + '\n\n';

        prompt += 'ğŸš¨ **[SelfCheckItem ì‹œì‘]**\n';
        Integer selectNum = 1;
        for (SelfCheckItem__c sc : listCheckItem) {
            prompt += '--- Self Check  #' + selectNum + ' ---\n';
            prompt += 'â€¢ ì„¤ëª…: ' + sc.Description__c + '\n';
            prompt += 'â€¢ ì²´í¬ì—¬ë¶€: ' + sc.IsChecked__c + '\n';
            prompt += '-------------------------\n';
            selectNum++;
        }
        prompt += 'ğŸš¨ **[SelfCheckItem ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì‹œì‘]**\n';
        Integer caseNum = 1;
        for (Case c : listCase) {
            prompt += '--- Case #' + caseNum + ' ---\n';
            prompt += 'â€¢ ì œëª©: ' + c.Subject + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + c.Description + '\n';
            prompt += 'â€¢ ê³ ì¥ìœ í˜•: ' + (c.malfuction_type__c != null ? c.malfuction_type__c : 'N/A') + '\n';
            prompt += 'â€¢ ê³ ì¥ìƒì„¸: ' + (c.Malfunction_Type_Detail__c != null ? c.Malfunction_Type_Detail__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (c.Part_Code__c != null ? c.Part_Code__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (c.Part_Name__c != null ? c.Part_Name__c : 'N/A') + '\n';
            prompt += 'â€¢ ìƒì„±ì¼: ' + (c.Date_Time_Open__c != null ? String.valueOf(c.Date_Time_Open__c) : 'N/A') + '\n';
            prompt += 'â€¢ ì¢…ë£Œì¼: ' + (c.Date_Time_Close__c != null ? String.valueOf(c.Date_Time_Close__c) : 'N/A') + '\n';
            prompt += '-------------------------\n';
            caseNum++;
        }
        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì‹œì‘]**\n';
        Integer alarmNum = 1;
        for (Error_alarm__c alarm : listErrorAlarm) {
            prompt += '--- Alarm #' + alarmNum + ' ---\n';
            prompt += 'â€¢ ì½”ë“œ: ' + alarm.Code_L__c + '-' + alarm.Code_M__c + '\n';
            prompt += 'â€¢ ì•ŒëŒëª…: ' + (alarm.Code_Name_M__c != null ? alarm.Code_Name_M__c : 'N/A') + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + (alarm.Alarm_Ex__c != null ? alarm.Alarm_Ex__c : 'N/A') + '\n';
            prompt += 'â€¢ ë°œìƒíšŸìˆ˜: ' + (alarm.Occurrence__c != null ? alarm.Occurrence__c : 0) + '\n';
            prompt += 'â€¢ ì›ì¸1: ' + (alarm.Reason_1__c != null ? alarm.Reason_1__c : 'N/A') + '\n';
            prompt += 'â€¢ ì›ì¸2: ' + (alarm.Reason_2__c != null ? alarm.Reason_2__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼1: ' + (alarm.Expectation_1st__c != null ? alarm.Expectation_1st__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼2: ' + (alarm.Expectation_2nd__c != null ? alarm.Expectation_2nd__c : 'N/A') + '\n';
            prompt += 'â€¢ ë©”ì‹œì§€: ' + (alarm.Message__c != null ? alarm.Message__c : 'N/A') + '\n';
            prompt += '-------------------------\n';
            alarmNum++;
        }
        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[Product ë°ì´í„° ì‹œì‘]**\n';
        Integer productNum = 1;
        for (Product2 objProduct : listProduct) {
            prompt += '--- objProduct #' + productNum + ' ---\n';
            prompt += 'â€¢ Product2 Id: ' + (objProduct.Id != null ? objProduct.Id : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (objProduct.Name != null ? objProduct.Name : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (objProduct.ProductCode != null ? objProduct.ProductCode : 'N/A') + '\n';
            prompt += 'â€¢ ê°€ê²©: ' + (objProduct.Price__c != null ? objProduct.Price__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ì—¬ë¶€: ' + (objProduct.Stock__c != null ? objProduct.Stock__c : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ìˆ˜: ' + (objProduct.Quantity__c != null ? objProduct.Quantity__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ êµì²´ì£¼ê¸°: ' + (objProduct.Replacement_Cycle__c != null ? objProduct.Replacement_Cycle__c : 'N/A') + '\n';
            prompt += '-------------------------\n';
            productNum++;
        }
        prompt += 'âš ï¸ **[Product ë°ì´í„° ì¢…ë£Œ]**\n\n';
        prompt += 'ğŸ”š **[ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­ ì™„ë£Œ]**\n';
        prompt += '==========================================\n\n';

        prompt += 'âœ… **[ë¶„ì„ ìš”êµ¬ì‚¬í•­]**\n\n';
        prompt += 'ğŸ“§ **1. ìê°€ ì ê²€ ê²°ê³¼ ê¸°ë°˜ í–‰ë™ ì¶”ì²œ:**\n';
        prompt += '     - **analysisSummary (String):** ê³ ê°ì˜ ìê°€ ì ê²€ `IsChecked__c` ê°’ì´ `true`ì¸ í•­ëª©ë“¤ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ í˜„ì¬ ê¸°ê³„ ìƒíƒœì— ëŒ€í•œ ìš”ì•½ê³¼ ì ì¬ì  ë¬¸ì œì ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ' +
                'íŠ¹íˆ `false`ì¸ í•­ëª©ì´ ìˆë‹¤ë©´, ì´ëŠ” ì •ìƒì ì¸ ìƒíƒœë¥¼ ì˜ë¯¸í•˜ë¯€ë¡œ, `true`ì¸ í•­ëª©ì— ë”ìš± ì§‘ì¤‘í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.\n';
        prompt += '     - **recommendedActions (Array of Objects):** ê³ ê°ì˜ ìê°€ ì ê²€ ê²°ê³¼(`IsChecked__c`ê°€ `true`ì¸ í•­ëª©)ì™€ ì œê³µëœ Case, Error Alarm ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ ì¶”ì²œ ëª©ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.\n';
        prompt += '         - **actionIndex (Integer):** ê° ì¶”ì²œ í–‰ë™ì˜ ê³ ìœ  ì¸ë±ìŠ¤.\n';
        prompt += '         - **faultType (String):** ì˜ˆì¸¡ë˜ëŠ” ê³ ì¥ ìœ í˜• (ì˜ˆ: "M)ì œì–´(ì•ŒëŒ/ë™ì‘ì´ìƒ)"). Case ë°ì´í„°ì˜ `malfuction_type__c` ë˜ëŠ” Error Alarmì˜ `Code_Name_M__c`ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultDetailType (String):** ê³ ì¥ ì„¸ë¶€ ìœ í˜• (ì˜ˆ: "M01)í†µì‹ ì•ŒëŒ", "L03)ìœ ì••ìœ  ëˆ„ìœ "). Case ë°ì´í„°ì˜ `Malfunction_Type_Detail__c` ë˜ëŠ” Error Alarmì˜ `Alarm_Ex__c`ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultReason (String):** ì˜ˆìƒë˜ëŠ” ê³ ì¥ ì›ì¸ (ì˜ˆ: "CC10)ì‚¬ìš©/ë¶€í’ˆ/ê¸°ëŠ¥ê³ ì¥", "ì˜¤ì¼ ì—´í™”", "ì„¼ì„œ ì˜¤ì‘ë™"). Error Alarmì˜ `Reason_1__c`, `Reason_2__c` ë˜ëŠ” Caseì˜ `Description`ì„ ì°¸ê³ í•˜ì—¬ ì¶”ë¡ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultLocation (String):** ê²°í•¨ ì˜ˆìƒ ìœ„ì¹˜ (ì˜ˆ: "EL)ì „ì¥", "HY)ìœ ì••ë¶€", "MO)ëª¨í„°ë¶€"). Caseë‚˜ Error Alarm ë°ì´í„°ì—ì„œ ìœ ì¶”í•˜ê±°ë‚˜, ìê°€ ì ê²€ ì§ˆë¬¸ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.\n';
        prompt += '         - **actionDescription (String):** í•´ë‹¹ ê³ ì¥  ìœ í˜• ë° ì›ì¸ì— ëŒ€í•œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í–‰ë™ ì¶”ì²œ ë‚´ìš©. (ì˜ˆ: "ì œì–´ë°˜ ë‚´ë¶€ íŒ¬ ì ê²€ ë° ë¨¼ì§€ ì œê±°, í•„ìš”ì‹œ ì—´í™”ìƒ ì¹´ë©”ë¼ë¡œ ì˜¨ë„ ì¸¡ì •", "ìœ ì••ìœ  ìƒíƒœ ì ê²€ ë° êµì²´", "ê´€ë ¨ ì„¼ì„œ ë‹¨ìë¶€ ì²­ì†Œ ë° ì¬ì—°ê²°").\n';
        prompt += '         - **partsNeeded (Array of Objects):** í•´ë‹¹ ì¡°ì¹˜ì— í•„ìš”í•  ìˆ˜ ìˆëŠ” Product2 ë ˆì½”ë“œì˜ **`Id`,`productCode`, `quantity` ë¥¼ í¬í•¨í•˜ëŠ” ê°ì²´ ë°°ì—´**. ì œê³µëœ Product2 ë°ì´í„°ì—ì„œ ê´€ë ¨ëœ ë¶€í’ˆì˜ `Id`ë¥¼ `Product__c`ë¡œ, `productCode`ë¥¼ `productCode`ë¡œ, ë°ì´í„° ë¶„ì„ í›„ í•„ìš”í•œ ë¶€í’ˆì˜ ê°œìˆ˜ë¥¼ `quantity`ë¡œ í¬í•¨í•©ë‹ˆë‹¤.\n\n';

        prompt += 'ğŸ¯ **[ì£¼ìš” ì§€ì¹¨]**\n';
        prompt += 'â€¢ ì œê³µëœ **SelfCheckItem(listCheckItem)**ì—ì„œ `IsChecked__c`ê°€ `true`ì¸ í•­ëª©ë“¤ì„ í•µì‹¬ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `true`ë¡œ ì‘ë‹µëœ ìê°€ ì ê²€ í•­ëª©ê³¼ ê³¼ê±° Case, Error Alarm ë°ì´í„°ë¥¼ ìƒí˜¸ ì°¸ì¡°í•˜ì—¬, ì–´ë–¤ ê³ ì¥ ìœ í˜• ë° ì›ì¸ì´ í˜„ì¬ ë°œìƒí•˜ê³  ìˆê±°ë‚˜ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ì€ì§€ ì¶”ë¡ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ê° ì˜ˆì¸¡ëœ ë¬¸ì œì— ëŒ€í•´ ìš”êµ¬ëœ í•­ëª©ë“¤(faultType, faultDetailType, faultReason, faultLocation, actionDescription, partsNeeded)ì„ ìƒì„¸í•˜ê²Œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `actionDescription`ì€ ê³ ê°ì´ ì§ì ‘ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ìê°€ ì ê²€/ì˜ˆë°© ì •ë¹„ ê´€ì ì—ì„œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `partsNeeded`ëŠ” Product2 ë°ì´í„°ì—ì„œ ê´€ë ¨ ë¶€í’ˆì„ ì°¾ì•„ **í•´ë‹¹ ë¶€í’ˆ(Product2 Object) ì˜ `Id`ëŠ” `Product__c` í•„ë“œì—, í•´ë‹¹ ë¶€í’ˆ(Product2 Object)ì˜ ProductCode ëŠ” `productCode` í•„ë“œ, ì¶”ì²œ í–‰ë™ ì§€ì¹¨ì—ì„œ í•„ìš”í•œ ë¶€í’ˆì˜ ê°œìˆ˜ëŠ” `quantity` í•„ë“œë¡œ (`{"Product__c": "...", "productCode": "...", "quantity": "..."}`) í˜•íƒœë¡œ ì œê³µ**í•©ë‹ˆë‹¤. í•´ë‹¹ ë¶€í’ˆì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ë‘¡ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n\n';
        prompt += 'â­ ì‘ë‹µ í˜•ì‹:** {"selfCheckReport": {...}}';

        return prompt;
    }

    private static Map<String, Object> getProcessActionRecAndProduct() {
        return new Map<String, Object>{
                'type' => 'object',
                'properties' => new Map<String, Object>{
                        'selfCheckReport' => new Map<String, Object>{
                                'type' => 'object',
                                'properties' => new Map<String, Object>{
                                        'analysisSummary' => new Map<String, Object>{
                                                'type' => 'string',
                                                'description' => 'ê³ ê°ì˜ ìê°€ ì ê²€ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ í˜„ì¬ ê¸°ê³„ ìƒíƒœì™€ ì ì¬ì  ë¬¸ì œì ì„ ì„¤ëª…í•˜ëŠ” ìš”ì•½'
                                        },
                                        'recommendedActions' => new Map<String, Object>{
                                                'type' => 'array',
                                                'items' => new Map<String, Object>{
                                                        'type' => 'object',
                                                        'properties' => new Map<String, Object>{
                                                                'actionIndex' => new Map<String, Object>{
                                                                        'type' => 'integer', 'description' => 'ê° ì¶”ì²œ í–‰ë™ì˜ ê³ ìœ  ì¸ë±ìŠ¤'
                                                                },
                                                                'faultType' => new Map<String, Object>{
                                                                        'type' => 'string', 'description' => 'ì˜ˆì¸¡ë˜ëŠ” ê³ ì¥ ìœ í˜•'
                                                                },
                                                                'faultDetailType' => new Map<String, Object>{
                                                                        'type' => 'string', 'description' => 'ê³ ì¥ ì„¸ë¶€ ìœ í˜•'
                                                                },
                                                                'faultReason' => new Map<String, Object>{
                                                                        'type' => 'string', 'description' => 'ì˜ˆìƒë˜ëŠ” ê³ ì¥ ì›ì¸'
                                                                },
                                                                'faultLocation' => new Map<String, Object>{
                                                                        'type' => 'string', 'description' => 'ê²°í•¨ ì˜ˆìƒ ìœ„ì¹˜'
                                                                },
                                                                'actionDescription' => new Map<String, Object>{
                                                                        'type' => 'string', 'description' => 'êµ¬ì²´ì ì¸ í–‰ë™ ì¶”ì²œ ë‚´ìš©'
                                                                },
                                                                'partsNeeded' => new Map<String, Object>{
                                                                        'type' => 'array',
                                                                        'items' => new Map<String, Object>{
                                                                                'type' => 'object',
                                                                                'properties' => new Map<String, Object>{
                                                                                        'Product__c' => new Map<String, Object>{
                                                                                                'type' => 'string', 'description' => 'Product2 ë ˆì½”ë“œì˜ Id'
                                                                                        },
                                                                                        'productCode' => new Map<String, Object>{
                                                                                                'type' => 'string', 'description' => 'Product2 ë ˆì½”ë“œì˜ ProductCode'
                                                                                        },
                                                                                        'quantity' => new Map<String, Object>{
                                                                                                'type' => 'string', 'description' => 'í•„ìš”í•œ ìˆ˜ëŸ‰'
                                                                                        }
                                                                                },
                                                                                'required' => new List<String>{
                                                                                        'Product__c', 'productCode'
                                                                                }
                                                                        },
                                                                        'description' => 'í•´ë‹¹ ì¡°ì¹˜ì— í•„ìš”í•  ìˆ˜ ìˆëŠ” Product2 ë ˆì½”ë“œì˜ Id ë° ProductCode ëª©ë¡'
                                                                }
                                                        },
                                                        'required' => new List<String>{
                                                                'actionIndex',
                                                                'faultType',
                                                                'faultDetailType',
                                                                'faultReason',
                                                                'faultLocation',
                                                                'actionDescription',
                                                                'partsNeeded'
                                                        }
                                                }
                                        }
                                },
                                'required' => new List<String>{
                                        'analysisSummary', 'recommendedActions'
                                }
                        }
                },
                'required' => new List<String>{
                        'selfCheckReport'
                }
        };
    }

    private static Map<String, Object> processGeminiResponse(RiskAnalyzeReport__c objReport, String jsonResponse) {
        Map<String, Object> returnMap = new Map<String, Object>();
        returnMap.put('hasPredictions', false);

        try {
            Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(jsonResponse);
            Map<String, Object> selfCheckReport = (Map<String, Object>) responseMap.get('selfCheckReport');
            if (selfCheckReport == null || selfCheckReport.isEmpty()) {
                returnMap.put('message', 'No selfCheckReport found in Gemini response.');
                System.debug('No selfCheckReport found in response.');
                return returnMap;
            }

            List<Object> recommendedActions = (List<Object>) selfCheckReport.get('recommendedActions');
            if (recommendedActions == null || recommendedActions.isEmpty()) {
                returnMap.put('message', 'No recommendedActions found in selfCheckReport.');
                return returnMap;
            }

            String analysisSummary = (String) selfCheckReport.get('analysisSummary');
            if (analysisSummary != null) {
                returnMap.put('analysisSummary', analysisSummary);
            }

            ActionRecommendation__c objActionRecommendation = new ActionRecommendation__c();
            objActionRecommendation.AnalysisSummary__c = analysisSummary;
            objActionRecommendation.RiskAnalyzeReport__c = objReport.Id;

            try {
                insert objActionRecommendation;
                System.debug('objActionRecommendation inserted: ' + objActionRecommendation.Id);
                returnMap.put('actionRecommendationId', objActionRecommendation.Id);
            } catch (DmlException e) {
                System.debug(LoggingLevel.ERROR, 'Error inserting ActionRecommendation__c: ' + e.getMessage());
                returnMap.put('message', 'ActionRecommendation__c ë ˆì½”ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
                return returnMap;
            }

            List<Map<String, Object>> displayRecommendedActions = new List<Map<String, Object>>();
            List<ActionRecommendationItem__c> listActionItemToInsert = new List<ActionRecommendationItem__c>();
            List<List<SelectedPartItem__c>> listOfPartsForActionItems = new List<List<SelectedPartItem__c>>();

            for (Object actionObj : recommendedActions) {
                Map<String, Object> actionItem = (Map<String, Object>) actionObj;

                ActionRecommendationItem__c actionItemRec = new ActionRecommendationItem__c();
                actionItemRec.ActionRecommendation__c = objActionRecommendation.Id;
                actionItemRec.actionIndex__c = String.valueOf(actionItem.get('actionIndex'));
                actionItemRec.faultType__c = String.valueOf(actionItem.get('faultType'));
                actionItemRec.faultDetailType__c = String.valueOf(actionItem.get('faultDetailType'));
                actionItemRec.faultReason__c = String.valueOf(actionItem.get('faultReason'));
                actionItemRec.faultLocation__c = String.valueOf(actionItem.get('faultLocation'));
                actionItemRec.actionDescription__c = String.valueOf(actionItem.get('actionDescription'));
                actionItemRec.RiskAnalyzeReport__c = objReport.Id;
                listActionItemToInsert.add(actionItemRec);

                List<SelectedPartItem__c> currentActionParts = new List<SelectedPartItem__c>();
                List<Object> partsNeededRaw = (List<Object>) actionItem.get('partsNeeded');
                if (partsNeededRaw != null) {
                    for (Object partObj : partsNeededRaw) {
                        Map<String, Object> partMap = (Map<String, Object>) partObj;
                        String productId = String.valueOf(partMap.get('Product__c'));
                        String quantity = String.valueOf(partMap.get('quantity'));

                        SelectedPartItem__c objItem = new SelectedPartItem__c();
                        objItem.Product__c = productId;
                        objItem.Quantity__c = Integer.valueOf(quantity);
                        objItem.RiskAnalyzeReport__c = objReport.Id;
                        objItem.ExternalId__c = objReport.Id + '_' + productId;
                        currentActionParts.add(objItem);
                    }
                }
                listOfPartsForActionItems.add(currentActionParts);
            }

            if (!listActionItemToInsert.isEmpty()) {
                try {
                    insert listActionItemToInsert;

                    List<SelectedPartItem__c> finalPartsToInsert = new List<SelectedPartItem__c>();
                    for (Integer i = 0; i < listActionItemToInsert.size(); i++) {
                        ActionRecommendationItem__c savedActionItem = listActionItemToInsert[i];
                        List<SelectedPartItem__c> partsForThisAction = listOfPartsForActionItems[i];

                        for (SelectedPartItem__c part : partsForThisAction) {
                            part.ActionRecommendationItem__c = savedActionItem.Id;
                            finalPartsToInsert.add(part);
                        }
                    }

                    if (!finalPartsToInsert.isEmpty()) {
                        insert finalPartsToInsert;
                        System.debug('finalPartsToInsert inserted: ' + finalPartsToInsert);

                        Set<Id> insertedPartItemIds = new Set<Id>();
                        for (SelectedPartItem__c part : finalPartsToInsert) {
                            insertedPartItemIds.add(part.Id);
                        }
                        List<SelectedPartItem__c> retrievedParts = [SELECT Id, Product__c, Quantity__c, ActionRecommendationItem__c, PartCode__c FROM SelectedPartItem__c WHERE Id IN :insertedPartItemIds];

                        Map<Id, List<SelectedPartItem__c>> mapRetrievedPartsByActionItem = new Map<Id, List<SelectedPartItem__c>>();
                        for (SelectedPartItem__c part : retrievedParts) {
                            if (!mapRetrievedPartsByActionItem.containsKey(part.ActionRecommendationItem__c)) {
                                mapRetrievedPartsByActionItem.put(part.ActionRecommendationItem__c, new List<SelectedPartItem__c>());
                            }
                            mapRetrievedPartsByActionItem.get(part.ActionRecommendationItem__c).add(part);
                        }

                        for (Integer i = 0; i < listActionItemToInsert.size(); i++) {
                            ActionRecommendationItem__c savedActionItem = listActionItemToInsert[i];

                            Map<String, Object> itemToDisplay = new Map<String, Object>();
                            itemToDisplay.put('Id', savedActionItem.Id);
                            itemToDisplay.put('actionIndex', savedActionItem.actionIndex__c);
                            itemToDisplay.put('faultType', savedActionItem.faultType__c);
                            itemToDisplay.put('faultDetailType', savedActionItem.faultDetailType__c);
                            itemToDisplay.put('faultReason', savedActionItem.faultReason__c);
                            itemToDisplay.put('faultLocation', savedActionItem.faultLocation__c);
                            itemToDisplay.put('actionDescription', savedActionItem.actionDescription__c);
                            itemToDisplay.put('isChecked', savedActionItem.isChecked__c);

                            List<Map<String, String>> partsNeededFormatted = new List<Map<String, String>>();
                            List<SelectedPartItem__c> partsForThisAction = mapRetrievedPartsByActionItem.get(savedActionItem.Id);
                            if (partsForThisAction != null) {
                                for (SelectedPartItem__c part : partsForThisAction) {
                                    Map<String, String> formattedPart = new Map<String, String>();
                                    formattedPart.put('Id', part.Id);
                                    formattedPart.put('Product__c', part.Product__c);
                                    formattedPart.put('productCode', part.PartCode__c);
                                    formattedPart.put('quantity', String.valueOf(part.Quantity__c));
                                    partsNeededFormatted.add(formattedPart);
                                }
                            }
                            itemToDisplay.put('partsNeeded', partsNeededFormatted);
                            displayRecommendedActions.add(itemToDisplay);
                        }
                    }

                } catch (DmlException e) {
                    System.debug(LoggingLevel.ERROR, 'Error inserting ActionRecommendationItem__c or SelectedPartItem__c: ' + e.getMessage());
                    returnMap.put('message', 'ì„¸ë¶€ ë ˆì½”ë“œ ë˜ëŠ” ë¶€í’ˆ ë ˆì½”ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
                    return returnMap;
                }
            }

            returnMap.put('hasPredictions', true);
            returnMap.put('recommendedActions', displayRecommendedActions);
            returnMap.put('message', 'ì„±ê³µì ìœ¼ë¡œ ìê°€ ì ê²€ ê¸°ë°˜ í–‰ë™ ì¶”ì²œ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error processing Gemini response for display: ' + e.getMessage() + '\nStack Trace: ' + e.getStackTraceString());
            returnMap.put('message', 'ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }

        System.debug('returnMap : ' + JSON.serializePretty(returnMap));
        return returnMap;
    }

    @AuraEnabled
    public static Map<String, Object> updateActionRecommendationItems(List<Id> itemIds) {
        Map<String, Object> response = new Map<String, Object>();
        response.put('success', false);

        if (itemIds == null || itemIds.isEmpty()) {
            response.put('message', 'ì—…ë°ì´íŠ¸í•  í•­ëª© IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            System.debug(LoggingLevel.WARN, 'No item IDs provided for update.');
            return response;
        }

        List<ActionRecommendationItem__c> itemsToUpdate = new List<ActionRecommendationItem__c>();
        for (Id itemId : itemIds) {
            itemsToUpdate.add(new ActionRecommendationItem__c(
                    Id = itemId,
                    isChecked__c = true
            ));
        }
        try {
            update itemsToUpdate;
            response.put('success', true);
            response.put('message', 'ì„ íƒëœ ì¶”ì²œ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            System.debug('Successfully updated ActionRecommendationItem__c records: ' + itemIds.size() + ' records.');
        } catch (DmlException e) {
            response.put('message', 'í•­ëª© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
            System.debug(LoggingLevel.ERROR, 'Error updating ActionRecommendationItem__c records: ' + e.getMessage() + '\nStack Trace: ' + e.getStackTraceString());
        }

        return response;
    }

    @AuraEnabled
    public static DocumentDownloadResponse getDocumentDataForDownload(Id reportId) {
        System.debug('=== getDocumentDataForDownload ì‹œì‘ ===');
        System.debug('reportId: ' + reportId);

        try {
            Long startTime = System.currentTimeMillis();

            List<ContentDocumentLink> documentLinks = [
                    SELECT ContentDocumentId, ContentDocument.Title, ContentDocument.CreatedDate, ContentDocument.FileExtension
                    FROM ContentDocumentLink
                    WHERE LinkedEntityId = :reportId
                    AND (ContentDocument.Title LIKE 'ìê°€ìˆ˜ë¦¬ë§¤ë‰´ì–¼_%'
                    OR ContentDocument.Title LIKE 'ë§¤ë‰´ì–¼_%'
                    OR ContentDocument.Title LIKE 'TestManual_%')
                    ORDER BY ContentDocument.CreatedDate DESC
                    LIMIT 10
            ];

            System.debug('ì°¾ì€ ë¬¸ì„œ ìˆ˜: ' + documentLinks.size());
            for (ContentDocumentLink link : documentLinks) {
                System.debug('ë¬¸ì„œ: ' + link.ContentDocument.Title + ' (í™•ì¥ì: ' + link.ContentDocument.FileExtension + ')');
            }

            if (documentLinks.isEmpty()) {
                throw new AuraHandledException('í•´ë‹¹ ë³´ê³ ì„œì— ì—°ê²°ëœ ë§¤ë‰´ì–¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            Set<Id> contentDocumentIds = new Set<Id>();
            for (ContentDocumentLink link : documentLinks) {
                contentDocumentIds.add(link.ContentDocumentId);
            }

            List<ContentVersion> contentVersions = [
                    SELECT Id, Title, VersionData, FileExtension, ContentSize, ContentDocumentId, Checksum
                    FROM ContentVersion
                    WHERE ContentDocumentId IN :contentDocumentIds
                    AND IsLatest = true
                    ORDER BY CreatedDate DESC
            ];

            if (contentVersions.isEmpty()) {
                throw new AuraHandledException('ë§¤ë‰´ì–¼ íŒŒì¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            List<FileInfo> files = new List<FileInfo>();

            for (ContentVersion cv : contentVersions) {
                System.debug('ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼: ' + cv.Title + ' (' + cv.FileExtension + ')');

                if (cv.ContentSize > 10 * 1024 * 1024) {
                    System.debug('íŒŒì¼ì´ ë„ˆë¬´ í¼: ' + cv.ContentSize + ' bytes, ê±´ë„ˆëœ€');
                    continue;
                }

                if (cv.VersionData == null || cv.VersionData.size() == 0) {
                    System.debug('íŒŒì¼ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ, ê±´ë„ˆëœ€: ' + cv.Title);
                    continue;
                }

                if (cv.FileExtension != null && cv.FileExtension.toLowerCase() == 'pdf') {
                    if (!validatePdfBlob(cv.VersionData)) {
                        System.debug('WARNING: PDF í—¤ë”ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ: ' + cv.Title);
                    }
                }

                String base64Data;
                try {
                    base64Data = EncodingUtil.base64Encode(cv.VersionData);

                    if (String.isBlank(base64Data) || !isValidBase64(base64Data)) {
                        System.debug('Base64 ì¸ì½”ë”© ì‹¤íŒ¨: ' + cv.Title);
                        continue;
                    }
                } catch (Exception encodeEx) {
                    System.debug('Base64 ì¸ì½”ë”© ì˜¤ë¥˜: ' + cv.Title + ' - ' + encodeEx.getMessage());
                    continue;
                }

                FileInfo fileInfo = new FileInfo();
                fileInfo.fileName = cv.Title;
                fileInfo.fileType = cv.FileExtension != null ? cv.FileExtension.toLowerCase() : 'unknown';
                fileInfo.fileSize = cv.ContentSize;
                fileInfo.base64Data = base64Data;
                fileInfo.checksum = cv.Checksum;

                files.add(fileInfo);

                System.debug('íŒŒì¼ ì¶”ê°€ë¨: ' + fileInfo.fileName + ' (' + fileInfo.fileSize + ' bytes)');
            }

            if (files.isEmpty()) {
                throw new AuraHandledException('ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            DocumentDownloadResponse response = new DocumentDownloadResponse();
            response.success = true;
            response.files = files;
            response.message = 'ë¬¸ì„œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.';

            Long totalTime = System.currentTimeMillis() - startTime;
            System.debug('=== ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ - ì´ ì†Œìš”ì‹œê°„: ' + totalTime + 'ms ===');
            System.debug('ë°˜í™˜í•  íŒŒì¼ ìˆ˜: ' + files.size());

            return response;

        } catch (Exception e) {
            System.debug('=== ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨ ===');
            System.debug('ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());

            DocumentDownloadResponse response = new DocumentDownloadResponse();
            response.success = false;
            response.message = 'ë¬¸ì„œ ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage();
            response.files = new List<FileInfo>();
            return response;
        }
    }

    @AuraEnabled
    public static PdfDownloadResponse getPdfDataForDownloadDebug(Id reportId) {
        System.debug('=== getPdfDataForDownloadDebug ì‹œì‘ ===');
        System.debug('reportId: ' + reportId);

        try {
            Long startTime = System.currentTimeMillis();

            List<ContentDocumentLink> documentLinks = [
                    SELECT ContentDocumentId, ContentDocument.Title, ContentDocument.CreatedDate, ContentDocument.FileExtension
                    FROM ContentDocumentLink
                    WHERE LinkedEntityId = :reportId
                    AND (ContentDocument.Title LIKE 'TestManual_%'
                    OR ContentDocument.Title LIKE 'ìê°€ìˆ˜ë¦¬ë§¤ë‰´ì–¼_%'
                    OR ContentDocument.Title LIKE 'ë§¤ë‰´ì–¼_%')
                    ORDER BY ContentDocument.CreatedDate DESC
                    LIMIT 5
            ];

            System.debug('ì°¾ì€ ë¬¸ì„œ ìˆ˜: ' + documentLinks.size());
            for (ContentDocumentLink link : documentLinks) {
                System.debug('ë¬¸ì„œ: ' + link.ContentDocument.Title + ' (í™•ì¥ì: ' + link.ContentDocument.FileExtension + ')');
            }

            if (documentLinks.isEmpty()) {
                throw new AuraHandledException('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            Id contentDocumentId = documentLinks[0].ContentDocumentId;
            System.debug('ì„ íƒëœ ë¬¸ì„œ ID: ' + contentDocumentId);

            List<ContentVersion> contentVersions = [
                    SELECT Id, Title, VersionData, FileExtension, ContentSize, Checksum
                    FROM ContentVersion
                    WHERE ContentDocumentId = :contentDocumentId
                    AND IsLatest = true
                    LIMIT 1
            ];

            if (contentVersions.isEmpty()) {
                throw new AuraHandledException('ContentVersionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            ContentVersion cv = contentVersions[0];
            System.debug('ContentVersion ì •ë³´:');
            System.debug('- Title: ' + cv.Title);
            System.debug('- FileExtension: ' + cv.FileExtension);
            System.debug('- ContentSize: ' + cv.ContentSize);
            System.debug('- Checksum: ' + cv.Checksum);

            if (cv.ContentSize > 10 * 1024 * 1024) {
                throw new AuraHandledException('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤: ' + cv.ContentSize + ' bytes');
            }

            if (cv.ContentSize == 0) {
                throw new AuraHandledException('íŒŒì¼ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤.');
            }

            if (cv.VersionData == null) {
                throw new AuraHandledException('íŒŒì¼ ë°ì´í„°ê°€ nullì…ë‹ˆë‹¤.');
            }

            System.debug('ì‹¤ì œ Blob í¬ê¸°: ' + cv.VersionData.size());
            if (cv.VersionData.size() != cv.ContentSize) {
                System.debug('WARNING: ContentSizeì™€ ì‹¤ì œ Blob í¬ê¸° ë¶ˆì¼ì¹˜');
            }

            if (cv.FileExtension != null && cv.FileExtension.toLowerCase() == 'pdf') {
                if (!validatePdfBlob(cv.VersionData)) {
                    System.debug('WARNING: PDF í—¤ë”ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ');
                }
            }

            System.debug('Base64 ì¸ì½”ë”© ì‹œì‘');
            Long encodeStartTime = System.currentTimeMillis();

            String base64Data;
            try {
                base64Data = EncodingUtil.base64Encode(cv.VersionData);
            } catch (Exception encodeEx) {
                System.debug('Base64 ì¸ì½”ë”© ì‹¤íŒ¨: ' + encodeEx.getMessage());
                throw new AuraHandledException('íŒŒì¼ ì¸ì½”ë”© ì‹¤íŒ¨: ' + encodeEx.getMessage());
            }

            Long encodeEndTime = System.currentTimeMillis();
            System.debug('Base64 ì¸ì½”ë”© ì™„ë£Œ - ì†Œìš”ì‹œê°„: ' + (encodeEndTime - encodeStartTime) + 'ms');
            System.debug('Base64 ë°ì´í„° ê¸¸ì´: ' + base64Data.length());

            if (String.isBlank(base64Data)) {
                throw new AuraHandledException('Base64 ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }

            if (!isValidBase64(base64Data)) {
                System.debug('WARNING: Base64 í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ìˆ˜ ìˆìŒ');
            }

            Integer expectedBase64Length = (Integer) Math.ceil(cv.ContentSize * 4.0 / 3.0);
            Integer actualBase64Length = base64Data.length();
            System.debug('ì˜ˆìƒ Base64 ê¸¸ì´: ' + expectedBase64Length);
            System.debug('ì‹¤ì œ Base64 ê¸¸ì´: ' + actualBase64Length);

            Integer lengthDiff = Math.abs(actualBase64Length - expectedBase64Length);
            if (lengthDiff > 100) {
                System.debug('WARNING: Base64 ê¸¸ì´ ì°¨ì´ê°€ í¼: ' + lengthDiff);
            }

            PdfDownloadResponse response = new PdfDownloadResponse();
            response.success = true;
            response.fileName = cv.Title;
            response.base64Data = base64Data;
            response.fileSize = cv.ContentSize;
            response.fileExtension = cv.FileExtension;
            response.checksum = cv.Checksum;
            response.message = 'íŒŒì¼ ë°ì´í„° ì¡°íšŒ ì„±ê³µ';

            Long totalTime = System.currentTimeMillis() - startTime;
            System.debug('=== ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ - ì´ ì†Œìš”ì‹œê°„: ' + totalTime + 'ms ===');

            return response;

        } catch (Exception e) {
            System.debug('=== íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨ ===');
            System.debug('ì˜¤ë¥˜ íƒ€ì…: ' + e.getTypeName());
            System.debug('ì˜¤ë¥˜ ë©”ì‹œì§€: ' + e.getMessage());
            System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
            System.debug('ë¼ì¸ ë²ˆí˜¸: ' + e.getLineNumber());

            PdfDownloadResponse response = new PdfDownloadResponse();
            response.success = false;
            response.message = 'íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage();
            return response;
        }
    }

    private static Boolean validatePdfBlob(Blob pdfBlob) {
        try {
            String pdfString = pdfBlob.toString();

            if (pdfString.length() < 4) {
                System.debug('PDF íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŒ');
                return false;
            }

            String header = pdfString.substring(0, 4);
            Boolean isValid = header == '%PDF';

            System.debug('PDF í—¤ë”: ' + header + ' â†’ ìœ íš¨ì„±: ' + isValid);

            return isValid;
        } catch (Exception e) {
            System.debug('PDF ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }

    private static Boolean isValidBase64(String base64String) {
        try {
            Pattern base64Pattern = Pattern.compile('^[A-Za-z0-9+/]*={0,2}');
            Boolean matches = base64Pattern.matcher(base64String).matches();

            Boolean correctLength = Math.mod(base64String.length(), 4) == 0;

            System.debug('Base64 íŒ¨í„´ ë§¤ì¹˜: ' + matches);
            System.debug('Base64 ê¸¸ì´ í™•ì¸: ' + correctLength + ' (ê¸¸ì´: ' + base64String.length() + ')');

            return matches && correctLength;
        } catch (Exception e) {
            System.debug('Base64 ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }

    public class FileInfo {
        @AuraEnabled public String fileName;
        @AuraEnabled public String fileType;
        @AuraEnabled public Integer fileSize;
        @AuraEnabled public String base64Data;
        @AuraEnabled public String checksum;
    }

    public class DocumentDownloadResponse {
        @AuraEnabled public Boolean success;
        @AuraEnabled public List<FileInfo> files;
        @AuraEnabled public String message;
    }

    public class PdfDownloadResponse {
        @AuraEnabled public Boolean success;
        @AuraEnabled public String fileName;
        @AuraEnabled public String base64Data;
        @AuraEnabled public Integer fileSize;
        @AuraEnabled public String fileExtension;
        @AuraEnabled public String checksum;
        @AuraEnabled public String message;
    }
}