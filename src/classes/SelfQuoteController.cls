/************************************************************************************
 * File Name : SelfQuoteController.cls
 * Author : ìµœì¤€ì„
 * Date : 2025-06-04
 * Description :
 * Modification Log
 * ===================================================================================
 * Ver Date Author Modification
 * ===================================================================================
 * 1.0 2025-06-04 ìµœì¤€ì„ Create
 *************************************************************************************/
public with sharing class SelfQuoteController {
    /**
     * Service Quote ë°ì´í„° ì¡°íšŒ (ìˆ˜ì •ëœ ë©”ì„œë“œ)
     * @param serviceQuoteId Service Quote ID (ìš°ì„ ìˆœìœ„)
     * @param accountId ê³ ê°ì‚¬ ID (fallback)
     * @return ServiceQuoteResult Service Quote ë° LineItem ë°ì´í„°
     */
    @AuraEnabled(cacheable=true)
    public static ServiceQuoteResult getServiceQuoteData(String serviceQuoteId, String accountId) {
        ServiceQuoteResult result = new ServiceQuoteResult();

        try {
            System.debug('ğŸ” getServiceQuoteData called with:');
            System.debug('ğŸ” serviceQuoteId: ' + serviceQuoteId);
            System.debug('ğŸ” accountId: ' + accountId);

            // 1. serviceQuoteIdê°€ ìˆìœ¼ë©´ ì§ì ‘ Service Quote ì¡°íšŒ
            if (String.isNotBlank(serviceQuoteId)) {
                System.debug('ğŸ“‹ Service Quote IDë¡œ ì§ì ‘ ì¡°íšŒ');

                List<ServiceQuote__c> quotes = [
                        SELECT Id, Name, OfferNo__c, QuoteDate__c,
                                Method_of_Payment__c, Validity__c, Packing__c, Inspection__c,
                                DeliveryCondition__c, AccountId__c, AccountId__r.Name
                        FROM ServiceQuote__c
                        WHERE Id = :serviceQuoteId
                        LIMIT 1
                ];

                if (!quotes.isEmpty()) {
                    result.serviceQuote = quotes[0];
                    result.accountName = quotes[0].AccountId__r?.Name;

                    System.debug('âœ… Service Quote ì¡°íšŒ ì„±ê³µ: ' + quotes[0].Id);

                    // Service Quote Line Items ì¡°íšŒ
                    List<ServiceQuoteLineItem__c> lineItems = [
                            SELECT Id, ProductId__c, ProductId__r.Name, ProductId__r.ProductClassification__c,
                                    Quantity__c, UnitPrice__c, Unit__c
                            FROM ServiceQuoteLineItem__c
                            WHERE ServiceQuote__c = :quotes[0].Id
                            ORDER BY CreatedDate ASC
                    ];

                    result.lineItems = lineItems;
                    result.success = true;

                    System.debug('ğŸ“Š Line Items ê°œìˆ˜: ' + lineItems.size());
                    return result;
                } else {
                    System.debug('âš ï¸ Service Quoteë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ' + serviceQuoteId);
                }
            }

            // 2. serviceQuoteIdê°€ ì—†ê±°ë‚˜ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ accountIdë¡œ fallback
            if (String.isNotBlank(accountId)) {
                System.debug('ğŸ¢ Account IDë¡œ fallback ì¡°íšŒ');

                // Account ì •ë³´ ì¡°íšŒ
                List<Account> accounts = [
                        SELECT Id, Name, BillingAddress
                        FROM Account
                        WHERE Id = :accountId
                        LIMIT 1
                ];

                if (accounts.isEmpty()) {
                    throw new AuraHandledException('ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                result.accountName = accounts[0].Name;

                // ìµœì‹  Service Quote ì¡°íšŒ
                List<ServiceQuote__c> quotes = [
                        SELECT Id, Name, OfferNo__c, QuoteDate__c,
                                Method_of_Payment__c, Validity__c, Packing__c, Inspection__c,
                                DeliveryCondition__c
                        FROM ServiceQuote__c
                        WHERE AccountId__c = :accountId
                        ORDER BY CreatedDate DESC
                        LIMIT 1
                ];

                if (quotes.isEmpty()) {
                    throw new AuraHandledException('ê²¬ì ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                result.serviceQuote = quotes[0];

                // Service Quote Line Items ì¡°íšŒ
                List<ServiceQuoteLineItem__c> lineItems = [
                        SELECT Id, ProductId__c, ProductId__r.Name, ProductId__r.ProductClassification__c,
                                Quantity__c, UnitPrice__c, Unit__c
                        FROM ServiceQuoteLineItem__c
                        WHERE ServiceQuote__c = :quotes[0].Id
                        ORDER BY CreatedDate ASC
                ];

                result.lineItems = lineItems;
                result.success = true;

                System.debug('âœ… Account IDë¡œ ì¡°íšŒ ì„±ê³µ');
            } else {
                // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì˜¤ë¥˜
                throw new AuraHandledException('Service Quote ID ë˜ëŠ” Account IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            }

        } catch (Exception e) {
            result.success = false;
            result.message = 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage();
            System.debug('ğŸ’¥ Error in getServiceQuoteData: ' + e.getMessage());
            System.debug('ğŸ’¥ Stack trace: ' + e.getStackTraceString());
        }

        return result;
    }

    /**
     * PDF ìƒì„±, ì´ë©”ì¼ ë°œì†¡, íŒŒì¼ ì €ì¥
     * @param serviceQuoteId Service Quote ID
     * @param recipientEmail ìˆ˜ì‹ ì ì´ë©”ì¼
     * @return ServiceQuoteSaveResult ì²˜ë¦¬ ê²°ê³¼
     */
    @AuraEnabled
    public static ServiceQuoteSaveResult createPDFAndSendEmail(Id serviceQuoteId, String recipientEmail) {
        ServiceQuoteSaveResult result = new ServiceQuoteSaveResult();

        try {
            if (serviceQuoteId == null || String.isBlank(recipientEmail)) {
                result.success = false;
                result.message = 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.';
                return result;
            }

            // Service Quote ë° ê´€ë ¨ ë°ì´í„° ì¡°íšŒ
            List<ServiceQuote__c> quotes = [
                    SELECT Id, Name, OfferNo__c, QuoteDate__c, AccountId__c,
                            AccountId__r.Name, AccountId__r.BillingAddress,
                            Method_of_Payment__c, Validity__c, Packing__c, Inspection__c,
                            DeliveryCondition__c
                    FROM ServiceQuote__c
                    WHERE Id = :serviceQuoteId
                    LIMIT 1
            ];

            if (quotes.isEmpty()) {
                result.success = false;
                result.message = 'ê²¬ì ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                return result;
            }

            ServiceQuote__c quote = quotes[0];

            // Line Items ì¡°íšŒ
            List<ServiceQuoteLineItem__c> lineItems = [
                    SELECT Id, ProductId__r.Name, ProductId__r.ProductClassification__c,
                            Quantity__c, UnitPrice__c, Unit__c
                    FROM ServiceQuoteLineItem__c
                    WHERE ServiceQuote__c = :serviceQuoteId
                    ORDER BY CreatedDate ASC
            ];

            // PDF ìƒì„±
            Blob pdfBlob = generateQuotePDF(quote, lineItems);

            // íŒŒì¼ëª… ìƒì„±
            String fileName = 'Quote_' + quote.OfferNo__c + '_' +
                    String.valueOf(Date.today()).replace('-', '') + '.pdf';

            // ContentVersion ìƒì„± (íŒŒì¼ ì €ì¥)
            ContentVersion contentVersion = new ContentVersion();
            contentVersion.Title = fileName;
            contentVersion.PathOnClient = fileName;
            contentVersion.VersionData = pdfBlob;
            contentVersion.IsMajorVersion = true;
            contentVersion.Description = 'ê²¬ì ì„œ PDF - ' + quote.OfferNo__c;

            insert contentVersion;

            // ContentDocumentLink ìƒì„± (Service Quoteì— ì—°ê²°)
            ContentVersion insertedCV = [
                    SELECT ContentDocumentId
                    FROM ContentVersion
                    WHERE Id = :contentVersion.Id
            ];

            ContentDocumentLink cdl = new ContentDocumentLink();
            cdl.LinkedEntityId = serviceQuoteId;
            cdl.ContentDocumentId = insertedCV.ContentDocumentId;
            cdl.ShareType = 'V';
            cdl.Visibility = 'AllUsers';

            insert cdl;

            // ì´ë©”ì¼ ë°œì†¡
            sendQuoteEmail(quote, lineItems, pdfBlob, fileName, recipientEmail);

            result.success = true;
            result.message = 'ê²¬ì ì„œ PDFê°€ ìƒì„±ë˜ì–´ ' + recipientEmail + 'ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';

        } catch (Exception e) {
            result.success = false;
            result.message = 'PDF ìƒì„±/ë°œì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage();
            System.debug('Error in createPDFAndSendEmail: ' + e.getMessage());
        }

        return result;
    }

    /**
     * HTMLì„ ì´ìš©í•œ PDF ìƒì„±
     */
    public static Blob generateQuotePDF(ServiceQuote__c quote, List<ServiceQuoteLineItem__c> lineItems) {
        // ì´ ê¸ˆì•¡ ê³„ì‚°
        Decimal totalAmount = 0;
        Integer totalQuantity = 0;

        for (ServiceQuoteLineItem__c item : lineItems) {
            if (item.Quantity__c != null && item.UnitPrice__c != null) {
                totalAmount += (item.Quantity__c * item.UnitPrice__c);
                totalQuantity += Integer.valueOf(item.Quantity__c);
            }
        }

        // HTML í…œí”Œë¦¿ ìƒì„±
        String htmlContent = buildQuoteHTML(quote, lineItems, totalAmount, totalQuantity);

        // HTMLì„ PDFë¡œ ë³€í™˜
        Blob pdfBlob;
        if (Test.isRunningTest()) {
            pdfBlob = Blob.valueOf('Test PDF Content');
        } else {
            try {
                // PageReferenceë¥¼ ì´ìš©í•œ PDF ìƒì„±
                pdfBlob = generatePDFFromHTML(htmlContent);
            } catch (Exception e) {
                System.debug('PDF ìƒì„± ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©: ' + e.getMessage());
                pdfBlob = Blob.valueOf(htmlContent); // ì„ì‹œ ëŒ€ì²´
            }
        }

        return pdfBlob;
    }

    /**
     * HTMLì„ PDFë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ ë©”ì„œë“œ
     */
    private static Blob generatePDFFromHTML(String htmlContent) {
        // Salesforceì˜ ì œí•œëœ í™˜ê²½ì—ì„œ HTMLì„ PDFë¡œ ë³€í™˜
        // PageReferenceë¥¼ ì´ìš©í•œ PDF ìƒì„±
        try {
            PageReference tempPage = Page.ServiceQuotePDF; // ServiceQuotePDF Visualforce í˜ì´ì§€
            if (tempPage != null) {
                tempPage.getParameters().put('htmlContent', htmlContent);
                return tempPage.getContentAsPDF();
            }
        } catch (Exception e) {
            System.debug('PageReference PDF ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }

        // í´ë°±: í…ìŠ¤íŠ¸ ê¸°ë°˜ PDF ì‹œë®¬ë ˆì´ì…˜
        return Blob.valueOf(htmlContent);
    }

    /**
     * ê²¬ì ì„œ HTML í…œí”Œë¦¿ ìƒì„±
     */
    public static String buildQuoteHTML(ServiceQuote__c quote, List<ServiceQuoteLineItem__c> lineItems,
            Decimal totalAmount, Integer totalQuantity) {
        String html = '<!DOCTYPE html>';
        html += '<html><head>';
        html += '<meta charset="UTF-8">';
        html += '<style>';
        html += 'body { font-family: Arial, sans-serif; margin: 20px; }';
        html += 'table { width: 100%; border-collapse: collapse; margin: 10px 0; }';
        html += 'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }';
        html += 'th { background-color: #f2f2f2; }';
        html += '.header { text-align: center; margin-bottom: 30px; }';
        html += '.total { font-weight: bold; background-color: #f0f8ff; }';
        html += '</style>';
        html += '</head><body>';

        // í—¤ë”
        html += '<div class="header">';
        html += '<h1>ê²¬ì ì„œ</h1>';
        html += '<p>Offer No: ' + (quote.OfferNo__c != null ? quote.OfferNo__c : '') + '</p>';
        html += '<p>Quote Date: ' + (quote.QuoteDate__c != null ? quote.QuoteDate__c.format() : '') + '</p>';
        html += '</div>';

        // ê³ ê° ì •ë³´
        html += '<h2>â–  ì‚¬ìš©ì •ë³´</h2>';
        html += '<table>';
        html += '<tr><th>ê³ ê°ì‚¬</th><th>ë‹´ë‹¹ì</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr>';
        html += '<tr>';
        html += '<td>' + (quote.AccountId__r.Name != null ? quote.AccountId__r.Name : '') + '</td>';
        html += '<td>ë‹´ë‹¹ìëª…</td>';
        html += '<td>' + String.valueOf(totalQuantity) + '</td>';
        html += '<td>' + String.valueOf(totalAmount.setScale(0)) + '</td>';
        html += '</tr>';
        html += '</table>';

        // ë¶€í’ˆ ëª©ë¡
        html += '<h2>â–  ê¸°ì ì¶œì… ë° ë¶€ëŒ€ì„¤ë¹„</h2>';
        html += '<table>';
        html += '<tr><th>No.</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê¸ˆì•¡</th></tr>';

        Integer index = 1;
        for (ServiceQuoteLineItem__c item : lineItems) {
            Decimal itemTotal = (item.Quantity__c != null && item.UnitPrice__c != null) ?
                    item.Quantity__c * item.UnitPrice__c : 0;

            html += '<tr>';
            html += '<td>' + String.valueOf(index++) + '</td>';
            html += '<td>' + (item.ProductId__r.Name != null ? item.ProductId__r.Name : '') + '</td>';
            html += '<td>' + (item.ProductId__r.ProductClassification__c != null ? item.ProductId__r.ProductClassification__c : '') + '</td>';
            html += '<td>' + (item.Quantity__c != null ? String.valueOf(item.Quantity__c.setScale(0)) : '0') + '</td>';
            html += '<td>' + (item.UnitPrice__c != null ? String.valueOf(item.UnitPrice__c.setScale(0)) : '0') + '</td>';
            html += '<td>' + String.valueOf(itemTotal.setScale(0)) + '</td>';
            html += '</tr>';
        }
        html += '</table>';

        // ê²¬ì  ì¡°ê±´
        html += '<h2>â–  ê²¬ì  ì¡°ê±´</h2>';
        html += '<table>';
        html += '<tr><th>ë‚©ê¸°</th><td>' + (quote.DeliveryCondition__c != null ? quote.DeliveryCondition__c : '') + '</td>';
        html += '<th>ê²°ì œì¡°ê±´</th><td>' + (quote.Method_of_Payment__c != null ? quote.Method_of_Payment__c : '') + '</td></tr>';
        html += '<tr><th>ìœ íš¨ê¸°ê°„</th><td>' + (quote.Validity__c != null ? quote.Validity__c : '') + '</td>';
        html += '<th>í¬ì¥</th><td>' + (quote.Packing__c != null ? quote.Packing__c : '') + '</td></tr>';
        html += '<tr><th>ê²€ì‚¬</th><td>' + (quote.Inspection__c != null ? quote.Inspection__c : '') + '</td>';
        html += '<th>ê¸°íƒ€</th><td>ë³„ë„ ëª…ì‹œì‚¬í•­ ì—†ìŒ</td></tr>';
        html += '</table>';

        // ì´ ê¸ˆì•¡
        html += '<div style="margin-top: 20px; text-align: right;">';
        html += '<h3>í•©ê³„ ê¸ˆì•¡: ' + String.valueOf(totalAmount.setScale(0)) + '</h3>';
        html += '</div>';

        // í•˜ë‹¨ ë©”ëª¨
        html += '<div style="text-align: center; margin-top: 30px;">';
        html += '<p>ìƒê¸°ì™€ ê°™ì´ ê²¬ì ì„œë¥¼ ì œì¶œí•©ë‹ˆë‹¤.</p>';
        html += '</div>';

        html += '</body></html>';

        return html;
    }

    /**
     * ê²¬ì ì„œ ì´ë©”ì¼ ë°œì†¡
     */
    public static void sendQuoteEmail(ServiceQuote__c quote, List<ServiceQuoteLineItem__c> lineItems,
            Blob pdfBlob, String fileName, String recipientEmail) {

        Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
        email.setToAddresses(new String[] { recipientEmail });
        email.setSubject('ê²¬ì ì„œ - ' + quote.OfferNo__c);

        String emailBody = 'ì•ˆë…•í•˜ì„¸ìš”.\n\n';
        emailBody += 'ìš”ì²­í•˜ì‹  ê²¬ì ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
        emailBody += 'ê²¬ì ì„œ ë²ˆí˜¸: ' + quote.OfferNo__c + '\n';
        emailBody += 'ê²¬ì  ì¼ì: ' + (quote.QuoteDate__c != null ? quote.QuoteDate__c.format() : '') + '\n';
        emailBody += 'ê³ ê°ì‚¬: ' + quote.AccountId__r.Name + '\n\n';
        emailBody += 'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';
        emailBody += 'ê°ì‚¬í•©ë‹ˆë‹¤.';

        email.setPlainTextBody(emailBody);

        // PDF ì²¨ë¶€
        Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
        attachment.setFileName(fileName);
        attachment.setBody(pdfBlob);
        attachment.setContentType('application/pdf');

        email.setFileAttachments(new Messaging.EmailFileAttachment[] { attachment });

        // ì´ë©”ì¼ ë°œì†¡
        Messaging.sendEmail(new Messaging.SingleEmailMessage[] { email });
    }

    /**
     * Service Quote ë° Line Item ìƒì„±
     * @param quoteData ê²¬ì ì„œ ë°ì´í„°
     * @return QuoteResult ìƒì„± ê²°ê³¼
     */
    @AuraEnabled
    public static QuoteResult createServiceQuote(ServiceQuoteData quoteData) {
        QuoteResult result = new QuoteResult();

        try {
            if (quoteData == null) {
                result.success = false;
                result.message = 'ê²¬ì ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                return result;
            }

            // Service Quote ìƒì„±
            ServiceQuote__c serviceQuote = new ServiceQuote__c();
            serviceQuote.Name = quoteData.quoteNumber;
            serviceQuote.AccountId__c = quoteData.accountId;
            serviceQuote.QuoteDate__c = Date.valueOf(quoteData.quoteDate);
            serviceQuote.OfferNo__c = quoteData.quoteNumber;
            serviceQuote.Method_of_Payment__c = 'í˜„ê¸ˆ';
            serviceQuote.Validity__c = 'ê²¬ì ì¼ë¡œë¶€í„° 30ì¼';
            serviceQuote.Packing__c = 'ëª©ì¬í¬ì¥';
            serviceQuote.Inspection__c = 'ì‚¬ë‚´ê²€ì‚¬';
            serviceQuote.Email__c = UserInfo.getUserEmail();
            serviceQuote.QuoteCreatedBy__c = UserInfo.getName();

            insert serviceQuote;
            result.serviceQuoteId = serviceQuote.Id;

            // Service Quote Line Items ìƒì„±
            List<ServiceQuoteLineItem__c> lineItems = new List<ServiceQuoteLineItem__c>();

            for (ServiceQuoteLineData lineData : quoteData.selectedParts) {
                ServiceQuoteLineItem__c lineItem = new ServiceQuoteLineItem__c();
                lineItem.ServiceQuote__c = serviceQuote.Id;
                lineItem.ProductId__c = lineData.productId;
                lineItem.Quantity__c = lineData.quantity;
                lineItem.UnitPrice__c = lineData.unitPrice;
                lineItem.Unit__c = 'EA';

                lineItems.add(lineItem);
            }

            if (!lineItems.isEmpty()) {
                insert lineItems;
            }

            // Accountì— ì²¨ë¶€íŒŒì¼ ìƒì„± (PDF ì‹œë®¬ë ˆì´ì…˜)
            try {
                ContentVersion contentVersion = new ContentVersion();
                contentVersion.Title = 'Quote_' + quoteData.quoteNumber + '.pdf';
                contentVersion.PathOnClient = 'Quote_' + quoteData.quoteNumber + '.pdf';
                contentVersion.VersionData = createQuotePDF(quoteData);
                contentVersion.IsMajorVersion = true;

                insert contentVersion;

                // ContentDocumentLink ìƒì„±
                ContentDocumentLink cdl = new ContentDocumentLink();
                cdl.LinkedEntityId = quoteData.accountId;
                cdl.ContentDocumentId = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :contentVersion.Id].ContentDocumentId;
                cdl.ShareType = 'V';
                cdl.Visibility = 'AllUsers';

                insert cdl;

                result.attachmentId = contentVersion.Id;

            } catch (Exception attachError) {
                System.debug('ì²¨ë¶€íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ' + attachError.getMessage());
                // ì²¨ë¶€íŒŒì¼ ìƒì„± ì‹¤íŒ¨í•´ë„ ê²¬ì ì„œëŠ” ìƒì„±ë¨
            }

            result.success = true;
            result.message = 'ê²¬ì ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';

            System.debug('Service Quote created successfully: ' + serviceQuote.Id);

        } catch (Exception e) {
            result.success = false;
            result.message = 'ê²¬ì ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            System.debug('Error creating service quote: ' + e.getMessage());
        }

        return result;
    }

    /**
     * ê²¬ì ì„œ ì´ë©”ì¼ ë°œì†¡
     * @param serviceQuoteId Service Quote ID
     * @param recipientEmail ìˆ˜ì‹ ì ì´ë©”ì¼
     * @param quoteData ê²¬ì ì„œ ë°ì´í„°
     * @return EmailResult ë°œì†¡ ê²°ê³¼
     */
    @AuraEnabled
    public static EmailResult sendQuoteEmail(Id serviceQuoteId, String recipientEmail, ServiceQuoteData quoteData) {
        EmailResult result = new EmailResult();

        try {
            // ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
            Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
            email.setToAddresses(new String[] { recipientEmail });
            email.setSubject('ê²¬ì ì„œ - ' + quoteData.quoteNumber);

            String emailBody = 'ì•ˆë…•í•˜ì„¸ìš”.\n\n';
            emailBody += 'ìš”ì²­í•˜ì‹  ê²¬ì ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
            emailBody += 'ê²¬ì ì„œ ë²ˆí˜¸: ' + quoteData.quoteNumber + '\n';
            emailBody += 'ê²¬ì  ì¼ì: ' + quoteData.quoteDate + '\n';
            emailBody += 'ì´ ê¸ˆì•¡: ' + String.valueOf(quoteData.totalAmount) + 'ì›\n\n';
            emailBody += 'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';
            emailBody += 'ê°ì‚¬í•©ë‹ˆë‹¤.';

            email.setPlainTextBody(emailBody);

            // PDF ì²¨ë¶€íŒŒì¼ ì¶”ê°€
            try {
                Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                attachment.setFileName('Quote_' + quoteData.quoteNumber + '.pdf');
                attachment.setBody(createQuotePDF(quoteData));
                email.setFileAttachments(new Messaging.EmailFileAttachment[] { attachment });
            } catch (Exception attachError) {
                System.debug('ì´ë©”ì¼ ì²¨ë¶€íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ' + attachError.getMessage());
            }

            // ì´ë©”ì¼ ë°œì†¡
            Messaging.sendEmail(new Messaging.SingleEmailMessage[] { email });

            result.success = true;
            result.message = 'ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';

            System.debug('Quote email sent to: ' + recipientEmail);

        } catch (Exception e) {
            result.success = false;
            result.message = 'ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            System.debug('Error sending quote email: ' + e.getMessage());
        }

        return result;
    }

    /**
     * í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
     * @return User í˜„ì¬ ì‚¬ìš©ì
     */
    @AuraEnabled(cacheable=true)
    public static User getCurrentUser() {
        try {
            return [
                    SELECT Id, Name, Email, Username
                    FROM User
                    WHERE Id = :UserInfo.getUserId()
                    LIMIT 1
            ];
        } catch (Exception e) {
            System.debug('Error getting current user: ' + e.getMessage());
            throw new AuraHandledException('ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    /**
     * ê²¬ì ì„œ PDF ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
     * @param quoteData ê²¬ì ì„œ ë°ì´í„°
     * @return Blob PDF ë°ì´í„°
     */
    private static Blob createQuotePDF(ServiceQuoteData quoteData) {
        // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë‚˜ Visualforce PDF ë“±ì„ ì‚¬ìš©
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ë¡œ ì‹œë®¬ë ˆì´ì…˜
        String pdfContent = '=== ê²¬ì ì„œ ===\n\n';
        pdfContent += 'ê²¬ì ì„œ ë²ˆí˜¸: ' + quoteData.quoteNumber + '\n';
        pdfContent += 'ê²¬ì  ì¼ì: ' + quoteData.quoteDate + '\n';
        pdfContent += 'ê³ ê°ì‚¬: ' + (quoteData.accountId != null ? 'ê³ ê°ì‚¬ëª…' : 'N/A') + '\n\n';
        pdfContent += '=== ë¶€í’ˆ ëª©ë¡ ===\n';

        for (ServiceQuoteLineData lineData : quoteData.selectedParts) {
            pdfContent += 'ì œí’ˆ: ' + lineData.productId + '\n';
            pdfContent += 'ìˆ˜ëŸ‰: ' + lineData.quantity + '\n';
            pdfContent += 'ë‹¨ê°€: ' + lineData.unitPrice + '\n';
            pdfContent += 'í•©ê³„: ' + lineData.totalPrice + '\n\n';
        }

        pdfContent += 'ì´ ê¸ˆì•¡: ' + quoteData.totalAmount + 'ì›\n';

        return Blob.valueOf(pdfContent);
    }

    // Wrapper í´ë˜ìŠ¤ë“¤

    /**
     * Service Quote ê²°ê³¼ í´ë˜ìŠ¤
     */
    public class ServiceQuoteResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public ServiceQuote__c serviceQuote { get; set; }
        @AuraEnabled public List<ServiceQuoteLineItem__c> lineItems { get; set; }
        @AuraEnabled public String accountName { get; set; }

        public ServiceQuoteResult() {
            this.success = false;
            this.lineItems = new List<ServiceQuoteLineItem__c>();
        }
    }

    /**
     * Service Quote ì €ì¥ ê²°ê³¼ í´ë˜ìŠ¤
     */
    public class ServiceQuoteSaveResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }

        public ServiceQuoteSaveResult() {
            this.success = false;
        }
    }

    /**
     * Service Quote ë°ì´í„° êµ¬ì¡°
     */
    public class ServiceQuoteData {
        @AuraEnabled public Id accountId { get; set; }
        @AuraEnabled public String quoteNumber { get; set; }
        @AuraEnabled public String quoteDate { get; set; }
        @AuraEnabled public Decimal totalAmount { get; set; }
        @AuraEnabled public Id riskAnalyzeReportId { get; set; }
        @AuraEnabled public List<ServiceQuoteLineData> selectedParts { get; set; }

        public ServiceQuoteData() {
            this.selectedParts = new List<ServiceQuoteLineData>();
        }
    }

    /**
     * Service Quote Line Item ë°ì´í„° êµ¬ì¡°
     */
    public class ServiceQuoteLineData {
        @AuraEnabled public Id productId { get; set; }
        @AuraEnabled public Decimal quantity { get; set; }
        @AuraEnabled public Decimal unitPrice { get; set; }
        @AuraEnabled public Decimal totalPrice { get; set; }
    }

    /**
     * ê²¬ì ì„œ ìƒì„± ê²°ê³¼ í´ë˜ìŠ¤
     */
    public class QuoteResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public Id serviceQuoteId { get; set; }
        @AuraEnabled public Id attachmentId { get; set; }

        public QuoteResult() {
            this.success = false;
            this.message = '';
        }
    }

    /**
     * ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼ í´ë˜ìŠ¤
     */
    public class EmailResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }

        public EmailResult() {
            this.success = false;
            this.message = '';
        }
    }
}