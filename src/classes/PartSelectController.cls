/************************************************************************************
 * File Name : PartSelectController.cls
 * Author : ìµœì¤€ì„
 * Date : 2025-06-04
 * Description :
 * Modification Log
 * ===================================================================================
 * Ver      Date        Author      Modification
 * ===================================================================================
 * 1.0      2025-06-04  ìµœì¤€ì„         Create
 *************************************************************************************/
public with sharing class PartSelectController {

    // ê¸°ë³¸ RiskAnalyzeReport ID (ë°ëª¨ìš©) - ì‹¤ì œ ì‚¬ìš© ì‹œ ì œê±° í•„ìš”
    private static final String DEFAULT_RISK_ANALYZE_REPORT_ID = 'a0PQy000001ebWXMAY';

    /**
     * Product2 ëª©ë¡ê³¼ SelectedPartItem ëª©ë¡ì„ ë¶„ë¦¬í•´ì„œ ì¡°íšŒ
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID
     * @return PartListResult Product2 ëª©ë¡ê³¼ SelectedPartItem ëª©ë¡
     */
    @AuraEnabled(Cacheable=true)
    public static PartListResult getRecommendedParts(Id riskAnalyzeReportId) {
        PartListResult result = new PartListResult();

        try {
            System.debug('ğŸ” Input riskAnalyzeReportId: ' + riskAnalyzeReportId);

            // riskAnalyzeReportIdê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (ë°ëª¨ìš©)
            if (riskAnalyzeReportId == null) {
                riskAnalyzeReportId = DEFAULT_RISK_ANALYZE_REPORT_ID;
                System.debug('âš ï¸ Using default ID: ' + riskAnalyzeReportId);
            }

            System.debug('ğŸ” Processing riskAnalyzeReportId: ' + riskAnalyzeReportId);

            // 1. RiskAnalyzeReportì—ì„œ Asset ì •ë³´ ì¡°íšŒ
            List<RiskAnalyzeReport__c> reports = [
                    SELECT Id, Asset__c, Asset__r.Product2Id, Asset__r.Product2.ProductCode
                    FROM RiskAnalyzeReport__c
                    WHERE Id = :riskAnalyzeReportId
                    AND Asset__c != NULL
                    AND Asset__r.Product2Id != NULL
                    LIMIT 1
            ];

            if (reports.isEmpty()) {
                System.debug('âŒ RiskAnalyzeReport not found or missing Asset/Product info');
                result.success = false;
                result.message = 'RiskAnalyzeReport not found: ' + riskAnalyzeReportId;
                return result;
            }

            String assetProductCode = reports[0].Asset__r.Product2.ProductCode;
            System.debug('ğŸ¯ Asset ProductCode: ' + assetProductCode);

            // 2. í•´ë‹¹ ProductCodeë¥¼ Familyë¡œ í•˜ëŠ” ëª¨ë“  Product2 ì¡°íšŒ
            List<Product2> relatedProducts = [
                    SELECT Id, Name, ProductCode, Family,
                            ProductClassification__c, Replacement_Cycle__c,
                            Purchase_Company__c, Shipping_Lead_Time__c, Quantity__c,
                            Price__c, IsActive
                    FROM Product2
                    WHERE IsActive = TRUE
                    AND Family = :assetProductCode
                    ORDER BY ProductCode ASC
                    LIMIT 2000
            ];

            if (relatedProducts.isEmpty()) {
                System.debug('âŒ No related products found for Family: ' + assetProductCode);
                result.success = false;
                result.message = 'No related products found';
                return result;
            }

            System.debug('ğŸ“¦ Found related products: ' + relatedProducts.size());

            // 3. í•´ë‹¹ ë³´ê³ ì„œì˜ ëª¨ë“  SelectedPartItem ì¡°íšŒ
            System.debug('ğŸ” Querying SelectedPartItem for report: ' + riskAnalyzeReportId);
            List<SelectedPartItem__c> selectedParts = [
                    SELECT Id, Product__c, Quantity__c, ExternalId__c,
                            PartCode__c, PartName__c, ListPrice__c
                    FROM SelectedPartItem__c
                    WHERE RiskAnalyzeReport__c = :riskAnalyzeReportId
            ];

            System.debug('ğŸ¯ Found selected parts: ' + selectedParts.size());

            // ì„ íƒëœ ë¶€í’ˆë“¤ ìƒì„¸ ë¡œê·¸
            for (SelectedPartItem__c part : selectedParts) {
                System.debug('   â””â”€â”€ ' + part.PartCode__c + ' (Product: ' + part.Product__c + ', Qty: ' + part.Quantity__c + ')');
            }

            // 4. ê²°ê³¼ ì„¤ì •
            result.products = relatedProducts;
            result.selectedParts = selectedParts;
            result.success = true;

            System.debug('âœ… Returning result - Products: ' + result.products.size() + ', Selected Parts: ' + result.selectedParts.size());

            return result;

        } catch (Exception e) {
            System.debug('ğŸ’¥ Error retrieving recommended parts: ' + e.getMessage());
            System.debug('Stack trace: ' + e.getStackTraceString());
            result.success = false;
            result.message = e.getMessage();
            return result;
        }
    }

    /**
     * ê¸°ì¤€ Productì˜ ProductCode ì¡°íšŒ (í™”ë©´ í‘œì‹œìš©)
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID
     * @return String ê¸°ì¤€ ProductCode
     */
    @AuraEnabled(Cacheable=true)
    public static String getBaseProductCode(Id riskAnalyzeReportId) {
        try {
            System.debug('ğŸ” Getting base product code for: ' + riskAnalyzeReportId);

            // riskAnalyzeReportIdê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (riskAnalyzeReportId == null) {
                riskAnalyzeReportId = DEFAULT_RISK_ANALYZE_REPORT_ID;
                System.debug('âš ï¸ Using default ID for base product: ' + riskAnalyzeReportId);
            }

            // 1. RiskAnalyzeReportì—ì„œ Assetì˜ Product ì •ë³´ ì¡°íšŒ
            List<RiskAnalyzeReport__c> reports = [
                    SELECT Id, Asset__c, Asset__r.Product2Id, Asset__r.Product2.ProductCode
                    FROM RiskAnalyzeReport__c
                    WHERE Id = :riskAnalyzeReportId
                    AND Asset__c != NULL
                    AND Asset__r.Product2Id != NULL
                    LIMIT 1
            ];

            if (!reports.isEmpty()) {
                String productCode = reports[0].Asset__r.Product2.ProductCode;
                System.debug('âœ… Found base product code: ' + productCode);
                return productCode;
            }

            System.debug('âš ï¸ No base product found, returning demo code');
            return 'DEMO-BASE-PRODUCT';

        } catch (Exception e) {
            System.debug('ğŸ’¥ Error retrieving base product code: ' + e.getMessage());
            return 'DEMO-BASE-PRODUCT';
        }
    }

    /**
     * ì„ íƒëœ ë¶€í’ˆë“¤ì„ SelectedPartItem__c ê°ì²´ì— ì €ì¥ (ì™„ì „ ë™ê¸°í™”)
     * @param selectedParts ì €ì¥í•  ë¶€í’ˆ ì •ë³´ ë¦¬ìŠ¤íŠ¸
     * @return PartSaveResult ì €ì¥ ê²°ê³¼
     */
    @AuraEnabled
    public static PartSaveResult saveSelectedParts(List<SelectedPartData> selectedParts) {
        PartSaveResult result = new PartSaveResult();

        try {
            System.debug('ğŸ” SaveSelectedParts called with parts count: ' + (selectedParts != null ? selectedParts.size() : 0));

            if (selectedParts == null || selectedParts.isEmpty()) {
                System.debug('âš ï¸ No parts provided - will clear all selections for default report. Consider passing specific report ID for clearing.');
                // ì´ì „: return saveSelectedPartsIncremental(DEFAULT_RISK_ANALYZE_REPORT_ID, new List<SelectedPartData>());
                // ë³€ê²½ ì œì•ˆ: LWCì—ì„œ ëª…ì‹œì  IDë¡œ í˜¸ì¶œí•˜ë„ë¡ ìœ ë„í•˜ê±°ë‚˜, ì´ ë©”ì†Œë“œì˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ë³€ê²½í•˜ì—¬ IDë¥¼ ë°›ì•„ì•¼ í•¨.
                // LWCì—ì„œ `saveSelectedParts({ reportIdFromLwc: this.effectiveRiskAnalyzeReportId, selectedPartsData: [] })` í˜•íƒœë¡œ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ê¶Œì¥.
                // ì—¬ê¸°ì„œëŠ” ìš°ì„  ì´ì „ ë¡œì§ì„ ìœ ì§€í•˜ë˜, ì£¼ì„ìœ¼ë¡œ ëª…ì‹œí•©ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì´ ë¶€ë¶„ì„ ëª…í™•íˆ í•´ì•¼ í•©ë‹ˆë‹¤.
                return saveSelectedPartsIncremental(DEFAULT_RISK_ANALYZE_REPORT_ID, new List<SelectedPartData>());
            }

            // riskAnalyzeReportId ì¶”ì¶œ
            Id riskAnalyzeReportId = selectedParts[0].riskAnalyzeReportId;
            System.debug('ğŸ” Extracted riskAnalyzeReportId from first part: ' + riskAnalyzeReportId);

            if (riskAnalyzeReportId == null) {
                // LWCì—ì„œ selectedPartsDataì˜ ê° í•­ëª©ì— riskAnalyzeReportIdë¥¼ ì±„ì›Œ ë³´ë‚´ë¯€ë¡œ, ì´ ê²½ìš°ëŠ” ë“œë¬¼ì–´ì•¼ í•©ë‹ˆë‹¤.
                riskAnalyzeReportId = DEFAULT_RISK_ANALYZE_REPORT_ID;
                System.debug('âš ï¸ No ID provided in selectedParts[0], using default: ' + riskAnalyzeReportId);
            }

            // LWCì—ì„œ ì´ë¯¸ ê° partDataì— riskAnalyzeReportIdë¥¼ ì„¤ì •í•´ì„œ ë³´ë‚´ë¯€ë¡œ, ì•„ë˜ ë³´ì • ë¡œì§ì€ ì¤‘ë³µì¼ ìˆ˜ ìˆìœ¼ë‚˜ ì•ˆì „ì¥ì¹˜ë¡œ ë‘¡ë‹ˆë‹¤.
            for (SelectedPartData part : selectedParts) {
                if (part.riskAnalyzeReportId == null) {
                    part.riskAnalyzeReportId = riskAnalyzeReportId; // ì „ì²´ ì‘ì—…ì„ í†µì¼ëœ IDë¡œ ìˆ˜í–‰
                    System.debug('ğŸ”§ Fixed missing riskAnalyzeReportId for product: ' + part.productId + ' to ' + riskAnalyzeReportId);
                } else if (part.riskAnalyzeReportId != riskAnalyzeReportId) {
                    System.debug('âš ï¸ Warning: Mismatched riskAnalyzeReportId in part data. Product: ' + part.productId +
                            ' PartID: ' + part.riskAnalyzeReportId + ' vs TransactionID: ' + riskAnalyzeReportId + '. Using TransactionID.');
                    part.riskAnalyzeReportId = riskAnalyzeReportId; // ì¼ê´€ì„± ìœ ì§€
                }
            }

            return saveSelectedPartsIncremental(riskAnalyzeReportId, selectedParts);

        } catch (Exception e) {
            result.success = false;
            result.message = 'ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            System.debug('ğŸ’¥ General Error in saveSelectedParts: ' + e.getMessage());
            System.debug('Stack trace: ' + e.getStackTraceString());
            return result;
        }
    }

    /**
     * ì„ íƒëœ ë¶€í’ˆë“¤ì„ upsert/delete ì²˜ë¦¬ (ì™„ì „í•œ ë™ê¸°í™”)
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID
     * @param selectedParts í˜„ì¬ ì„ íƒëœ ë¶€í’ˆ ì •ë³´ ë¦¬ìŠ¤íŠ¸
     * @return PartSaveResult ì €ì¥ ê²°ê³¼
     */
    @AuraEnabled
    public static PartSaveResult saveSelectedPartsIncremental(Id riskAnalyzeReportId, List<SelectedPartData> selectedParts) {
        PartSaveResult result = new PartSaveResult();

        try {
            System.debug('ğŸ” SaveSelectedPartsIncremental called');
            System.debug('ğŸ” riskAnalyzeReportId: ' + riskAnalyzeReportId);
            System.debug('ğŸ” selectedParts count: ' + (selectedParts != null ? selectedParts.size() : 0));

            if (riskAnalyzeReportId == null) {
                // ì´ ë©”ì†Œë“œëŠ” ëª…ì‹œì ì¸ riskAnalyzeReportIdë¥¼ ë°›ì•„ì•¼ í•¨.
                System.debug('ğŸ’¥ Critical Error: riskAnalyzeReportId is null in saveSelectedPartsIncremental.');
                result.success = false;
                result.message = 'ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ IDê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                return result;
            }

            System.debug('ğŸ’¾ Processing incremental save for report: ' + riskAnalyzeReportId);
            System.debug('ğŸ“Š Current selected parts count: ' + (selectedParts != null ? selectedParts.size() : 0));

            // 1. í˜„ì¬ ì„ íƒëœ Product ID ëª©ë¡
            Set<Id> currentSelectedProductIds = new Set<Id>();
            Map<Id, SelectedPartData> currentSelectedPartsMap = new Map<Id, SelectedPartData>();

            if (selectedParts != null) {
                for (SelectedPartData partData : selectedParts) {
                    if (partData.productId == null) {
                        System.debug('âš ï¸ Warning: productId is null in SelectedPartData. Skipping.');
                        continue;
                    }
                    currentSelectedProductIds.add(partData.productId);
                    currentSelectedPartsMap.put(partData.productId, partData);
                    System.debug('ğŸ“‹ Part to save: ' + partData.productId + ' (Qty: ' + partData.quantity + ', Price: ' + partData.listPrice + ')');
                }
            }

            System.debug('ğŸ¯ Current selected product IDs: ' + currentSelectedProductIds);

            // 2. ê¸°ì¡´ ì €ì¥ëœ SelectedPartItem ì¡°íšŒ
            List<SelectedPartItem__c> existingParts = [
                    SELECT Id, Product__c, Quantity__c, ExternalId__c
                    FROM SelectedPartItem__c
                    WHERE RiskAnalyzeReport__c = :riskAnalyzeReportId
            ];

            System.debug('ğŸ“‚ Existing parts count: ' + existingParts.size());

            Set<Id> existingProductIds = new Set<Id>();
            Map<Id, SelectedPartItem__c> existingPartsMap = new Map<Id, SelectedPartItem__c>();

            for (SelectedPartItem__c existing : existingParts) {
                existingProductIds.add(existing.Product__c);
                existingPartsMap.put(existing.Product__c, existing);
                System.debug('ğŸ“‚ Existing part: ' + existing.Product__c + ' (Qty: ' + existing.Quantity__c + ')');
            }

            System.debug('ğŸ” Existing product IDs: ' + existingProductIds);

            // 3. ì‚­ì œí•  ë¶€í’ˆë“¤ (ê¸°ì¡´ì— ìˆì—ˆì§€ë§Œ í˜„ì¬ ì„ íƒë˜ì§€ ì•Šì€ ê²ƒë“¤)
            List<SelectedPartItem__c> partsToDelete = new List<SelectedPartItem__c>();
            for (Id existingProductId : existingProductIds) {
                if (!currentSelectedProductIds.contains(existingProductId)) {
                    partsToDelete.add(existingPartsMap.get(existingProductId));
                    System.debug('ğŸ—‘ï¸ Marked for deletion: ' + existingProductId);
                }
            }

            // 4. ì¶”ê°€í•  ë¶€í’ˆë“¤ (ìƒˆë¡œ ì„ íƒëœ ê²ƒë“¤)
            List<SelectedPartItem__c> partsToInsert = new List<SelectedPartItem__c>();
            for (Id newProductId : currentSelectedProductIds) {
                if (!existingProductIds.contains(newProductId)) {
                    SelectedPartData partData = currentSelectedPartsMap.get(newProductId);
                    SelectedPartItem__c newPart = new SelectedPartItem__c();
                    newPart.ExternalId__c = riskAnalyzeReportId + '_' + newProductId; // SelectedPartItemì˜ ExternalId
                    newPart.RiskAnalyzeReport__c = riskAnalyzeReportId;
                    newPart.Product__c = newProductId;
                    newPart.Quantity__c = partData.quantity;
                    // ListPrice__cëŠ” SelectedPartItemì— ì§ì ‘ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ Product2ë‚˜ PricebookEntryì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨.
                    // í˜„ì¬ SelectedPartItem ê°ì²´ ì •ì˜ì— ListPrice__cê°€ ìˆë‹¤ë©´ ì„¤ì •.
                    // newPart.ListPrice__c = partData.listPrice; // í•„ìš”ì‹œ ì£¼ì„ í•´ì œ ë° í•„ë“œ í™•ì¸
                    partsToInsert.add(newPart);
                    System.debug('â• Marked for insert: ' + newProductId + ' with quantity: ' + partData.quantity);
                }
            }

            // 5. ìˆ˜ì •í•  ë¶€í’ˆë“¤ (ìˆ˜ëŸ‰ ë“±ì´ ë³€ê²½ëœ ê²ƒë“¤)
            List<SelectedPartItem__c> partsToUpdate = new List<SelectedPartItem__c>();
            for (Id commonProductId : currentSelectedProductIds) {
                if (existingProductIds.contains(commonProductId)) {
                    SelectedPartItem__c existingPart = existingPartsMap.get(commonProductId);
                    SelectedPartData newPartData = currentSelectedPartsMap.get(commonProductId);

                    Boolean needsUpdate = false;
                    if (existingPart.Quantity__c != newPartData.quantity) {
                        existingPart.Quantity__c = newPartData.quantity;
                        needsUpdate = true;
                    }
                    // SelectedPartItemì— ListPrice__c í•„ë“œê°€ ìˆê³ , ê°€ê²©ë„ ì—…ë°ì´íŠ¸ ëŒ€ìƒì´ë¼ë©´ ì¶”ê°€
                    // if (existingPart.ListPrice__c != newPartData.listPrice) { // í•„ë“œ í™•ì¸ í•„ìš”
                    //    existingPart.ListPrice__c = newPartData.listPrice;
                    //    needsUpdate = true;
                    // }

                    if (needsUpdate) {
                        partsToUpdate.add(existingPart);
                        System.debug('ğŸ“ Marked for update: ' + commonProductId + ' quantity: ' + newPartData.quantity);
                    }
                }
            }

            // 6. DML ì‹¤í–‰
            Savepoint sp = Database.setSavepoint();
            try {
                Integer deletedCount = 0;
                Integer insertedCount = 0;
                Integer updatedCount = 0;

                if (!partsToDelete.isEmpty()) {
                    delete partsToDelete;
                    deletedCount = partsToDelete.size();
                    System.debug('âœ… Deleted ' + deletedCount + ' parts');
                }

                if (!partsToInsert.isEmpty()) {
                    insert partsToInsert;
                    insertedCount = partsToInsert.size();
                    System.debug('âœ… Inserted ' + insertedCount + ' parts');
                }

                if (!partsToUpdate.isEmpty()) {
                    update partsToUpdate;
                    updatedCount = partsToUpdate.size();
                    System.debug('âœ… Updated ' + updatedCount + ' parts');
                }

                result.success = true;
                result.message = String.format('ë™ê¸°í™” ì™„ë£Œ: ì¶”ê°€ {0}ê°œ, ìˆ˜ì • {1}ê°œ, ì‚­ì œ {2}ê°œ',
                        new String[]{
                                String.valueOf(insertedCount),
                                String.valueOf(updatedCount),
                                String.valueOf(deletedCount)
                        });

                List<SelectedPartItem__c> allSavedParts = new List<SelectedPartItem__c>();
                allSavedParts.addAll(partsToInsert); // insert í›„ IDê°€ ì±„ì›Œì§
                allSavedParts.addAll(partsToUpdate); // ì´ë¯¸ IDê°€ ìˆìŒ
                result.savedRecords = allSavedParts;

                System.debug('ğŸ‰ Incremental save completed successfully');
                System.debug('ğŸ“Š Final result: ' + result.message);

            } catch (DmlException e) {
                Database.rollback(sp);
                result.success = false;
                result.message = 'ì €ì¥ ì¤‘ DML ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getDmlMessage(0);
                System.debug('ğŸ’¥ DML Error in incremental save: ' + e.getMessage());
                System.debug('Stack trace: ' + e.getStackTraceString());
            }

        } catch (Exception e) {
            result.success = false;
            result.message = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            System.debug('ğŸ’¥ Error in incremental save: ' + e.getMessage());
            System.debug('Stack trace: ' + e.getStackTraceString());
        }

        return result;
    }

    /**
     * ê²¬ì ì„œ ìƒì„± ë° í™”ë©´ ì „í™˜ ì²˜ë¦¬
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID
     * @param selectedParts ì„ íƒëœ ë¶€í’ˆ ëª©ë¡
     * @return QuoteGenerationResult ì²˜ë¦¬ ê²°ê³¼
     */
    @AuraEnabled
    public static QuoteGenerationResult generateQuoteAndTransition(Id riskAnalyzeReportId, List<SelectedPartData> selectedParts) {
        QuoteGenerationResult result = new QuoteGenerationResult();

        try {
            System.debug('ğŸ” GenerateQuoteAndTransition called');
            System.debug('ğŸ” riskAnalyzeReportId: ' + riskAnalyzeReportId);

            if (riskAnalyzeReportId == null) {
                // ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì´ ê¸°ë³¸ê°’ ë¡œì§ì€ ì ì ˆí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // LWCì—ì„œ í•­ìƒ ìœ íš¨í•œ IDë¥¼ ì „ë‹¬í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
                riskAnalyzeReportId = DEFAULT_RISK_ANALYZE_REPORT_ID;
                System.debug('âš ï¸ Using default ID for quote generation: ' + riskAnalyzeReportId);
            }

            if (selectedParts == null || selectedParts.isEmpty()) {
                result.success = false;
                result.message = 'ì„ íƒëœ ë¶€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.';
                return result;
            }

            // 1. SelectedPartItem upsert (ê¸°ì¡´ ë©”ì„œë“œ í™œìš©)
            PartSaveResult partSaveResult = saveSelectedPartsIncremental(riskAnalyzeReportId, selectedParts);
            if (!partSaveResult.success) {
                result.success = false;
                result.message = 'ë¶€í’ˆ ì €ì¥ ì‹¤íŒ¨: ' + partSaveResult.message;
                return result;
            }

            // 2. RiskAnalyzeReportì—ì„œ Account ì •ë³´ ì¡°íšŒ
            List<RiskAnalyzeReport__c> reports = [
                    SELECT Id, Asset__c, Asset__r.AccountId
                    FROM RiskAnalyzeReport__c
                    WHERE Id = :riskAnalyzeReportId
                    AND Asset__c != NULL
                    AND Asset__r.AccountId != NULL
                    LIMIT 1
            ];

            if (reports.isEmpty()) {
                result.success = false;
                result.message = 'Account ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (RiskAnalyzeReportId: ' + riskAnalyzeReportId + ')';
                return result;
            }

            Id accountId = reports[0].Asset__r.AccountId;

            // 3. Service Quote ë° LineItem upsert (riskAnalyzeReportId ì „ë‹¬ ì¶”ê°€)
            Id serviceQuoteId = upsertServiceQuoteWithLineItems(accountId, riskAnalyzeReportId, selectedParts);

            result.success = true;
            result.message = 'ê²¬ì ì„œ ìƒì„± ì™„ë£Œ. Service Quote ID: ' + serviceQuoteId;
            result.serviceQuoteId = serviceQuoteId;
            result.accountId = accountId;

            Map<String, String> mapServiceQuoteId = new Map<String, String>();
            mapServiceQuoteId.put('serviceQuoteId', serviceQuoteId);

            //Self Quoteë¡œ ì „í™˜
            PublishMessageController.publishMessage('SELF_QUOTE', JSON.serialize(mapServiceQuoteId));

        } catch (Exception e) {
            result.success = false;
            result.message = 'ê²¬ì ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage();
            System.debug('ğŸ’¥ Error in generateQuoteAndTransition: ' + e.getMessage() + ' Stack: ' + e.getStackTraceString());
        }

        return result;
    }

    /**
     * Service Quote ë° LineItem upsert ì²˜ë¦¬ (External ID ê¸°ì¤€)
     * @param accountId ê³ ê°ì‚¬ ID
     * @param riskAnalyzeReportId ìœ„í—˜ ë¶„ì„ ë³´ê³ ì„œ ID (External ID êµ¬ì„±ì— ì‚¬ìš©)
     * @param selectedParts ì„ íƒëœ ë¶€í’ˆ ëª©ë¡
     * @return Id Service Quote ID
     */
    @AuraEnabled
    public static Id upsertServiceQuoteWithLineItems(Id accountId, Id riskAnalyzeReportId, List<SelectedPartData> selectedParts) {
        try {
            // ServiceQuote__c ê°ì²´ì˜ External ID í•„ë“œ API ì´ë¦„ì„ ì •í™•íˆ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            // ì˜ˆ: ExternalId__c ë˜ëŠ” CustomExternalIdField__c
            // ì´ ì˜ˆì œì—ì„œëŠ” 'ExternalId__c'ë¡œ ê°€ì •í•©ë‹ˆë‹¤. ì‹¤ì œ í•„ë“œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
            String externalIdFieldApiName = 'ExternalId__c'; // << ì¤‘ìš”: ì‹¤ì œ External ID í•„ë“œ API ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            Map<String, Schema.SObjectField> serviceQuoteFields = ServiceQuote__c.SObjectType.getDescribe().fields.getMap();

            if (!serviceQuoteFields.containsKey(externalIdFieldApiName.toLowerCase())) {
                System.debug('ğŸ’¥ Critical Error: ServiceQuote__c External ID field (' + externalIdFieldApiName + ') not found.');
                throw new AuraHandledException('ServiceQuote__cì˜ External ID í•„ë“œ(' + externalIdFieldApiName + ') ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
            SObjectField serviceQuoteExternalIdField = serviceQuoteFields.get(externalIdFieldApiName.toLowerCase());


            String serviceQuoteExternalIdValue = accountId + '_' + riskAnalyzeReportId;
            System.debug('ğŸ“‹ Processing Service Quote upsert for External ID: ' + serviceQuoteExternalIdValue);

            ServiceQuote__c serviceQuoteToUpsert = new ServiceQuote__c();

            serviceQuoteToUpsert.put(serviceQuoteExternalIdField, serviceQuoteExternalIdValue);

            serviceQuoteToUpsert.AccountId__c = accountId;

            // ServiceQuote__cì— RiskAnalyzeReport__c ì¡°íšŒ í•„ë“œê°€ ìˆë‹¤ë©´ ì„¤ì •
            // ì‹¤ì œ í•„ë“œ API ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”. (ì˜ˆ: Risk_Analyze_Report_Link__c)
            String riskReportLookupApiName = 'RiskAnalyzeReport__c'; // << ì¤‘ìš”: ì‹¤ì œ RiskAnalyzeReport ì¡°íšŒ í•„ë“œ API ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            if (serviceQuoteFields.containsKey(riskReportLookupApiName.toLowerCase())) {
                serviceQuoteToUpsert.put(riskReportLookupApiName, riskAnalyzeReportId);
                System.debug('INFO: Setting ' + riskReportLookupApiName + ' to ' + riskAnalyzeReportId);
            } else {
                System.debug('INFO: Lookup field ' + riskReportLookupApiName + ' not found on ServiceQuote__c. Skipping.');
            }

            serviceQuoteToUpsert.QuoteDate__c = Date.today();
            serviceQuoteToUpsert.Method_of_Payment__c = 'Cash'; // Picklist ê°’ í™•ì¸ í•„ìš” (ì˜ˆ: 'í˜„ê¸ˆ')
            serviceQuoteToUpsert.Validity__c = 'ê²¬ì ì¼ë¡œë¶€í„° 30ì¼';
            serviceQuoteToUpsert.Packing__c = 'ëª©ì¬í¬ì¥';
            serviceQuoteToUpsert.Inspection__c = 'ì‚¬ë‚´ê²€ì‚¬';
            serviceQuoteToUpsert.Email__c = UserInfo.getUserEmail();
            serviceQuoteToUpsert.QuoteCreatedBy__c = UserInfo.getName();
            serviceQuoteToUpsert.DeliveryCondition__c = 'í˜‘ì˜';

            List<ServiceQuote__c> existingQuotes = [
                    SELECT Id, OfferNo__c
                    FROM ServiceQuote__c
                    WHERE ExternalId__c = :serviceQuoteExternalIdValue // SOQLì—ëŠ” ì‹¤ì œ í•„ë“œëª… ì‚¬ìš©
                    LIMIT 1
            ];

            if (existingQuotes.isEmpty()) {
                serviceQuoteToUpsert.OfferNo__c = generateQuoteNumber();
                System.debug('âœ¨ New Service Quote. OfferNo generated: ' + serviceQuoteToUpsert.OfferNo__c);
            } else {
                if (String.isBlank(existingQuotes[0].OfferNo__c)) {
                    serviceQuoteToUpsert.OfferNo__c = generateQuoteNumber();
                    System.debug('ğŸ“ Existing Service Quote but OfferNo was blank. OfferNo generated: ' + serviceQuoteToUpsert.OfferNo__c);
                }
                System.debug('ğŸ“ Updating existing Service Quote. ID: ' + existingQuotes[0].Id);
            }

            System.debug('ğŸ“‹ Attempting to upsert ServiceQuote: ' + JSON.serialize(serviceQuoteToUpsert));

            Database.UpsertResult upsertResult = Database.upsert(serviceQuoteToUpsert, serviceQuoteExternalIdField, false);

            if (upsertResult.isSuccess()) {
                Id upsertedQuoteId = upsertResult.getId();
                System.debug('âœ… Upserted Service Quote successfully. ID: ' + upsertedQuoteId);

                syncServiceQuoteLineItems(upsertedQuoteId, selectedParts);
                return upsertedQuoteId;
            } else {
                String errors = '';
                for (Database.Error err : upsertResult.getErrors()) {
                    errors += err.getStatusCode() + ': ' + err.getMessage() + ' Fields: ' + String.join(err.getFields(), ',') + '; ';
                }
                System.debug('ğŸ’¥ Error upserting Service Quote: ' + errors);
                throw new AuraHandledException('Service Quote upsert ì‹¤íŒ¨: ' + errors);
            }

        } catch (Exception e) {
            System.debug('ğŸ’¥ Error in upsertServiceQuoteWithLineItems: ' + e.getMessage() + ' Stack: ' + e.getStackTraceString());
            throw new AuraHandledException('Service Quote ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
        }
    }

    /**
     * Service Quote LineItem ì™„ì „ ë™ê¸°í™” (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ)
     * @param serviceQuoteId Service Quote ID
     * @param selectedParts í˜„ì¬ ì„ íƒëœ ë¶€í’ˆ ëª©ë¡
     */
    private static void syncServiceQuoteLineItems(Id serviceQuoteId, List<SelectedPartData> selectedParts) {
        System.debug('ğŸ”„ Syncing LineItems for Service Quote: ' + serviceQuoteId);

        Set<Id> currentSelectedProductIds = new Set<Id>();
        Map<Id, SelectedPartData> currentSelectedPartsMap = new Map<Id, SelectedPartData>();

        if (selectedParts != null) {
            for (SelectedPartData partData : selectedParts) {
                if (partData.productId == null) continue;
                currentSelectedProductIds.add(partData.productId);
                currentSelectedPartsMap.put(partData.productId, partData);
            }
        }
        System.debug('ğŸ¯ Current selected product IDs for LineItems: ' + currentSelectedProductIds);

        List<ServiceQuoteLineItem__c> existingLineItems = [
                SELECT Id, ProductId__c, Quantity__c, UnitPrice__c, ExternalId__c
                FROM ServiceQuoteLineItem__c
                WHERE ServiceQuote__c = :serviceQuoteId
        ];
        System.debug('ğŸ“‚ Existing LineItems count: ' + existingLineItems.size());

        Map<Id, ServiceQuoteLineItem__c> existingLineItemsMap = new Map<Id, ServiceQuoteLineItem__c>();
        for (ServiceQuoteLineItem__c existingItem : existingLineItems) {
            existingLineItemsMap.put(existingItem.ProductId__c, existingItem);
        }

        List<ServiceQuoteLineItem__c> lineItemsToDelete = new List<ServiceQuoteLineItem__c>();
        for (ServiceQuoteLineItem__c existingItem : existingLineItems) {
            if (!currentSelectedProductIds.contains(existingItem.ProductId__c)) {
                lineItemsToDelete.add(existingItem);
                System.debug('ğŸ—‘ï¸ LineItem marked for deletion (Product): ' + existingItem.ProductId__c);
            }
        }

        List<ServiceQuoteLineItem__c> lineItemsToUpsert = new List<ServiceQuoteLineItem__c>();
        for (Id productId : currentSelectedProductIds) {
            SelectedPartData partData = currentSelectedPartsMap.get(productId);
            ServiceQuoteLineItem__c lineItem;

            if (existingLineItemsMap.containsKey(productId)) { // Update existing
                lineItem = existingLineItemsMap.get(productId);
                Boolean needsUpdate = false;
                if (lineItem.Quantity__c != partData.quantity) {
                    lineItem.Quantity__c = partData.quantity;
                    needsUpdate = true;
                }
                if (lineItem.UnitPrice__c != partData.listPrice) {
                    lineItem.UnitPrice__c = partData.listPrice;
                    needsUpdate = true;
                }
                if (needsUpdate) {
                    lineItemsToUpsert.add(lineItem);
                    System.debug('ğŸ“ LineItem marked for update (Product): ' + productId);
                }
            } else { // Insert new
                lineItem = new ServiceQuoteLineItem__c();
                lineItem.ExternalId__c = serviceQuoteId + '_' + productId; // Line Itemì˜ External ID
                lineItem.ServiceQuote__c = serviceQuoteId;
                lineItem.ProductId__c = productId;
                lineItem.Quantity__c = partData.quantity;
                lineItem.UnitPrice__c = partData.listPrice;
                lineItem.Unit__c = 'EA'; // ê¸°ë³¸ê°’ ì„¤ì •
                lineItemsToUpsert.add(lineItem);
                System.debug('â• LineItem marked for insert (Product): ' + productId);
            }
        }

        Savepoint sp = Database.setSavepoint();
        try {
            if (!lineItemsToDelete.isEmpty()) {
                delete lineItemsToDelete;
                System.debug('âœ… Deleted ' + lineItemsToDelete.size() + ' LineItems');
            }
            if (!lineItemsToUpsert.isEmpty()) {
                // ServiceQuoteLineItemì—ë„ External ID í•„ë“œê°€ ìˆë‹¤ë©´ upsert ExternalId__c ì‚¬ìš© ê°€ëŠ¥
                // ì—¬ê¸°ì„œëŠ” insert/updateë¥¼ ë¶„ë¦¬í–ˆìœ¼ë¯€ë¡œ upsert List ì‚¬ìš©
                upsert lineItemsToUpsert; // IDê°€ ìˆìœ¼ë©´ update, ì—†ìœ¼ë©´ insert
                System.debug('âœ… Upserted ' + lineItemsToUpsert.size() + ' LineItems');
            }
            System.debug('ğŸ‰ LineItem sync completed.');
        } catch (DmlException e) {
            Database.rollback(sp);
            System.debug('ğŸ’¥ DML Error in syncServiceQuoteLineItems: ' + e.getDmlMessage(0));
            throw e; // Re-throw to be caught by calling method
        }
    }

    /**
     * ê²¬ì ì„œ ë²ˆí˜¸ ìƒì„±
     */
    private static String generateQuoteNumber() {
        Date today = Date.today();
        String dateStr = today.year() +
                String.valueOf(today.month()).leftPad(2, '0') +
                String.valueOf(today.day()).leftPad(2, '0');
        // ë” ê°•ë ¥í•œ ê³ ìœ ì„±ì„ ìœ„í•´ ì‹œê°„ ë° ì„ì˜ì˜ ìˆ«ì ì¡°í•© ê°•í™”
        Long nowTicks = Datetime.now().getTime();
        Integer randomNum = (Integer) (Math.random() * 10000); // ë²”ìœ„ ì¦ê°€
        return 'Q' + dateStr + '-' + String.valueOf(randomNum).leftPad(4, '0') + '-' + String.valueOf(nowTicks).right(4);
    }

    // Wrapper í´ë˜ìŠ¤ë“¤
    public class PartListResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public List<Product2> products { get; set; }
        @AuraEnabled public List<SelectedPartItem__c> selectedParts { get; set; }

        public PartListResult() {
            this.success = false;
            this.products = new List<Product2>();
            this.selectedParts = new List<SelectedPartItem__c>();
        }
    }

    public class SelectedPartData {
        @AuraEnabled public Id riskAnalyzeReportId { get; set; }
        @AuraEnabled public Id productId { get; set; }
        @AuraEnabled public Decimal listPrice { get; set; } // LWCì—ì„œ ì´ ê°’ì„ Product2.Price__c ë˜ëŠ” SelectedPartItem.ListPrice__cì—ì„œ ê°€ì ¸ì˜´
        @AuraEnabled public Decimal quantity { get; set; }
    }

    public class QuoteGenerationResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public Id serviceQuoteId { get; set; }
        @AuraEnabled public Id accountId { get; set; }

        public QuoteGenerationResult() {
            this.success = false;
            this.message = '';
        }
    }

    public class PartSaveResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public List<SelectedPartItem__c> savedRecords { get; set; } // ì €ì¥/ì—…ë°ì´íŠ¸ëœ ë ˆì½”ë“œ ë°˜í™˜

        public PartSaveResult() {
            this.success = false;
            this.message = '';
            this.savedRecords = new List<SelectedPartItem__c>();
        }
    }
}