/**
 * ë””ë²„ê¹…ì„ ìœ„í•´ ë¡œê·¸ë¥¼ ì¶”ê°€í•œ prpt_FindProperPdf í´ë˜ìŠ¤
 */
public class prpt_FindProperPdf {

    public static Id findProperPdf(Id riskAnalyzeReportId) {
        System.debug('=== findProperPdf ì‹œì‘ ===');
        System.debug('riskAnalyzeReportId: ' + riskAnalyzeReportId);

        try {
            // 1. Manual__c ë ˆì½”ë“œ ì¡°íšŒ
            Map<Id, Manual__c> mapManual = new Map<Id, Manual__c>([SELECT Id FROM Manual__c]);
            System.debug('Manual__c ë ˆì½”ë“œ ìˆ˜: ' + mapManual.size());
            System.debug('Manual__c IDs: ' + mapManual.keySet());

            if (mapManual.isEmpty()) {
                System.debug('ERROR: Manual__c ë ˆì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return null;
            }

            // 2. ContentDocumentLink ì¡°íšŒ
            List<ContentDocumentLink> contentLinks = [
                    SELECT Id, ContentDocumentId, ContentDocument.Title, ContentDocument.FileType
                    FROM ContentDocumentLink
                    WHERE LinkedEntityId IN :mapManual.keySet()
            ];
            System.debug('ì „ì²´ ContentDocumentLink ìˆ˜: ' + contentLinks.size());

            List<ContentDocumentInfo> availablePdfs = new List<ContentDocumentInfo>();
            for (ContentDocumentLink obj : contentLinks) {
                System.debug('íŒŒì¼: ' + obj.ContentDocument.Title + ', íƒ€ì…: ' + obj.ContentDocument.FileType);

                if (obj.ContentDocument.FileType.equalsIgnoreCase('pdf')) {
                    ContentDocumentInfo pdfInfo = new ContentDocumentInfo();
                    pdfInfo.contentDocumentId = obj.ContentDocumentId;
                    pdfInfo.title = obj.ContentDocument.Title;
                    availablePdfs.add(pdfInfo);
                    System.debug('PDF íŒŒì¼ ì¶”ê°€: ' + obj.ContentDocument.Title);
                }
            }

            System.debug('ì‚¬ìš© ê°€ëŠ¥í•œ PDF ìˆ˜: ' + availablePdfs.size());
            if (availablePdfs.isEmpty()) {
                System.debug('ERROR: Manual__cì—ì„œ PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return null;
            }

            // 3. ì œí’ˆì½”ë“œ ì¡°íšŒ
            List<RiskAnalyzeReport__c> riskReports = [
                    SELECT Asset__r.Product2.ProductCode, Asset__r.Name, Asset__r.SerialNumber
                    FROM RiskAnalyzeReport__c
                    WHERE Id = :riskAnalyzeReportId
                    LIMIT 1
            ];

            System.debug('RiskAnalyzeReport ì¡°íšŒ ê²°ê³¼ ìˆ˜: ' + riskReports.size());
            String strProductCode = '';
            if (!riskReports.isEmpty()) {
                strProductCode = riskReports[0].Asset__r.Product2.ProductCode;
                System.debug('ì œí’ˆ ì½”ë“œ: ' + strProductCode);
            } else {
                System.debug('WARNING: RiskAnalyzeReportë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // 4. ActionRecommendation ë°ì´í„° ì¡°íšŒ
            List<ActionRecommendation__c> listActionRec = [
                    SELECT Id, AnalysisSummary__c,
                    (SELECT Id, Detail__c, faultDetailType__c, faultLocation__c,
                            actionIndex__c, actionDescription__c, faultType__c, faultReason__c
                    FROM ActionRecommendationItem__r
                    WHERE isChecked__c = true)
                    FROM ActionRecommendation__c
                    WHERE RiskAnalyzeReport__c = :riskAnalyzeReportId
            ];

            System.debug('ActionRecommendation ì¡°íšŒ ê²°ê³¼ ìˆ˜: ' + listActionRec.size());
            if (listActionRec.isEmpty()) {
                System.debug('WARNING: ActionRecommendationì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // 5. Gemini API ìš”ì²­ ìƒì„± ë° í˜¸ì¶œ
            String systemPrompt = buildSystemPrompt();
            String userPrompt = buildUserPrompt(strProductCode, listActionRec, availablePdfs, riskAnalyzeReportId);

            System.debug('System Prompt ê¸¸ì´: ' + systemPrompt.length());
            System.debug('User Prompt ê¸¸ì´: ' + userPrompt.length());

            Gemini2_5FlashApiController.Gemini2_5Request geminiRequest =
                    new Gemini2_5FlashApiController.Gemini2_5Request(systemPrompt, userPrompt, null);

            geminiRequest.generationConfig.temperature = 0.0;
            geminiRequest.generationConfig.maxOutputTokens = 4096;
            geminiRequest.generationConfig.responseMimeType = 'application/json';
            geminiRequest.generationConfig.responseSchema = getPdfSelectionResponseSchema();

            System.debug('Gemini API í˜¸ì¶œ ì‹œì‘');
            String strResponse = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);
//            System.debug('Gemini API ì‘ë‹µ: ' + strResponse);

            if (String.isBlank(strResponse)) {
                System.debug('ERROR: Gemini API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return null;
            }

            // 6. ì‘ë‹µ ì²˜ë¦¬
            Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(strResponse);
            String selectedContentDocumentId = (String) responseMap.get('selectedContentDocumentId');

            System.debug('ì„ íƒëœ ContentDocument ID: ' + selectedContentDocumentId);

            if (String.isBlank(selectedContentDocumentId)) {
                System.debug('ERROR: ì„ íƒëœ ContentDocument IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return null;
            }

            // 7. ê²€ì¦
            for (ContentDocumentInfo pdfInfo : availablePdfs) {
                if (pdfInfo.contentDocumentId == selectedContentDocumentId) {
                    System.debug('SUCCESS: ìœ íš¨í•œ PDF ì„ íƒë¨ - ' + pdfInfo.title);
                    return Id.valueOf(selectedContentDocumentId);
                }
            }

            System.debug('ERROR: ì„ íƒëœ PDFê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.');
            return null;

        } catch (Exception e) {
            System.debug('ERROR: findProperPdf ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            return null;
        }
    }

    /**
     * ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
     */
    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ LSMtronì˜ ì‚¬ì¶œì„±í˜•ê¸° ì „ë¬¸ ê¸°ìˆ  ì§€ì› AIì…ë‹ˆë‹¤. ' +
                'ì‚¬ì¶œì„±í˜•ê¸°ì˜ êµ¬ì¡°, ì‘ë™ ì›ë¦¬, ê³ ì¥ íŒ¨í„´, ìˆ˜ë¦¬ ë°©ë²•ì— ëŒ€í•œ ê¹Šì€ ì „ë¬¸ ì§€ì‹ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ' +
                'ì œê³µëœ ìœ„í—˜ ë¶„ì„ ê²°ê³¼ì™€ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ì„ ë°”íƒ•ìœ¼ë¡œ, ' +
                'Manual__cì— ìˆëŠ” ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ PDF íŒŒì¼ë“¤ ì¤‘ì—ì„œ ' +
                'í˜„ì¬ ìƒí™©ì— ê°€ì¥ ì í•©í•œ ë§¤ë‰´ì–¼ì„ ì •í™•íˆ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ' +
                'ì œí’ˆ ì½”ë“œ, ê³ ì¥ ìœ í˜•, ìˆ˜ë¦¬ ë‚œì´ë„, ì•ˆì „ì„± ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ' +
                'ìµœì ì˜ ë§¤ë‰´ì–¼ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ' +
                'ì‘ë‹µì€ ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.';
    }

    /**
     * ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ìƒì„±
     */
    private static String buildUserPrompt(String productCode,
            List<ActionRecommendation__c> actionRecommendations,
            List<ContentDocumentInfo> availablePdfs,
            Id riskAnalyzeReportId) {
        String prompt = 'ğŸ”§ **ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ ì„ íƒ ìš”ì²­** ğŸ”§\n\n';

        // ê¸°ë³¸ ì •ë³´
        prompt += 'ğŸ“‹ **[ê¸°ë³¸ ì •ë³´]**\n';
        prompt += 'â€¢ ìœ„í—˜ë¶„ì„ë³´ê³ ì„œ ID: ' + riskAnalyzeReportId + '\n';
        prompt += 'â€¢ ì œí’ˆ ì½”ë“œ: ' + (String.isNotBlank(productCode) ? productCode.escapeXml() : 'N/A') + '\n\n';

        // ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
        prompt += 'âš ï¸ **[ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ ë°ì´í„°]**\n';
        if (actionRecommendations != null && !actionRecommendations.isEmpty()) {
            Integer actionNum = 1;
            for (ActionRecommendation__c action : actionRecommendations) {
                prompt += '--- ê¶Œì¥ì¡°ì¹˜ #' + actionNum + ' ---\n';
                prompt += 'â€¢ ë¶„ì„ ìš”ì•½: ' + (action.AnalysisSummary__c != null ? action.AnalysisSummary__c.escapeXml() : 'N/A') + '\n';
                prompt += '-------------------------\n';
                actionNum++;
            }
        } else {
            prompt += 'ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n';
        }
        prompt += '\n';

        // ì‚¬ìš© ê°€ëŠ¥í•œ PDF ë§¤ë‰´ì–¼ ëª©ë¡
        prompt += 'ğŸ“š **[ì‚¬ìš© ê°€ëŠ¥í•œ ìê°€ìˆ˜ë¦¬ ë§¤ë‰´ì–¼ PDF ëª©ë¡]**\n';
        if (availablePdfs != null && !availablePdfs.isEmpty()) {
            Integer pdfNum = 1;
            for (ContentDocumentInfo pdfInfo : availablePdfs) {
                prompt += '--- PDF #' + pdfNum + ' ---\n';
                prompt += 'â€¢ ContentDocument ID: ' + pdfInfo.contentDocumentId + '\n';
                prompt += 'â€¢ íŒŒì¼ëª…: ' + (pdfInfo.title != null ? pdfInfo.title.escapeXml() : 'N/A') + '\n';
                prompt += '-------------------------\n';
                pdfNum++;
            }
        } else {
            prompt += 'ì‚¬ìš© ê°€ëŠ¥í•œ PDF ë§¤ë‰´ì–¼ì´ ì—†ìŠµë‹ˆë‹¤.\n';
        }
        prompt += '\n';

        // ë¶„ì„ ìš”êµ¬ì‚¬í•­
        prompt += 'âœ… **[ë¶„ì„ ìš”êµ¬ì‚¬í•­]**\n\n';
        prompt += 'ğŸš¨ **ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”!** ğŸš¨\n\n';
        prompt += 'ğŸ“‹ **ì„ íƒ ê¸°ì¤€:**\n';
        prompt += '1. ì œí’ˆ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±\n';
        prompt += '2. ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ê³¼ì˜ ê´€ë ¨ì„±\n';
        prompt += '3. ë§¤ë‰´ì–¼ ì œëª©ì—ì„œ ìœ ì¶”ë˜ëŠ” ì ìš© ë²”ìœ„\n';
        prompt += '4. ì‚¬ì¶œì„±í˜•ê¸°ì˜ í•´ë‹¹ ì‹œìŠ¤í…œ/ë¶€í’ˆê³¼ì˜ ì¼ì¹˜ë„\n';
        prompt += '5. ìê°€ìˆ˜ë¦¬ ê°€ëŠ¥ì„± ë° ì•ˆì „ì„±\n\n';

        prompt += 'ğŸ“Š **ì‘ë‹µ í˜•ì‹:**\n';
        prompt += '```json\n';
        prompt += '{\n';
        prompt += '  "selectedContentDocumentId": "ì‹¤ì œ_ContentDocument_ID",\n';
        prompt += '  "reason": "ì„ íƒ ì´ìœ  ê°„ë‹¨ ì„¤ëª…"\n';
        prompt += '}\n';
        prompt += '```\n\n';

        prompt += 'ğŸ” **ë¶„ì„ ì§€ì¹¨:**\n';
        prompt += 'â€¢ ì œí’ˆ ì½”ë“œì™€ ë§¤ë‰´ì–¼ íŒŒì¼ëª…ì˜ ì¼ì¹˜ë„ í™•ì¸\n';
        prompt += 'â€¢ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ê³¼ ë§¤ë‰´ì–¼ ì œëª©ì˜ ê´€ë ¨ì„± ë¶„ì„\n';
        prompt += 'â€¢ ì‚¬ì¶œì„±í˜•ê¸° ì‹œìŠ¤í…œë³„(ìœ ì••, ì „ê¸°, ê¸°ê³„ ë“±) ë§¤ì¹­ë„ í‰ê°€\n';
        prompt += 'â€¢ ê°€ì¥ ì í•©í•œ í•˜ë‚˜ì˜ ContentDocument IDë§Œ ì„ íƒí•˜ì—¬ ë°˜í™˜\n\n';

        return prompt;
    }

    /**
     * PDF ì„ íƒ ì‘ë‹µì„ ìœ„í•œ JSON ìŠ¤í‚¤ë§ˆ ìƒì„± (ë‹¨ìˆœí™”)
     */
    private static Map<String, Object> getPdfSelectionResponseSchema() {
        return new Map<String, Object>{
                'type' => 'object',
                'properties' => new Map<String, Object>{
                        'selectedContentDocumentId' => new Map<String, Object>{
                                'type' => 'string',
                                'description' => 'ì„ íƒëœ PDFì˜ ContentDocument ID'
                        },
                        'reason' => new Map<String, Object>{
                                'type' => 'string',
                                'description' => 'ì„ íƒ ì´ìœ  (ê°„ë‹¨í•œ ì„¤ëª…)'
                        }
                },
                'required' => new List<String>{'selectedContentDocumentId'}
        };
    }

    /**
     * ContentDocument ì •ë³´ë¥¼ ë‹´ëŠ” ë‚´ë¶€ í´ë˜ìŠ¤
     */
    private class ContentDocumentInfo {
        public Id contentDocumentId;
        public String title;
    }
}