/************************************************************************************
* File Name   	    : ErrorReportController
* Author	  		: Jiae.Tak
* Date				: 2025-06-02
* Tester	  		:
* Target	  		:
* Description 	    : 
* Modification Log
* ===================================================================================
* Ver      Date            Author          Modification
* ===================================================================================
* 1.0      2025-06-02         Jiae.Tak          Create
************************************************************************************/
public with sharing class ErrorReportController {
    @AuraEnabled(Cacheable=true)
    public static Map<String, Object> getInit(String uuid) {
        System.debug('getInit start');
        Map<String, Object> mapReturn = new Map<String, Object>();
        if (String.isBlank(uuid)) return null;

        try {
            RiskAnalyzeReport__c objReport = [
                    SELECT Id, MailContent__c, MailSubject__c, Account__c, Asset__c, Asset__r.Product2Id, Asset__r.ManufactureDate, Asset__r.InstallDate, Asset__r.Product2.Name
                    FROM RiskAnalyzeReport__c
                    WHERE UUID__c =: uuid
                    LIMIT 1
            ];
            // WHERE UUID__c = :uuid AND Account__c = '001Qy0000172T51IAE'
            System.debug('objReport :: ' + JSON.serializePretty(objReport));
            List<Case> listCase = new List<Case>([
                    SELECT Id, AssetId, Subject, Description, Part_Code__c, Part_Name__c, malfuction_type__c
                            , Malfunction_Type_Detail__c, CreatedDate, Fault_Code__c, Manufacturer__c, Price__c
                            , Date_Time_Open__c, Date_Time_Close__c
                    FROM Case
                    WHERE AssetId = :objReport.Asset__c
                    AND CreatedDate = LAST_N_DAYS:365
                    ORDER BY AssetId, CreatedDate DESC
            ]);
            System.debug('listCase :: ' + listCase.size());

            Set<String> setString = new Set<String>();
            for (Case obj : listCase) {
                setString.add(obj.Part_Code__c);
            }

            List<Product2> listProduct = new List<Product2>([
                    SELECT Id, Name, ProductCode, Price__c,  Stock__c, Quantity__c, Replacement_Cycle__c
                    FROM Product2
                    WHERE ProductCode = :setString AND Family = :objReport.Asset__r.Product2.Name
            ]);
            System.debug('listProduct :: ' + listProduct.size());

            List<Alarm_history__c> listAlarmHistories = new List<Alarm_history__c>([
                    SELECT Error_alarm__c
                    FROM Alarm_history__c
                    WHERE Asset__c = :objReport.Asset__c
            ]);
            System.debug('listAlarmHistories :: ' + listAlarmHistories.size());

            Set<Id> setErrorAlarmId = new Set<Id>();
            for (Alarm_history__c obj : listAlarmHistories) {
                setErrorAlarmId.add(obj.Error_alarm__c);
            }

            List<Error_alarm__c> listErrorAlarm = new List<Error_alarm__c>([
                    SELECT Id, Code_L__c, Code_M__c, Code_Name_L__c, Code_Name_M__c, Alarm_Ex__c,
                            Occurrence__c, Expectation_1st__c, Expectation_2nd__c, Expectation_3rd__c,
                            Message__c, Reason_1__c, Reason_2__c, Reason_3__c
                    FROM Error_alarm__c
                    WHERE Id = :setErrorAlarmId
            ]);
            System.debug('listErrorAlarm :: ' + listErrorAlarm.size());

            String strSystemPrompt = buildSystemPrompt();
            String strUserPrompt = buildUserPrompt(objReport, listProduct, listCase, listErrorAlarm);

            Gemini2_5FlashApiController.Gemini2_5Request geminiRequest = new Gemini2_5FlashApiController.Gemini2_5Request(strSystemPrompt, strUserPrompt, null);
            geminiRequest.generationConfig.temperature = 0.0;
            geminiRequest.generationConfig.maxOutputTokens = 60000;
            geminiRequest.generationConfig.responseMimeType = 'application/json';
            geminiRequest.generationConfig.responseSchema = getErrorReportResponseSchema();
            String strResponse = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);

            if (String.isNotBlank(strResponse)) {
                mapReturn = processGeminiResponse(strResponse);
                System.debug('strResponse : ' + JSON.serializePretty(strResponse));
            } else {
                mapReturn.put('hasPredictions', false);
                mapReturn.put('message', 'Gemini APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                System.debug(LoggingLevel.WARN, 'Gemini API received no valid response.');
            }
        }catch (Exception e){
            System.debug(LoggingLevel.ERROR, 'Error in getInit: ' + e.getMessage() + '\nStack Trace: ' + e.getStackTraceString());
            mapReturn.put('hasPredictions', false);
            mapReturn.put('message', 'ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }

        System.debug('getInit end. Returning map: ' + JSON.serializePretty(mapReturn));
        return mapReturn;
    }

    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ ì‚°ì—…ìš© ì‚¬ì¶œì„±í˜•ê¸°ì˜ ê³ ì¥ ë° ìœ„í—˜ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ' +
                'ì‚¬ì¶œì„±í˜•ê¸°ì˜ êµ¬ì¡°, ì‘ë™ ì›ë¦¬, ì¼ë°˜ì ì¸ ê³ ì¥ íŒ¨í„´ì— ëŒ€í•œ ê¹Šì€ ì§€ì‹ì„ ë³´ìœ í•˜ê³  ìˆìœ¼ë©°, ' +
                'Error Alarm ë°ì´í„°ì™€ Case ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í–¥í›„ 1-2ê°œì›” ë‚´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ' +
                'ê¸°ê³„ì  ê³ ì¥, ì„±ëŠ¥ ì €í•˜, ë¶€í’ˆ ë§ˆëª¨ ë“±ì˜ ìœ„í—˜ì„ ì •í™•íˆ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ' +
                'ë°ì´í„° íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¼ë³¸ ì›ì¸ì„ íŒŒì•…í•˜ê³ , ì˜ˆë°© ì •ë¹„ ë°©ì•ˆì„ ì œì‹œí•˜ë©°, ' +
                'ë¹„ìš© íš¨ê³¼ì ì¸ í•´ê²°ì±…ì„ ë„ì¶œí•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ì…ë‹ˆë‹¤. ' +
                'ê³ ê°ì—ê²ŒëŠ” LSMtronì˜ ìœ„í—˜ ë¶„ì„ ì „ë¬¸ Agentë¼ëŠ” ë¸Œëœë“œ ì´ë¯¸ì§€ë¡œ ì†Œê°œë˜ì§€ë§Œ, ' +
                'ì‹¤ì œë¡œëŠ” ì‚¬ì¶œì„±í˜•ê¸° ë¶„ì•¼ì˜ ê¹Šì€ ê¸°ìˆ ì  ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ' +
                'ì‘ë‹µì€ ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.';
    }
    private static String buildUserPrompt(
            RiskAnalyzeReport__c objReport,
            List<Product2> listProduct,
            List<Case> listCase,
            List<Error_alarm__c> listErrorAlarm
    ) {

        String prompt = 'ğŸ” **ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­** ğŸ”\n\n';
        prompt += 'ğŸ­ **[ASSET ì •ë³´: ' + objReport.Asset__c + ']**\n';
        prompt += 'â€¢ Asset ì œì¡°ì¼ì: ' + (objReport.Asset__r.ManufactureDate != null ? objReport.Asset__r.ManufactureDate.format() : 'N/A') + '\n';
        prompt += 'â€¢ Asset ì„¤ì¹˜ì¼ì: ' + (objReport.Asset__r.InstallDate != null ? objReport.Asset__r.InstallDate.format() : 'N/A') + '\n\n';

        prompt += 'ğŸ­ **[ë©”ì¼ ì •ë³´]**\n';
        prompt += 'â€¢ ë©”ì¼ ì œëª©: ' + (objReport.MailSubject__c != null ? objReport.MailSubject__c : 'N/A') + '\n';
        prompt += 'â€¢ ë©”ì¼ ì„¸ë¶€ë‚´ìš©: ' + (objReport.MailContent__c != null ? objReport.MailContent__c : 'N/A') + '\n\n';

        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì‹œì‘]**\n';
        Integer caseNum = 1;
        for (Case c : listCase) {
            prompt += '--- Case #' + caseNum + ' ---\n';
            prompt += 'â€¢ ì œëª©: ' + c.Subject + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + c.Description + '\n';
            prompt += 'â€¢ ê³ ì¥ìœ í˜•: ' + (c.malfuction_type__c != null ? c.malfuction_type__c : 'N/A') + '\n';
            prompt += 'â€¢ ê³ ì¥ìƒì„¸: ' + (c.Malfunction_Type_Detail__c != null ? c.Malfunction_Type_Detail__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (c.Part_Code__c != null ? c.Part_Code__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (c.Part_Name__c != null ? c.Part_Name__c : 'N/A') + '\n';
            prompt += 'â€¢ ìƒì„±ì¼: ' + (c.Date_Time_Open__c != null ? String.valueOf(c.Date_Time_Open__c) : 'N/A') + '\n';
            prompt += 'â€¢ ì¢…ë£Œì¼: ' + (c.Date_Time_Close__c != null ? String.valueOf(c.Date_Time_Close__c) : 'N/A') + '\n';

            prompt += '-------------------------\n';
            caseNum++;
        }
        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì‹œì‘]**\n';
        Integer alarmNum = 1;
        for (Error_alarm__c alarm : listErrorAlarm) {
            prompt += '--- Alarm #' + alarmNum + ' ---\n';
            prompt += 'â€¢ ì½”ë“œ: ' + alarm.Code_L__c + '-' + alarm.Code_M__c + '\n';
            prompt += 'â€¢ ì•ŒëŒëª…: ' + (alarm.Code_Name_M__c != null ? alarm.Code_Name_M__c : 'N/A') + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + (alarm.Alarm_Ex__c != null ? alarm.Alarm_Ex__c : 'N/A') + '\n';
            prompt += 'â€¢ ë°œìƒíšŸìˆ˜: ' + (alarm.Occurrence__c != null ? alarm.Occurrence__c : 0) + '\n';
            prompt += 'â€¢ ì›ì¸1: ' + (alarm.Reason_1__c != null ? alarm.Reason_1__c : 'N/A') + '\n';
            prompt += 'â€¢ ì›ì¸2: ' + (alarm.Reason_2__c != null ? alarm.Reason_2__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼1: ' + (alarm.Expectation_1st__c != null ? alarm.Expectation_1st__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼2: ' + (alarm.Expectation_2nd__c != null ? alarm.Expectation_2nd__c : 'N/A') + '\n';
            prompt += 'â€¢ ë©”ì‹œì§€: ' + (alarm.Message__c != null ? alarm.Message__c : 'N/A') + '\n';
//            prompt += 'â€¢ ìƒì„±ì¼: ' + alarm.CreatedDate + '\n';
            prompt += '-------------------------\n';
            alarmNum++;
        }
        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[Product ë°ì´í„° ì‹œì‘]**\n';
        Integer productNum = 1;
        for (Product2 objProduct: listProduct) {
            prompt += '--- objProduct #' + productNum + ' ---\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (objProduct.Name != null ? objProduct.Name : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (objProduct.ProductCode != null ? objProduct.ProductCode : 'N/A') + '\n';
            prompt += 'â€¢ ê°€ê²©: ' + (objProduct.Price__c != null ? objProduct.Price__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ì—¬ë¶€: ' + (objProduct.Stock__c != null ? objProduct.Stock__c : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ìˆ˜: ' + (objProduct.Quantity__c != null ? objProduct.Quantity__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ êµì²´ì£¼ê¸°: ' + (objProduct.Replacement_Cycle__c != null ? objProduct.Replacement_Cycle__c : 'N/A') + '\n';
            prompt += '-------------------------\n';
            productNum++;
        }
        prompt += 'âš ï¸ **[Product ë°ì´í„° ì¢…ë£Œ]**\n\n';
        prompt += 'ğŸ”š **[ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­ ì™„ë£Œ]**\n';
        prompt += '==========================================\n\n';

        prompt += 'âœ… **[ë¶„ì„ ìš”êµ¬ì‚¬í•­]**\n\n';
        prompt += 'ğŸ“§ **1. ì˜ˆì¸¡ ì—ëŸ¬ì¦ìƒ ë¦¬ìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­:**\n';
        prompt += '     - **riskItems (Array of Objects):** ì˜ˆì¸¡ëœ ê° ìœ„í—˜ í•­ëª©ì„ ë‚˜íƒ€ë‚´ëŠ” ë°°ì—´\n';
        prompt += '     - **faultSeverityLevel (String):** ê³ ì¥ ì‹¬ê°ë„ ìˆ˜ì¤€ (ì˜ˆ: "ë§¤ìš° ë†’ìŒ", "ë†’ìŒ", "ë³´í†µ", "ë‚®ìŒ").\n';
        prompt += '     - **expectedFaultDate (String):** ê³ ì¥ ì˜ˆì¸¡ì¼ (YYYY-MM-DD í˜•ì‹).\n';
        prompt += '     - **componentName (String):** ê´€ë ¨ ë¶€í’ˆëª… (ì˜ˆ: Product2 ì˜ ProductCode )\n';
        prompt += '     - **componentLifeExpectancy (String):** ë¶€í’ˆ ìˆ˜ëª… (ì˜ˆ: "ì”ì—¬ ìˆ˜ëª… 3ê°œì›”", "êµì²´ ì£¼ê¸° ë„ë˜").\n';
        prompt += '     - **usageAnalysis (String):** ì‚¬ìš©ëŸ‰ ë¶„ì„ (ì˜ˆ: "ê³¼ë„í•œ ì‚¬ì´í´ ì‚¬ìš©", "ì •ìƒ ë²”ìœ„ ë‚´ ì‚¬ìš©").\n';
        prompt += '     - **faultHistorySummary (String):** ê³ ì¥ ì´ë ¥ ë¶„ì„ ìš”ì•½ (ê´€ë ¨ ê³¼ê±° Case ë° Alarm ë°ì´í„° ê¸°ë°˜).\n';
        prompt += '     - **recommendedAction (String):** í•´ë‹¹ ìœ„í—˜ì— ëŒ€í•œ ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­ (ì˜ˆ: "ì ê²€ í•„ìš”", "ë¶€í’ˆ êµì²´ ê¶Œì¥", "ì„¤ì • ì¡°ì •").\n';
        prompt += '     - **riskReason (String):** ì˜ˆì¸¡ëœ ìœ„í—˜ì˜ ì£¼ìš” ì›ì¸ ìš”ì•½.\n';
        prompt += '     - **impactDescription (String):** ê³ ì¥ ë°œìƒ ì‹œ ì˜ˆìƒë˜ëŠ” ì˜í–¥ (ì˜ˆ: "ìƒì‚° ì§€ì—° 2ì¼ ì˜ˆìƒ", "ìˆ˜ë¦¬ ë¹„ìš© ì•½ 500ë§Œì› ë°œìƒ").\n\n';
        prompt += '     - **selfRepairCost (Number):** í•´ë‹¹ ê³ ì¥ ë°œìƒ ì‹œ **ìê°€ ìˆ˜ë¦¬**ë¡œ ì§„í–‰í•  ê²½ìš° ì˜ˆìƒë˜ëŠ” ì´ ë¹„ìš© (ë‹¨ìœ„: ì›). ìê°€ ìˆ˜ë¦¬ê°€ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¼ ê²½ìš° 0ìœ¼ë¡œ í‘œê¸°í•©ë‹ˆë‹¤.\n';
        prompt += '     - **externalRepairCost (Number):** í•´ë‹¹ ê³ ì¥ ë°œìƒ ì‹œ **ì™¸ë¶€ ì—…ì²´ ìˆ˜ë¦¬**ë¡œ ì§„í–‰í•  ê²½ìš° ì˜ˆìƒë˜ëŠ” ì´ ë¹„ìš© (ë‹¨ìœ„: ì›). ì™¸ë¶€ ìˆ˜ë¦¬ê°€ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¼ ê²½ìš° 0ìœ¼ë¡œ í‘œê¸°í•©ë‹ˆë‹¤.\n';
        prompt += '     - **costComparisonMessage (String):** ìê°€ ìˆ˜ë¦¬ ë¹„ìš©ê³¼ ì™¸ë¶€ ìˆ˜ë¦¬ ë¹„ìš©ì„ ë¹„êµí•˜ì—¬ ìê°€ ìˆ˜ë¦¬ì˜ ì´ì ì„ ê°•ì¡°í•˜ëŠ” ë©”ì‹œì§€. (ì˜ˆ: "ìê°€ ìˆ˜ë¦¬ ì‹œ ì•½ 30% ë¹„ìš© ì ˆê° ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.", "ì™¸ë¶€ ìˆ˜ë¦¬ ëŒ€ë¹„ ì•½ 20ë§Œì› ì ˆì•½ë©ë‹ˆë‹¤.")\n\n';

        prompt += 'ğŸ¯ **[ì£¼ìš” ì§€ì¹¨]**\n';
        prompt += 'â€¢ ì œê³µëœ Error Alarm ë° Case ë°ì´í„°ë¥¼ ë©´ë°€íˆ ë¶„ì„í•˜ì—¬ ì˜ˆì¸¡ë˜ëŠ” ê³ ì¥ ì¦ìƒë“¤ì„ ë„ì¶œí•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ê° ì˜ˆì¸¡ ì—ëŸ¬ ì¦ìƒì— ëŒ€í•´ ìš”êµ¬ëœ í•­ëª©ë“¤ì„ ìƒì„¸í•˜ê²Œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ì˜ˆì¸¡ì€ í–¥í›„ 1-2ê°œì›” ë‚´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìœ„í—˜ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ë¶„ì„ ê²°ê³¼ëŠ” ì‹¤ì§ˆì ì¸ ìœ ì§€ë³´ìˆ˜ ê³„íš ìˆ˜ë¦½ì— ë„ì›€ì´ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ **ê°€ì¥ ì¤‘ìš”í•œ ì§€ì¹¨: ìê°€ ìˆ˜ë¦¬ ë¹„ìš© (selfRepairCost)ê³¼ ì™¸ë¶€ ìˆ˜ë¦¬ ë¹„ìš© (externalRepairCost)ì„ ë°˜ë“œì‹œ êµ¬ë¶„í•˜ì—¬ ì˜ˆì¸¡í•˜ê³ , ë‘˜ ì¤‘ ìê°€ ìˆ˜ë¦¬ê°€ ë” ì €ë ´í•œ ê²½ìš° costComparisonMessageë¥¼ í†µí•´ ê·¸ ì´ì ì„ ëª…í™•íˆ ê°•ì¡°í•©ë‹ˆë‹¤.**\n';
        prompt += 'â€¢ í•´ë‹¹ ë°ì´í„° ëª©ì ì€ ê³ ì¥ ìœ„í—˜ì„ ì•Œë¦¬ê³  ìê°€ìˆ˜ë¦¬ë¥¼ ìœ ë„í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. \n';
        prompt += 'â€¢ ìê°€ìˆ˜ë¦¬, ì™¸ë¶€ìˆ˜ë¦¬ ê°€ê²© ë¹„êµë¥¼ í†µí•´ ìê°€ìˆ˜ë¦¬ê°€ ê°€ì„±ë¹„ ìˆëŠ” í–‰ë™ì´ë¼ëŠ” ê²ƒì„ ì•Œë¦¬ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. \n';
        prompt += 'â€¢ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n\n';

        prompt += 'â­ ì‘ë‹µ í˜•ì‹:** {"errorReportResults": {"riskItems": [...]}}';

        return prompt;
    }

    private static Map<String, Object> getErrorReportResponseSchema() {
        return new Map<String, Object>{
                'type' => 'object',
                'properties' => new Map<String, Object>{
                        'errorReportResults' => new Map<String, Object>{
                                'type' => 'object',
                                'properties' => new Map<String, Object>{
                                        'riskItems' => new Map<String, Object>{
                                                'type' => 'array',
                                                'items' => new Map<String, Object>{
                                                        'type' => 'object',
                                                        'properties' => new Map<String, Object>{
                                                                'faultSeverityLevel' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ì‹¬ê°ë„ ìˆ˜ì¤€'},
                                                                'expectedFaultDate' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ì˜ˆì¸¡ì¼ (YYYY-MM-DD)'},
                                                                'componentName' => new Map<String, Object>{'type' => 'string', 'description' => 'ê´€ë ¨ ë¶€í’ˆëª…'},
                                                                'componentLifeExpectancy' => new Map<String, Object>{'type' => 'string', 'description' => 'ë¶€í’ˆ ìˆ˜ëª…'},
                                                                'usageAnalysis' => new Map<String, Object>{'type' => 'string', 'description' => 'ì‚¬ìš©ëŸ‰ ë¶„ì„'},
                                                                'faultHistorySummary' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ì´ë ¥ ë¶„ì„ ìš”ì•½'},
                                                                'recommendedAction' => new Map<String, Object>{'type' => 'string', 'description' => 'ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­'},
                                                                'riskReason' => new Map<String, Object>{'type' => 'string', 'description' => 'ì˜ˆì¸¡ëœ ìœ„í—˜ì˜ ì£¼ìš” ì›ì¸'},
                                                                'impactDescription' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ë°œìƒ ì‹œ ì˜ˆìƒë˜ëŠ” ì˜í–¥'},
                                                                'selfRepairCost' => new Map<String, Object>{'type' => 'number', 'description' => 'ìê°€ ìˆ˜ë¦¬ ì‹œ ì˜ˆìƒ ë¹„ìš© (ì›)'},
                                                                'externalRepairCost' => new Map<String, Object>{'type' => 'number', 'description' => 'ì™¸ë¶€ ìˆ˜ë¦¬ ì‹œ ì˜ˆìƒ ë¹„ìš© (ì›)'},
                                                                'costComparisonMessage' => new Map<String, Object>{'type' => 'string', 'description' => 'ìê°€ ìˆ˜ë¦¬ì™€ ì™¸ë¶€ ìˆ˜ë¦¬ ë¹„ìš© ë¹„êµ ë©”ì‹œì§€'}
                                                        },
                                                        'required' => new List<String>{
                                                                'faultSeverityLevel',
                                                                'expectedFaultDate',
                                                                'componentName',
                                                                'componentLifeExpectancy',
                                                                'usageAnalysis',
                                                                'faultHistorySummary',
                                                                'recommendedAction',
                                                                'riskReason',
                                                                'impactDescription',
                                                                'selfRepairCost',
                                                                'externalRepairCost',
                                                                'costComparisonMessage'
                                                        }
                                                }
                                        }
                                },
                                'required' => new List<String>{'riskItems'}
                        }
                },
                'required' => new List<String>{'errorReportResults'}
        };
    }

    private static Map<String, Object> processGeminiResponse(String jsonResponse) {
        Map<String, Object> returnMap = new Map<String, Object>();
        returnMap.put('hasPredictions', false); // Default to no predictions

        try {
            Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(jsonResponse);

            Map<String, Object> errorReportResults = (Map<String, Object>) responseMap.get('errorReportResults');

            if (errorReportResults == null || errorReportResults.isEmpty()) {
                returnMap.put('message', 'No errorReportResults found in Gemini response.');
                System.debug('No errorReportResults found in response.');
                return returnMap;
            }

            List<Object> riskItems = (List<Object>) errorReportResults.get('riskItems');

            if (riskItems == null || riskItems.isEmpty()) {
                returnMap.put('message', 'No riskItems found in errorReportResults.');
                return returnMap;
            }

            List<Map<String, String>> displayRiskItems = new List<Map<String, String>>();

            for (Object riskItemObj : riskItems) {
                Map<String, Object> riskItem = (Map<String, Object>) riskItemObj;

                Map<String, String> itemToDisplay = new Map<String, String>();
                // Safely get string values for display, handling potential nulls
                itemToDisplay.put('faultSeverityLevel', String.valueOf(riskItem.get('faultSeverityLevel')));
                itemToDisplay.put('expectedFaultDate', String.valueOf(riskItem.get('expectedFaultDate')));
                itemToDisplay.put('componentName', String.valueOf(riskItem.get('componentName')));
                itemToDisplay.put('componentLifeExpectancy', String.valueOf(riskItem.get('componentLifeExpectancy')));
                itemToDisplay.put('usageAnalysis', String.valueOf(riskItem.get('usageAnalysis')));
                itemToDisplay.put('faultHistorySummary', String.valueOf(riskItem.get('faultHistorySummary')));
                itemToDisplay.put('recommendedAction', String.valueOf(riskItem.get('recommendedAction')));
                itemToDisplay.put('riskReason', String.valueOf(riskItem.get('riskReason')));
                itemToDisplay.put('impactDescription', String.valueOf(riskItem.get('impactDescription')));

                Object selfRepairCostObj = riskItem.get('selfRepairCost');
                if (selfRepairCostObj != null) {
                    itemToDisplay.put('selfRepairCost', String.valueOf(selfRepairCostObj));
                } else {
                    itemToDisplay.put('selfRepairCost', '0');
                }

                Object externalRepairCostObj = riskItem.get('externalRepairCost');
                if (externalRepairCostObj != null) {
                    itemToDisplay.put('externalRepairCost', String.valueOf(externalRepairCostObj));
                } else {
                    itemToDisplay.put('externalRepairCost', '0');
                }

                itemToDisplay.put('costComparisonMessage', String.valueOf(riskItem.get('costComparisonMessage')));

                displayRiskItems.add(itemToDisplay);
            }

            returnMap.put('hasPredictions', true);
            returnMap.put('riskItems', displayRiskItems);
            returnMap.put('message', 'ì„±ê³µì ìœ¼ë¡œ ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');

            System.debug('Total ' + displayRiskItems.size());

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error processing Gemini response for display: ' + e.getMessage() + '\nStack Trace: ' + e.getStackTraceString());
            returnMap.put('message', 'ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }

        System.debug('returnMap : ' + JSON.serializePretty(returnMap));
        return returnMap;
    }
}