/************************************************************************************
* File Name : RiskAnalysisProcessor.cls
* Author : ìµœì¤€ì„
* Date : 2025-06-03
* Description :
* Modification Log
* ===================================================================================
* Ver Date Author Modification
* ===================================================================================
1.0 2025-06-03 ìµœì¤€ì„ Create
*************************************************************************************/

public class RiskAnalysisProcessor {

    public static void processRiskAnalysis(Account account,
            List<Asset> assets,
            Map<Id, List<Case>> mapAssetIdToCases,
            Map<Id, List<Alarm_history__c>> mapAssetIdToAlarmHistories) {

        String generatedUUID = generateUUID();
        String strSystemPrompt = buildSystemPrompt();
        String strUserPrompt = buildUserPrompt(account, assets, mapAssetIdToCases, mapAssetIdToAlarmHistories, generatedUUID);

        System.debug(LoggingLevel.DEBUG, '=== SYSTEM PROMPT START ===');
        System.debug(LoggingLevel.DEBUG, strSystemPrompt);
        System.debug(LoggingLevel.DEBUG, '=== SYSTEM PROMPT END ===');
        System.debug(LoggingLevel.DEBUG, '=== USER PROMPT START ===');
        System.debug(LoggingLevel.DEBUG, strUserPrompt);
        System.debug(LoggingLevel.DEBUG, '=== USER PROMPT END ===');
        System.debug(LoggingLevel.DEBUG, 'Generated UUID: ' + generatedUUID);
        System.debug(LoggingLevel.DEBUG, 'Total System Prompt Length: ' + strSystemPrompt.length() + ' characters');
        System.debug(LoggingLevel.DEBUG, 'Total User Prompt Length: ' + strUserPrompt.length() + ' characters');

        try {
            Gemini2_5FlashApiController.Gemini2_5Request geminiRequest = new Gemini2_5FlashApiController.Gemini2_5Request(strSystemPrompt, strUserPrompt, null);
            geminiRequest.generationConfig.temperature = 0.0;
            geminiRequest.generationConfig.maxOutputTokens = 8192;
            geminiRequest.generationConfig.responseMimeType = 'application/json';
            geminiRequest.generationConfig.responseSchema = getRiskAnalyzeResponseSchema();

            String strResponse = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);

            if (String.isNotBlank(strResponse)) {
                System.debug(LoggingLevel.DEBUG, 'Gemini API ì‘ë‹µ ìˆ˜ì‹  (Account ID: ' + account.Id + '): ' + strResponse.left(Math.min(strResponse.length(), 500)) + '...');
                processGeminiResponse(strResponse, account.Id, generatedUUID);
            } else {
                System.debug(LoggingLevel.WARN, 'Gemini APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (Account ID: ' + account.Id + ').');
            }
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Gemini API í˜¸ì¶œ ë˜ëŠ” ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (Account ID: ' + account.Id + '): ' + e.getMessage() + '\nStackTrace: ' + e.getStackTraceString());
        }
    }

    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ ì‚°ì—…ìš© ì‚¬ì¶œì„±í˜•ê¸°ì˜ ê³ ì¥ ë° ìœ„í—˜ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ' +
                'ì‚¬ì¶œì„±í˜•ê¸°ì˜ êµ¬ì¡°, ì‘ë™ ì›ë¦¬, ì¼ë°˜ì ì¸ ê³ ì¥ íŒ¨í„´ì— ëŒ€í•œ ê¹Šì€ ì§€ì‹ì„ ë³´ìœ í•˜ê³  ìˆìœ¼ë©°, ' +
                'Alarm History ë°ì´í„°ì™€ Case ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í–¥í›„ 1-2ê°œì›” ë‚´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ' +
                'ê¸°ê³„ì  ê³ ì¥, ì„±ëŠ¥ ì €í•˜, ë¶€í’ˆ ë§ˆëª¨ ë“±ì˜ ìœ„í—˜ì„ ì •í™•íˆ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ' +
                'ë°ì´í„° íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¼ë³¸ ì›ì¸ì„ íŒŒì•…í•˜ê³ , ì˜ˆë°© ì •ë¹„ ë°©ì•ˆì„ ì œì‹œí•˜ë©°, ' +
                'ë¹„ìš© íš¨ê³¼ì ì¸ í•´ê²°ì±…ì„ ë„ì¶œí•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ì…ë‹ˆë‹¤. ' +
                'ê³ ê°ì—ê²ŒëŠ” LSMtronì˜ ìœ„í—˜ ë¶„ì„ ì „ë¬¸ Agentë¼ëŠ” ë¸Œëœë“œ ì´ë¯¸ì§€ë¡œ ì†Œê°œë˜ì§€ë§Œ, ' +
                'ì‹¤ì œë¡œëŠ” ì‚¬ì¶œì„±í˜•ê¸° ë¶„ì•¼ì˜ ê¹Šì€ ê¸°ìˆ ì  ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ' +
                'ì‘ë‹µì€ ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.';
    }

    private static String buildUserPrompt(Account account,
            List<Asset> assets,
            Map<Id, List<Case>> mapAssetIdToCases,
            Map<Id, List<Alarm_history__c>> mapAssetIdToAlarmHistories,
            String uuid) {
        String prompt = 'ğŸ” **ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­** ğŸ”\n\n';
        prompt += 'ğŸ“‹ **[ACCOUNT ì •ë³´]**\n';
        prompt += 'â€¢ ê³„ì • ID: ' + account.Id + '\n';
        prompt += 'â€¢ ê³„ì •ëª…: ' + (account.Name != null ? account.Name.escapeXml() : 'N/A') + '\n'; // ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ ìˆ˜ì •
        prompt += 'â€¢ ë¶„ì„ UUID: ' + uuid + '\n\n';
        prompt += '==========================================\n\n';
        prompt += buildAssetDataSection(assets, mapAssetIdToCases, mapAssetIdToAlarmHistories);
        prompt += buildAnalysisRequirements(account.Id, uuid);
        return prompt;
    }

    private static String buildAssetDataSection(List<Asset> assets,
            Map<Id, List<Case>> mapAssetIdToCases,
            Map<Id, List<Alarm_history__c>> mapAssetIdToAlarmHistories) {
        String prompt = '';
        for (Asset asset : assets) {
            prompt += 'ğŸ­ **[ASSET ì •ë³´: ' + asset.Id + ']**\n';
            prompt += 'â€¢ Assetëª…: ' + (asset.Name != null ? asset.Name.escapeXml() : 'N/A') + '\n'; // ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ ìˆ˜ì •
            prompt += 'â€¢ ì‹œë¦¬ì–¼ë²ˆí˜¸: ' + (asset.SerialNumber != null ? asset.SerialNumber.escapeXml() : 'N/A') + '\n\n'; // ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ ìˆ˜ì •
            prompt += buildCaseDataSection(asset.Id, mapAssetIdToCases);
            prompt += buildAlarmHistoryDataSection(asset.Id, mapAssetIdToAlarmHistories);
            prompt += 'ğŸ”š **[ASSET ' + asset.Id + ' ë°ì´í„° ì™„ë£Œ]**\n';
            prompt += '==========================================\n\n';
        }
        return prompt;
    }

    private static String buildCaseDataSection(Id assetId, Map<Id, List<Case>> mapAssetIdToCases) {
        String prompt = '';
        List<Case> assetCases = mapAssetIdToCases.get(assetId);
        if (assetCases != null && !assetCases.isEmpty()) {
            prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì‹œì‘]**\n';
            Integer caseNum = 1;
            for (Case c : assetCases) {
                prompt += '--- Case #' + caseNum + ' ---\n';
                prompt += 'â€¢ ì œëª©: ' + (c.Subject != null ? c.Subject.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì„¤ëª…: ' + (c.Description != null ? c.Description.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ê³ ì¥ìœ í˜•: ' + (c.malfuction_type__c != null ? c.malfuction_type__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ê³ ì¥ìƒì„¸: ' + (c.Malfunction_Type_Detail__c != null ? c.Malfunction_Type_Detail__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (c.Part_Code__c != null ? c.Part_Code__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ë¶€í’ˆëª…: ' + (c.Part_Name__c != null ? c.Part_Name__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ìƒì„±ì¼: ' + c.CreatedDate + '\n';
                prompt += '-------------------------\n';
                caseNum++;
            }
            prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì¢…ë£Œ]**\n\n';
        }
        return prompt;
    }

    private static String buildAlarmHistoryDataSection(Id assetId, Map<Id, List<Alarm_history__c>> mapAssetIdToAlarmHistories) {
        String prompt = '';
        List<Alarm_history__c> assetAlarmHistories = mapAssetIdToAlarmHistories.get(assetId);
        if (assetAlarmHistories != null && !assetAlarmHistories.isEmpty()) {
            prompt += 'âš ï¸ **[ALARM HISTORY ë°ì´í„° ì‹œì‘]**\n';
            Integer alarmNum = 1;
            for (Alarm_history__c alarm : assetAlarmHistories) {
                prompt += '--- Alarm History #' + alarmNum + ' ---\n';
                prompt += 'â€¢ ID: ' + alarm.Id + '\n';
                prompt += 'â€¢ ì´ë¦„: ' + (alarm.Name != null ? alarm.Name.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ëŒ€ë¶„ë¥˜ ì½”ë“œ: ' + (alarm.Code_L__c != null ? alarm.Code_L__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì¤‘ë¶„ë¥˜ ì½”ë“œ: ' + (alarm.Code_M__c != null ? alarm.Code_M__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ëŒ€ë¶„ë¥˜ëª…: ' + (alarm.Code_Name_L__c != null ? alarm.Code_Name_L__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì¤‘ë¶„ë¥˜ëª…: ' + (alarm.Code_Name_M__c != null ? alarm.Code_Name_M__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì•ŒëŒ ì„¤ëª…: ' + (alarm.Alarm_Ex__c != null ? alarm.Alarm_Ex__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì‹œë¦¬ì–¼ë²ˆí˜¸: ' + (alarm.SerialNumber__c != null ? alarm.SerialNumber__c.escapeXml() : 'N/A') + '\n';
                prompt += 'â€¢ ì œí’ˆì •ë³´: ' + (alarm.Product__c != null ? alarm.Product__c.escapeXml() : 'N/A') + '\n';
                if (alarm.InstallDate__c != null) prompt += 'â€¢ ì„¤ì¹˜ì¼: ' + alarm.InstallDate__c + '\n';
                if (alarm.ManufactureDate__c != null) prompt += 'â€¢ ì œì¡°ì¼: ' + alarm.ManufactureDate__c + '\n';
                if (alarm.Customer_Warranty_Start_Date__c != null && alarm.Customer_Warranty_End_Date__c != null) {
                    prompt += 'â€¢ ë³´ì¦ê¸°ê°„: ' + alarm.Customer_Warranty_Start_Date__c + ' ~ ' + alarm.Customer_Warranty_End_Date__c + '\n';
                }
                prompt += 'â€¢ ìƒì„±ì¼: ' + alarm.CreatedDate + '\n';
                prompt += '-------------------------\n';
                alarmNum++;
            }
            prompt += 'âš ï¸ **[ALARM HISTORY ë°ì´í„° ì¢…ë£Œ]**\n\n';
        }
        return prompt;
    }

    // 1. buildAnalysisRequirements ë©”ì„œë“œì—ì„œ riskTrendData ê´€ë ¨ ë¶€ë¶„ ì œê±°
    private static String buildAnalysisRequirements(String accountId, String uuid) {
        String prompt = 'âœ… **[ë¶„ì„ ìš”êµ¬ì‚¬í•­ - ë§¤ìš° ì¤‘ìš”!]**\n\n';
        prompt += 'ğŸš¨ **ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”!** ğŸš¨\n\n';
        prompt += 'ğŸ“§ **1. MailContent__c ìš”êµ¬ì‚¬í•­:**\n';
        prompt += 'â€¢ mailSubject: ê°„ê²°í•˜ê³  ê¸´ê¸‰ì„±ì´ ëŠê»´ì§€ëŠ” ë©”ì¼ ì œëª©\n';
        prompt += 'â€¢ greeting: LSMtron Agent ì†Œê°œë¥¼ í¬í•¨í•œ ì •ì¤‘í•œ ì¸ì‚¬ë§\n';
        prompt += 'â€¢ riskSummary: ë°œê²¬ëœ í•µì‹¬ ìœ„í—˜ ìš”ì†Œ 2-3ê°œë¥¼ ëª…í™•í•˜ê²Œ ìš”ì•½\n';
        prompt += 'â€¢ riskLevel: ìœ„í—˜ë„ (ë‚®ìŒ/ë³´í†µ/ë†’ìŒ/ë§¤ìš°ë†’ìŒ)\n';
        prompt += 'â€¢ expectedTimeframe: êµ¬ì²´ì ì¸ ì˜ˆìƒ ë°œìƒ ì‹œê¸°\n';
        prompt += 'â€¢ urgencyMessage: ì¦‰ì‹œ ì¡°ì¹˜ê°€ í•„ìš”í•œ ì´ìœ ë¥¼ ê°•ì¡°\n';
        // riskTrendData ë¼ì¸ ì œê±°ë¨
        prompt += 'â€¢ callToAction: ìƒì„¸ ë³´ê³ ì„œ í™•ì¸ ìœ ë„ ë¬¸êµ¬\n';
        prompt += 'â€¢ closingMessage: ì „ë¬¸ì ì¸ ë§ˆë¬´ë¦¬ ì¸ì‚¬\n\n';

        prompt += 'ğŸ“Š **2. Detail__c ìš”êµ¬ì‚¬í•­ (í•µì‹¬ ë‚´ìš©ë§Œ í¬í•¨):**\n';
        prompt += 'â€¢ detailTitle: ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ ì œëª©\n';
        prompt += 'â€¢ riskOverview: ì „ì²´ ìœ„í—˜ ìƒí™© ê°œìš” (1-2ë¬¸ë‹¨)\n';
        prompt += 'â€¢ technicalFindings: êµ¬ì²´ì ì¸ ê¸°ìˆ ì  ë¬¸ì œì ê³¼ ë°ì´í„°\n';
        prompt += 'â€¢ rootCauseAnalysis: ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸\n';
        prompt += 'â€¢ impactAssessment: ìƒì‚°ì„±ê³¼ ë¹„ìš©ì— ë¯¸ì¹˜ëŠ” ì˜í–¥\n';
        prompt += 'â€¢ riskTrendData: ìœ„í—˜ë„ ì¶”ì´ ë°ì´í„° (í˜„ì¬, 1ê°œì›”í›„, 2ê°œì›”í›„ ìœ„í—˜ë„ ì ìˆ˜ 0-100)\n';
        prompt += 'â€¢ componentStatusData: ë¶€í’ˆë³„ ìƒíƒœ ë°ì´í„° [{"name":"ìœ ì••ì‹œìŠ¤í…œ","status":85},{"name":"í´ë¨í•‘ìœ ë‹›","status":60}...]\n';
        prompt += 'â€¢ failureCostData: ê³ ì¥ ìœ í˜•ë³„ ë¹„ìš© ë°ì´í„° [{"type":"ìœ ì••ê³„í†µ","cost":3500,"percentage":35}...]\n';
        prompt += 'â€¢ maintenanceCostData: ìˆ˜ë¦¬ ë°©ì‹ë³„ ë¹„ìš© ë°ì´í„° [{"type":"ìœ ì••","selfRepair":1200,"outsideRepair":2800}...]\n';
        prompt += 'â€¢ costAnalysis: ê¸°íšŒë¹„ìš© ë° ì˜ˆë°© ì •ë¹„ vs ê³ ì¥ ìˆ˜ë¦¬ ë¹„ìš© ë¹„êµ\n';
        prompt += 'â€¢ emergencyActions: ì¦‰ì‹œ ì·¨í•´ì•¼ í•  ì¡°ì¹˜ì‚¬í•­\n\n';

        prompt += 'ğŸ“ **3. SelfCheckItem__c ìš”êµ¬ì‚¬í•­:**\n';
        prompt += 'â€¢ ì‘ì—…ìê°€ í˜„ì¥ì—ì„œ YES/NOë¡œ í™•ì¸ ê°€ëŠ¥í•œ ê´€ì°° í•­ëª©\n';
        prompt += 'â€¢ Alarm Historyì™€ Case ë°ì´í„° ê¸°ë°˜ ì‹¤ì œ ì¦ìƒ ì²´í¬ë¦¬ìŠ¤íŠ¸\n';
        prompt += 'â€¢ 5-8ê°œ í•­ëª©ìœ¼ë¡œ êµ¬ì„±\n\n';
        prompt += 'ğŸ†” **4. UUID ì‚¬ìš©:** ì œê³µëœ UUID (' + uuid + ')ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©\n\n';
        prompt += buildSvgChartGuide();
        prompt += buildGeneralGuidelines();

        prompt += 'â­ **ì‘ë‹µ í˜•ì‹ (ì´ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¥´ì„¸ìš”!):**\n';
        prompt += '```json\n';
        prompt += '{\n';
        prompt += '  "riskAnalysisResults": [\n';
        prompt += '    {\n';
        prompt += '      "accountId": "' + accountId + '",\n';
        prompt += '      "assetId": "ì‹¤ì œ_Asset_ID",\n';
        prompt += '      "uuid": "' + uuid + '",\n';
        prompt += '      "mailComponents": {\n';
        prompt += '        "mailSubject": "ë©”ì¼ ì œëª©",\n';
        prompt += '        "greeting": "ì¸ì‚¬ë§",\n';
        prompt += '        "riskSummary": "ìœ„í—˜ ìš”ì†Œ ìš”ì•½",\n';
        prompt += '        "riskLevel": "ë†’ìŒ",\n';
        prompt += '        "expectedTimeframe": "2-3ì£¼ ë‚´",\n';
        prompt += '        "urgencyMessage": "ê¸´ê¸‰ ë©”ì‹œì§€",\n';
        // riskTrendData ë¼ì¸ ì œê±°ë¨
        prompt += '        "callToAction": "í–‰ë™ ìœ ë„",\n';
        prompt += '        "closingMessage": "ë§ˆë¬´ë¦¬ ì¸ì‚¬"\n';
        prompt += '      },\n';
        prompt += '      "detailComponents": {\n';
        prompt += '        "detailTitle": "ìƒì„¸ ì œëª©",\n';
        prompt += '        "riskOverview": "ìœ„í—˜ ê°œìš”",\n';
        prompt += '        "technicalFindings": "ê¸°ìˆ ì  ë°œê²¬ì‚¬í•­",\n';
        prompt += '        "rootCauseAnalysis": "ê·¼ë³¸ ì›ì¸",\n';
        prompt += '        "impactAssessment": "ì˜í–¥ë„ í‰ê°€",\n';
        prompt += '        "riskTrendData": {"current": 85, "month1": 75, "month2": 60},\n';
        prompt += '        "componentStatusData": [{"name": "ìœ ì••ì‹œìŠ¤í…œ", "status": 85}, {"name": "í´ë¨í•‘ìœ ë‹›", "status": 60}],\n';
        prompt += '        "failureCostData": [{"type": "ìœ ì••ê³„í†µ", "cost": 3500, "percentage": 35}],\n';
        prompt += '        "maintenanceCostData": [{"type": "ìœ ì••", "selfRepair": 1200, "outsideRepair": 2800}],\n';
        prompt += '        "costAnalysis": "ë¹„ìš© ë¶„ì„",\n';
        prompt += '        "emergencyActions": "ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­"\n';
        prompt += '      },\n';
        prompt += '      "SelfCheckItem__c": [\n';
        prompt += '        "ì²´í¬ í•­ëª© 1",\n';
        prompt += '        "ì²´í¬ í•­ëª© 2",\n';
        prompt += '        "ì²´í¬ í•­ëª© 3"\n';
        prompt += '      ]\n';
        prompt += '    }\n';
        prompt += '  ]\n';
        prompt += '}\n';
        prompt += '```\n\n';
        prompt += 'ğŸš¨ **ì¤‘ìš” ì§€ì¹¨:**\n';
        prompt += 'â€¢ ë°˜ë“œì‹œ ìœ„ì˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ\n';
        prompt += 'â€¢ ëª¨ë“  ì°¨íŠ¸ ë°ì´í„°ëŠ” ìœ„ì—ì„œ ì œì‹œí•œ í˜•ì‹ìœ¼ë¡œ ì œê³µ\n';
        prompt += 'â€¢ ì‹¤ì œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ êµ¬ì²´ì ì¸ ë¶„ì„ ë‚´ìš© ì‘ì„±\n';
        prompt += 'â€¢ ì¼ë°˜ì ì¸ í…ìŠ¤íŠ¸ ì‘ë‹µ ê¸ˆì§€ - ì˜¤ì§ JSONë§Œ ì‘ë‹µ\n\n';
        return prompt;
    }

    private static String buildSvgChartGuide() {
        // (ì´ì „ê³¼ ë™ì¼)
        String prompt = 'ğŸ“ˆ **[ì°¨íŠ¸ ë°ì´í„° ìš”êµ¬ì‚¬í•­ - SVGëŠ” Apexì—ì„œ ìƒì„±]**\n';
        prompt += 'ğŸš¨ **SVG ì°¨íŠ¸ ëŒ€ì‹  ì°¨íŠ¸ ìƒì„±ìš© ë°ì´í„°ë§Œ ì œê³µí•˜ì„¸ìš”!** ğŸš¨\n\n';
        prompt += '**ë°ì´í„° í˜•ì‹ ì˜ˆì‹œ:**\n\n';
        prompt += 'â€¢ **riskTrendData**: ìœ„í—˜ë„ ì¶”ì´ (0-100 ì ìˆ˜)\n';
        prompt += '  í˜•ì‹: {"current": 85, "month1": 75, "month2": 60}\n\n';
        prompt += 'â€¢ **componentStatusData**: ë¶€í’ˆë³„ ìƒíƒœ (0-100 ì ìˆ˜)\n';
        prompt += '  í˜•ì‹: [{"name": "ìœ ì••ì‹œìŠ¤í…œ", "status": 85}, {"name": "í´ë¨í•‘ìœ ë‹›", "status": 60}, {"name": "ê°€ì—´ì‹œìŠ¤í…œ", "status": 90}, {"name": "ì œì–´ì‹œìŠ¤í…œ", "status": 45}]\n\n';
        prompt += 'â€¢ **failureCostData**: ê³ ì¥ ìœ í˜•ë³„ ì˜ˆìƒ ë¹„ìš©\n';
        prompt += '  í˜•ì‹: [{"type": "ìœ ì••ê³„í†µ", "cost": 3500, "percentage": 35}, {"type": "í´ë¨í•‘ê³„í†µ", "cost": 2500, "percentage": 25}, {"type": "ê°€ì—´ê³„í†µ", "cost": 2000, "percentage": 20}, {"type": "ì œì–´ê³„í†µ", "cost": 1500, "percentage": 15}, {"type": "ê¸°íƒ€", "cost": 500, "percentage": 5}]\n\n';
        prompt += 'â€¢ **maintenanceCostData**: ìˆ˜ë¦¬ ë°©ì‹ë³„ ë¹„ìš© ë¹„êµ (ë§Œì› ë‹¨ìœ„)\n';
        prompt += '  í˜•ì‹: [{"type": "ìœ ì••", "selfRepair": 1200, "outsideRepair": 2800}, {"type": "í´ë¨í•‘", "selfRepair": 800, "outsideRepair": 2200}, {"type": "ê°€ì—´", "selfRepair": 600, "outsideRepair": 1800}, {"type": "ì œì–´", "selfRepair": 400, "outsideRepair": 1600}]\n\n';
        prompt += 'ğŸš¨ **ì¤‘ìš”:** SVG íƒœê·¸ë‚˜ HTMLì€ ìƒì„±í•˜ì§€ ë§ê³ , ì˜¤ì§ ìœ„ì˜ JSON ë°ì´í„°ë§Œ ì œê³µí•˜ì„¸ìš”!\n';
        prompt += 'Apexì—ì„œ ì´ ë°ì´í„°ë¥¼ ë°›ì•„ ì™„ì „í•œ SVG ì°¨íŠ¸ë¥¼ ìƒì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.\n\n';
        return prompt;
    }

    private static String buildGeneralGuidelines() {
        // (ì´ì „ê³¼ ë™ì¼)
        String prompt = 'ğŸ¯ **[ì£¼ìš” ì§€ì¹¨]**\n';
        prompt += 'â€¢ ë©”ì¼ì€ ê°„ê²°í•˜ë©´ì„œë„ ì „ë¬¸ì„±ê³¼ ê¸´ê¸‰ì„±ì„ ê°•ì¡°\n';
        prompt += 'â€¢ ìƒì„¸ ë³´ê³ ì„œëŠ” í˜„ì¬ ìƒí™© ë¶„ì„ê³¼ ê¸°íšŒë¹„ìš© ë¶„ì„ê¹Œì§€ í¬í•¨\n';
        prompt += 'â€¢ ìê°€ ì ê²€ ì´í›„ ë‚˜ì˜¬ ë‚´ìš©(ì •ë¹„ ê¶Œì¥ì‚¬í•­, ë‹¤ìŒ ë‹¨ê³„)ì€ ì œì™¸\n';
        prompt += 'â€¢ ì‹¤ì§ˆì ì¸ ê¸°ê³„ ê³ ì¥ ì˜ˆë°©ì— ë„ì›€ì´ ë˜ëŠ” ë‚´ìš© ìœ„ì£¼\n';
        prompt += 'â€¢ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±\n\n';
        return prompt;
    }

    private static Map<String, Object> getRiskAnalyzeResponseSchema() {
        // (ì´ì „ ë‹µë³€ì—ì„œ ì œê³µëœ ì „ì²´ ìŠ¤í‚¤ë§ˆ ë‚´ìš©ê³¼ ë™ì¼)
        return new Map<String, Object>{
                'type' => 'object',
                'properties' => new Map<String, Object>{
                        'riskAnalysisResults' => new Map<String, Object>{
                                'type' => 'array',
                                'description' => 'ìœ„í—˜ ë¶„ì„ ê²°ê³¼ì˜ ë°°ì—´ì…ë‹ˆë‹¤. ê° í•­ëª©ì€ ë‹¨ì¼ Assetì— ëŒ€í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.',
                                'items' => new Map<String, Object>{
                                        'type' => 'object',
                                        'properties' => new Map<String, Object>{
                                                'accountId' => new Map<String, Object>{'type' => 'string', 'description' => 'ë¶„ì„ ëŒ€ìƒ Accountì˜ Salesforce ID'},
                                                'assetId' => new Map<String, Object>{'type' => 'string', 'description' => 'ë¶„ì„ ëŒ€ìƒ Assetì˜ Salesforce ID'},
                                                'uuid' => new Map<String, Object>{'type' => 'string', 'description' => 'ì´ ë¶„ì„ ìš”ì²­ì— ëŒ€í•œ ê³ ìœ  ì‹ë³„ì UUID (v4 í˜•ì‹)'},
                                                'mailComponents' => new Map<String, Object>{
                                                        'type' => 'object',
                                                        'description' => 'ì´ë©”ì¼ ì•Œë¦¼ ìƒì„±ì— í•„ìš”í•œ êµ¬ì„± ìš”ì†Œ',
                                                        'properties' => new Map<String, Object>{
                                                                'mailSubject' => new Map<String, Object>{'type' => 'string', 'description' => 'ì´ë©”ì¼ ì œëª©.'},
                                                                'greeting' => new Map<String, Object>{'type' => 'string', 'description' => 'ì¸ì‚¬ë§.'},
                                                                'riskSummary' => new Map<String, Object>{'type' => 'string', 'description' => 'ìœ„í—˜ ìš”ì•½.'},
                                                                'riskLevel' => new Map<String, Object>{'type' => 'string', 'description' => 'ìœ„í—˜ ìˆ˜ì¤€.'},
                                                                'expectedTimeframe' => new Map<String, Object>{'type' => 'string', 'description' => 'ì˜ˆìƒ ì‹œê¸°.'},
                                                                'urgencyMessage' => new Map<String, Object>{'type' => 'string', 'description' => 'ê¸´ê¸‰ ë©”ì‹œì§€.'},
                                                                'riskTrendData' => new Map<String, Object>{
                                                                        'type' => 'object',
                                                                        'description' => 'ì‹œê°„ ê²½ê³¼ì— ë”°ë¥¸ ìœ„í—˜ë„ ì¶”ì´ ë°ì´í„° (ì ìˆ˜: 0-100).',
                                                                        'properties' => new Map<String, Object>{
                                                                                'current' => new Map<String, Object>{'type' => 'integer', 'description' => 'í˜„ì¬ ìœ„í—˜ë„ ì ìˆ˜'},
                                                                                'month1' => new Map<String, Object>{'type' => 'integer', 'description' => '1ê°œì›” í›„ ì˜ˆìƒ ìœ„í—˜ë„ ì ìˆ˜'},
                                                                                'month2' => new Map<String, Object>{'type' => 'integer', 'description' => '2ê°œì›” í›„ ì˜ˆìƒ ìœ„í—˜ë„ ì ìˆ˜'}
                                                                        },
                                                                        'required' => new List<String>{'current', 'month1', 'month2'}
                                                                },
                                                                'callToAction' => new Map<String, Object>{'type' => 'string', 'description' => 'í–‰ë™ ìœ ë„ ë¬¸êµ¬.'},
                                                                'closingMessage' => new Map<String, Object>{'type' => 'string', 'description' => 'ë§ˆë¬´ë¦¬ ì¸ì‚¬.'}
                                                        },
                                                        'required' => new List<String>{'mailSubject', 'greeting', 'riskSummary', 'riskLevel', 'expectedTimeframe', 'urgencyMessage', 'riskTrendData', 'callToAction', 'closingMessage'}
                                                },
                                                'detailComponents' => new Map<String, Object>{
                                                        'type' => 'object',
                                                        'description' => 'ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ ì½˜í…ì¸  ìƒì„±ì— í•„ìš”í•œ êµ¬ì„± ìš”ì†Œ.',
                                                        'properties' => new Map<String, Object>{
                                                                'detailTitle' => new Map<String, Object>{'type' => 'string', 'description' => 'ìƒì„¸ ë³´ê³ ì„œ ì œëª©.'},
                                                                'riskOverview' => new Map<String, Object>{'type' => 'string', 'description' => 'ìœ„í—˜ ê°œìš”.'},
                                                                'technicalFindings' => new Map<String, Object>{'type' => 'string', 'description' => 'ê¸°ìˆ ì  ë°œê²¬ì‚¬í•­.'},
                                                                'rootCauseAnalysis' => new Map<String, Object>{'type' => 'string', 'description' => 'ê·¼ë³¸ ì›ì¸ ë¶„ì„.'},
                                                                'impactAssessment' => new Map<String, Object>{'type' => 'string', 'description' => 'ì˜í–¥ í‰ê°€.'},
                                                                'riskTrendData' => new Map<String, Object>{
                                                                        'type' => 'object', 'description' => 'ìœ„í—˜ë„ ì¶”ì´ ë°ì´í„° (ìƒì„¸ìš©).',
                                                                        'properties' => new Map<String, Object>{
                                                                                'current' => new Map<String, Object>{'type' => 'integer'},
                                                                                'month1' => new Map<String, Object>{'type' => 'integer'},
                                                                                'month2' => new Map<String, Object>{'type' => 'integer'}
                                                                        }, 'required' => new List<String>{'current', 'month1', 'month2'}
                                                                },
                                                                'componentStatusData' => new Map<String, Object>{
                                                                        'type' => 'array', 'description' => 'ë¶€í’ˆë³„ ìƒíƒœ ë°ì´í„°. ì°¨íŠ¸ ìƒì„±ìš©.',
                                                                        'items' => new Map<String, Object>{
                                                                                'type' => 'object', 'properties' => new Map<String, Object>{
                                                                                        'name' => new Map<String, Object>{'type' => 'string', 'description' => 'ë¶€í’ˆëª…'},
                                                                                        'status' => new Map<String, Object>{'type' => 'integer', 'description' => 'ìƒíƒœ ì ìˆ˜ (0-100)'}
                                                                                }, 'required' => new List<String>{'name', 'status'}
                                                                        }
                                                                },
                                                                'failureCostData' => new Map<String, Object>{
                                                                        'type' => 'array', 'description' => 'ê³ ì¥ ìœ í˜•ë³„ ì˜ˆìƒ ë¹„ìš© ë°ì´í„°. ì°¨íŠ¸ ìƒì„±ìš©.',
                                                                        'items' => new Map<String, Object>{
                                                                                'type' => 'object', 'properties' => new Map<String, Object>{
                                                                                        'type' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ìœ í˜•'},
                                                                                        'cost' => new Map<String, Object>{'type' => 'number', 'description' => 'ì˜ˆìƒ ë¹„ìš©'},
                                                                                        'percentage' => new Map<String, Object>{'type' => 'number', 'description' => 'ë¹„ìš© ë¹„ìœ¨'}
                                                                                }, 'required' => new List<String>{'type', 'cost', 'percentage'}
                                                                        }
                                                                },
                                                                'maintenanceCostData' => new Map<String, Object>{
                                                                        'type' => 'array', 'description' => 'ìˆ˜ë¦¬ ë°©ì‹ë³„ ë¹„ìš© ë¹„êµ ë°ì´í„°. ì°¨íŠ¸ ìƒì„±ìš©.',
                                                                        'items' => new Map<String, Object>{
                                                                                'type' => 'object', 'properties' => new Map<String, Object>{
                                                                                        'type' => new Map<String, Object>{'type' => 'string', 'description' => 'ìˆ˜ë¦¬ ëŒ€ìƒ'},
                                                                                        'selfRepair' => new Map<String, Object>{'type' => 'number', 'description' => 'ìê°€ ìˆ˜ë¦¬ ë¹„ìš©'},
                                                                                        'outsideRepair' => new Map<String, Object>{'type' => 'number', 'description' => 'ì™¸ë¶€ ìˆ˜ë¦¬ ë¹„ìš©'}
                                                                                }, 'required' => new List<String>{'type', 'selfRepair', 'outsideRepair'}
                                                                        }
                                                                },
                                                                'costAnalysis' => new Map<String, Object>{'type' => 'string', 'description' => 'ë¹„ìš© ë¶„ì„.'},
                                                                'emergencyActions' => new Map<String, Object>{'type' => 'string', 'description' => 'ê¸´ê¸‰ ì¡°ì¹˜ì‚¬í•­.'}
                                                        },
                                                        'required' => new List<String>{'detailTitle', 'riskOverview', 'technicalFindings', 'rootCauseAnalysis', 'impactAssessment', 'riskTrendData', 'componentStatusData', 'failureCostData', 'maintenanceCostData', 'costAnalysis', 'emergencyActions'}
                                                },
                                                'SelfCheckItem__c' => new Map<String, Object>{
                                                        'type' => 'array', 'description' => 'ìê°€ ì ê²€ í•­ëª© ëª©ë¡.',
                                                        'items' => new Map<String, Object>{'type' => 'string', 'description' => 'ê°œë³„ ìê°€ ì ê²€ í•­ëª©'}
                                                }
                                        },
                                        'required' => new List<String>{'accountId', 'assetId', 'uuid', 'mailComponents', 'detailComponents', 'SelfCheckItem__c'}
                                }
                        }
                },
                'required' => new List<String>{'riskAnalysisResults'}
        };
    }

    private static void processGeminiResponse(String jsonResponse, Id accountId, String expectedUUID) {
        try {
            Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(jsonResponse);
            List<Object> resultsArray = (List<Object>) responseMap.get('riskAnalysisResults');

            if (resultsArray == null || resultsArray.isEmpty()) {
                System.debug(LoggingLevel.WARN,'No riskAnalysisResults found in response for Account: ' + accountId);
                return;
            }

            List<RiskAnalyzeReport__c> reportsToInsert = new List<RiskAnalyzeReport__c>();
            Map<String, List<String>> reportUUIDToCheckItemsMap = new Map<String, List<String>>();

            for (Object resultObj : resultsArray) {
                Map<String, Object> result = (Map<String, Object>) resultObj;
                String responseAccountId = (String) result.get('accountId');
                String assetId = (String) result.get('assetId');
                String responseUUID = (String) result.get('uuid');

                if (String.valueOf(accountId) != responseAccountId) {
                    System.debug(LoggingLevel.WARN, 'Account ID mismatch in response. Expected: ' + accountId + ', Received: ' + responseAccountId + '. Skipping this result.');
                    continue;
                }
                if (expectedUUID != responseUUID) {
                    System.debug(LoggingLevel.WARN, 'UUID mismatch - Expected: ' + expectedUUID + ', Received: ' + responseUUID + '. Using expected UUID for consistency.');
                    responseUUID = expectedUUID;
                }

                Map<String, Object> mailComponents = (Map<String, Object>) result.get('mailComponents');
                Map<String, Object> detailComponents = (Map<String, Object>) result.get('detailComponents');

                if (mailComponents == null || detailComponents == null) {
                    System.debug(LoggingLevel.ERROR, 'mailComponents or detailComponents is null for Account: ' + accountId + ', Asset: ' + assetId + ', UUID: ' + responseUUID);
                    continue;
                }

                RiskAnalyzeReport__c report = new RiskAnalyzeReport__c();
                report.Account__c = accountId;
                report.Asset__c = assetId;
                report.UUID__c = responseUUID;
                report.MailSubject__c = (String) mailComponents.get('mailSubject');
                report.MailContent__c = assembleMailContent(mailComponents, responseUUID);
                report.Detail__c = assembleDetailContent(detailComponents, responseUUID);

                reportsToInsert.add(report);

                List<Object> checkItemsObj = (List<Object>) result.get('SelfCheckItem__c');
                if (checkItemsObj != null && !checkItemsObj.isEmpty()) {
                    List<String> checkItemStrings = new List<String>();
                    for (Object item : checkItemsObj) {
                        if(item != null) checkItemStrings.add(String.valueOf(item));
                    }
                    if(!checkItemStrings.isEmpty()) reportUUIDToCheckItemsMap.put(responseUUID, checkItemStrings);
                }
            }

            if (!reportsToInsert.isEmpty()) {
                Database.SaveResult[] srs = Database.insert(reportsToInsert, false);
                Integer successCount = 0;
                List<RiskAnalyzeReport__c> successfullyInsertedReports = new List<RiskAnalyzeReport__c>();
                for(Integer i=0; i < reportsToInsert.size(); i++){
                    Database.SaveResult sr = srs[i];
                    if(sr.isSuccess()){
                        successCount++;
                        reportsToInsert[i].Id = sr.getId();
                        successfullyInsertedReports.add(reportsToInsert[i]);
                        System.debug(LoggingLevel.DEBUG,'Inserted Report ID: ' + reportsToInsert[i].Id + ', UUID: ' + reportsToInsert[i].UUID__c);
                    } else {
                        for(Database.Error err : sr.getErrors()){
                            System.debug(LoggingLevel.ERROR, 'Error inserting RiskAnalyzeReport: ' + err.getStatusCode() + ': ' + err.getMessage() + ' Fields: ' + String.valueOf(err.getFields()));
                        }
                    }
                }
                System.debug(LoggingLevel.INFO,'Successfully inserted ' + successCount + '/' + reportsToInsert.size() + ' RiskAnalyzeReport records for Account: ' + accountId);

                if(!successfullyInsertedReports.isEmpty()){
                    createSelfCheckItems(successfullyInsertedReports, reportUUIDToCheckItemsMap);
                    sendRiskAnalysisEmails(successfullyInsertedReports, accountId);
                }
            }

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error processing Gemini response for Account ' + accountId + ': ' + e.getMessage() + '\nStackTrace: ' + e.getStackTraceString());
            System.debug(LoggingLevel.ERROR, 'Problematic JSON Response (first 1000 chars): ' + (jsonResponse != null ? jsonResponse.left(1000) : 'null'));
        }
    }

    private static void sendRiskAnalysisEmails(List<RiskAnalyzeReport__c> reports, Id accountId) {
        if (reports == null || reports.isEmpty()) return;
        try {
            Integer mailingCount = 0;
            for (RiskAnalyzeReport__c report : reports) {
                if (System.isBatch() && mailingCount >= 1) {
                    System.debug(LoggingLevel.INFO, 'Demo email limit reached in batch context.');
                    break;
                }
                if (report.Id != null && String.isNotBlank(report.MailContent__c)) {
                    RiskAnalysisEmailSender.sendRiskAnalysisEmail(
                            accountId,
                            report.MailContent__c,
                            report.MailSubject__c
                    );
                    mailingCount++;
                }
            }
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error sending risk analysis emails: ' + e.getMessage() + e.getStackTraceString());
        }
    }

    private static void createSelfCheckItems(List<RiskAnalyzeReport__c> reports, Map<String, List<String>> reportUUIDToCheckItemsMap) {
        if (reports == null || reports.isEmpty() || reportUUIDToCheckItemsMap == null || reportUUIDToCheckItemsMap.isEmpty()) {
            return;
        }
        List<SelfCheckItem__c> checkItemsToInsert = new List<SelfCheckItem__c>();
        for (RiskAnalyzeReport__c report : reports) {
            if (report.Id == null || String.isBlank(report.UUID__c)) continue;

            List<String> checkItems = reportUUIDToCheckItemsMap.get(report.UUID__c);
            if (checkItems != null && !checkItems.isEmpty()) {
                Integer itemSequence = 1;
                for (String checkItemDesc : checkItems) {
                    if(String.isBlank(checkItemDesc)) continue;
                    SelfCheckItem__c checkItem = new SelfCheckItem__c();
                    checkItem.RiskAnalyzeReport__c = report.Id;
                    checkItem.Description__c = checkItemDesc.left(255);
                    checkItem.Sequence__c = itemSequence++;
                    checkItemsToInsert.add(checkItem);
                }
            }
        }
        if (!checkItemsToInsert.isEmpty()) {
            Database.SaveResult[] srs = Database.insert(checkItemsToInsert, false);
            Integer successCount = 0;
            for(Database.SaveResult sr : srs){
                if(sr.isSuccess()){
                    successCount++;
                } else {
                    for(Database.Error err : sr.getErrors()){
                        System.debug(LoggingLevel.ERROR, 'Error inserting SelfCheckItem: ' + err.getStatusCode() + ': ' + err.getMessage() + ' Fields: ' + String.valueOf(err.getFields()));
                    }
                }
            }
            System.debug(LoggingLevel.INFO,'Successfully inserted ' + successCount + '/' + checkItemsToInsert.size() + ' SelfCheckItem records');
        }
    }

    public static String generateUUID() {
        String hexChars = '0123456789abcdef';
        String uuid = '';
        for (Integer i = 0; i < 36; i++) {
            if (i == 8 || i == 13 || i == 18 || i == 23) {
                uuid += '-';
            } else if (i == 14) {
                uuid += '4'; // Version 4
            } else if (i == 19) {
                Integer randomIndex = Math.mod(Math.abs(Crypto.getRandomInteger()), 4);
                uuid += hexChars.substring(8 + randomIndex, 8 + randomIndex + 1);
            } else {
                Integer randomIndex = Math.mod(Math.abs(Crypto.getRandomInteger()), 16);
                uuid += hexChars.substring(randomIndex, randomIndex + 1);
            }
        }
        return uuid;
    }

    private static Map<String, Object> getTypedMapFromComponents(Map<String, Object> components, String key) {
        Object rawObject = components.get(key);
        if (rawObject == null) {
            System.debug(LoggingLevel.WARN, 'getTypedMapFromComponents: Raw object for key "' + key + '" is null.');
            return null;
        }

        String initialSerialized = JSON.serialize(rawObject);
        // ì´ ë¡œê·¸ëŠ” ì´ˆê¸° rawObjectì˜ ìƒíƒœë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. instanceof ê²€ì‚¬ëŠ” ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
        System.debug(LoggingLevel.DEBUG, 'getTypedMapFromComponents - Key: ' + key +
                ', Initial rawObject (Serialized): ' + initialSerialized);

        try {
            // rawObjectë¥¼ ë‹¤ì‹œ ì§ë ¬í™” í›„ JSON.deserializeUntypedë¡œ ì—­ì§ë ¬í™”í•©ë‹ˆë‹¤.
            // JSON.deserializeUntypedëŠ” JSON ê°ì²´ ë¬¸ìì—´ì— ëŒ€í•´ Map<String, Object>ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ë¬¸ì„œí™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            Object deserializedObject = JSON.deserializeUntyped(initialSerialized);

            // instanceof ê²€ì‚¬ ëŒ€ì‹  ì§ì ‘ì ì¸ íƒ€ì… ìºìŠ¤íŒ…ì„ ì‹œë„í•©ë‹ˆë‹¤.
            try {
                Map<String, Object> typedMap = (Map<String, Object>) deserializedObject;
                System.debug(LoggingLevel.INFO, 'Successfully CAST key "' + key + '" to Map<String, Object> after deserializeUntyped. Content (first 200 chars): ' + (typedMap != null ? JSON.serialize(typedMap).left(200) : 'null'));
                return typedMap;
            } catch (TypeException te) {
                // ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ JSON.deserializeUntypedê°€ Map<String, Object>ì™€ í˜¸í™˜ë˜ì§€ ì•ŠëŠ” íƒ€ì…ì„ ë°˜í™˜í•œ ê²ƒì…ë‹ˆë‹¤.
                // ì´ëŠ” JSON ë¬¸ìì—´ì´ ì‹¤ì œë¡œëŠ” JSON ê°ì²´ê°€ ì•„ë‹ˆì—ˆê±°ë‚˜, ë§¤ìš° ì˜ˆì™¸ì ì¸ Apex ë‚´ë¶€ íƒ€ì… ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                System.debug(LoggingLevel.ERROR, 'CRITICAL: TypeException on casting to Map<String, Object> for key "' + key +
                        '". This means deserializeUntyped did not return a compatible Map. Exception: ' + te.getMessage() +
                        '. Deserialized object (toString): ' + String.valueOf(deserializedObject) +
                        '. Initial serialized from rawObject (first 200 chars): ' + initialSerialized.left(200));
                return null;
            }
        } catch (Exception e) { // JSON.serialize ë˜ëŠ” JSON.deserializeUntyped ìì²´ì˜ ì˜ˆì™¸ ì²˜ë¦¬
            System.debug(LoggingLevel.ERROR, 'Exception during JSON processing (serialize/deserializeUntyped) for key "' + key +
                    '": ' + e.getMessage() + '. Initial Serialized Object was: ' + initialSerialized.left(200) + // ë¡œê·¸ ê¸¸ì´ ì œí•œ
                    '. Stack: ' + e.getStackTraceString());
            return null;
        }
    }

    // 2. assembleMailContent ë©”ì„œë“œì—ì„œ ìœ„í—˜ë„ ì¶”ì´ ì°¨íŠ¸ ê´€ë ¨ ë¶€ë¶„ ì œê±°
    private static String assembleMailContent(Map<String, Object> mailComponents, String uuid) {
        if (mailComponents == null) {
            System.debug(LoggingLevel.WARN, 'assembleMailContent: mailComponents is null. UUID: ' + uuid);
            return '';
        }

        String mailSubject = (String) mailComponents.get('mailSubject');
        String greeting = (String) mailComponents.get('greeting');
        String riskSummary = (String) mailComponents.get('riskSummary');
        String riskLevel = (String) mailComponents.get('riskLevel');
        String expectedTimeframe = (String) mailComponents.get('expectedTimeframe');
        String urgencyMessage = (String) mailComponents.get('urgencyMessage');
        String callToAction = (String) mailComponents.get('callToAction');
        String closingMessage = (String) mailComponents.get('closingMessage');

        // ìœ„í—˜ë„ ì¶”ì´ ì°¨íŠ¸ ê´€ë ¨ ì½”ë“œ ì „ì²´ ì œê±°ë¨

        String htmlContent = '<div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; line-height: 1.6; color: #333;">';
        if (String.isNotBlank(mailSubject)) htmlContent += '<h1 style="color: #dc3545; font-size: 20px; margin-bottom: 20px; text-align: center;">' + mailSubject.escapeHtml4() + '</h1>';
        if (String.isNotBlank(greeting)) htmlContent += '<p style="margin-bottom: 20px;">' + greeting.escapeHtml4() + '</p>';
        if (String.isNotBlank(riskSummary)) {
            htmlContent += '<div style="background-color: #fff5f5; border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 20px;">';
            htmlContent += '<h3 style="color: #dc3545; margin-top: 0;">ğŸš¨ ë°œê²¬ëœ ìœ„í—˜ ìš”ì†Œ</h3>';
            htmlContent += '<p>' + riskSummary.escapeHtml4() + '</p>';
            if (String.isNotBlank(riskLevel)) htmlContent += '<p><strong>ìœ„í—˜ë„:</strong> <span style="color: #dc3545; font-weight: bold;">' + riskLevel.escapeHtml4() + '</span></p>';
            if (String.isNotBlank(expectedTimeframe)) htmlContent += '<p><strong>ì˜ˆìƒ ë°œìƒ ì‹œê¸°:</strong> ' + expectedTimeframe.escapeHtml4() + '</p>';
            htmlContent += '</div>';
        }
        if (String.isNotBlank(urgencyMessage)) {
            htmlContent += '<div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin-bottom: 20px; border-radius: 5px;">';
            htmlContent += '<p style="margin: 0; color: #856404; font-weight: bold;">âš ï¸ ' + urgencyMessage.escapeHtml4() + '</p>';
            htmlContent += '</div>';
        }

        // ìœ„í—˜ë„ ë³€í™” ì¶”ì´ ì°¨íŠ¸ ë°•ìŠ¤ ì „ì²´ ì œê±°ë¨

        String baseAnalysisUrl = 'https://orgfarm-2bd4fdfcf2.my.site.com/support/s/agentron-analysis';
        String detailUrlString = '#';

        if (String.isNotBlank(uuid)) {
            try {
                detailUrlString = baseAnalysisUrl + '?c__channelName=ERROR_REPORT&c__jsonString=' + EncodingUtil.urlEncode('{"uuid":"' + uuid + '"}', 'UTF-8');
            } catch (Exception e) {
                System.debug(LoggingLevel.ERROR, 'Error encoding detail URL for UUID: ' + uuid + '. Error: ' + e.getMessage());
                detailUrlString = baseAnalysisUrl + '?error=uuid-encoding-failed';
            }
        } else {
            System.debug(LoggingLevel.ERROR, 'RiskAnalysisProcessor: UUID is blank, cannot generate detail URL.');
        }

        htmlContent += '<div style="text-align: center; margin: 30px 0;">';
        htmlContent += '<a href="' + detailUrlString.escapeHtml4() + '" style="background-color: #0176d3; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">ğŸ“Š ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ í™•ì¸</a>';
        htmlContent += '</div>';

        if (String.isNotBlank(callToAction)) htmlContent += '<p style="color: #0176d3; font-weight: bold; text-align: center; margin-bottom: 20px;">' + callToAction.escapeHtml4() + '</p>';
        if (String.isNotBlank(closingMessage)) {
            htmlContent += '<div style="border-top: 1px solid #dee2e6; padding-top: 20px; margin-top: 30px; color: #6c757d;">';
            htmlContent += '<p>' + closingMessage.escapeHtml4() + '</p>';
            htmlContent += '</div>';
        }
        htmlContent += '</div>';
        return htmlContent;
    }

    private static String assembleDetailContent(Map<String, Object> detailComponents, String uuid) {
        if (detailComponents == null) {
            System.debug(LoggingLevel.WARN, 'assembleDetailContent: detailComponents is null. UUID: ' + uuid);
            return '';
        }

        String detailTitle = detailComponents.get('detailTitle') != null ? ((String)detailComponents.get('detailTitle')).escapeHtml4() : '';
        String riskOverview = detailComponents.get('riskOverview') != null ? ((String)detailComponents.get('riskOverview')).escapeHtml4() : '';
        String technicalFindings = detailComponents.get('technicalFindings') != null ? ((String)detailComponents.get('technicalFindings')).escapeHtml4() : '';
        String rootCauseAnalysis = detailComponents.get('rootCauseAnalysis') != null ? ((String)detailComponents.get('rootCauseAnalysis')).escapeHtml4() : '';
        String impactAssessment = detailComponents.get('impactAssessment') != null ? ((String)detailComponents.get('impactAssessment')).escapeHtml4() : '';
        String costAnalysis = detailComponents.get('costAnalysis') != null ? ((String)detailComponents.get('costAnalysis')).escapeHtml4() : '';
        String emergencyActions = detailComponents.get('emergencyActions') != null ? ((String)detailComponents.get('emergencyActions')).escapeHtml4() : '';

        String riskTrendChartHtml = '';
        Map<String, Object> riskTrendDataMap = getTypedMapFromComponents(detailComponents, 'riskTrendData');
        if (riskTrendDataMap != null) {
            try {
                riskTrendChartHtml = SvgChartGenerator.generateRiskTrendChart(riskTrendDataMap);
            } catch (Exception e) {
                System.debug(LoggingLevel.ERROR, 'Error generating riskTrendChart for detail (UUID: ' + uuid + '): ' + e.getMessage() + e.getStackTraceString());
                riskTrendChartHtml = '';
            }
        } else {
            System.debug(LoggingLevel.WARN, 'assembleDetailContent: riskTrendDataMap is null for UUID: ' + uuid);
        }

        String componentStatusChartHtml = '';
        Object rawComponentStatusData = detailComponents.get('componentStatusData');
        if (rawComponentStatusData instanceof List<Object>) {
            try {
                componentStatusChartHtml = SvgChartGenerator.generateComponentStatusChart((List<Object>)rawComponentStatusData);
            } catch (Exception e) {
                System.debug(LoggingLevel.ERROR, 'Error generating componentStatusChart for detail (UUID: ' + uuid + '): ' + e.getMessage() + e.getStackTraceString());
                componentStatusChartHtml = '';
            }
        }  else {
            System.debug(LoggingLevel.WARN, 'assembleDetailContent: rawComponentStatusData is not a List for UUID: ' + uuid + '. Actual: ' + (rawComponentStatusData != null ? JSON.serialize(rawComponentStatusData) : 'null'));
        }

        String failureCostChartHtml = '';
        Object rawFailureCostData = detailComponents.get('failureCostData');
        if (rawFailureCostData instanceof List<Object>) {
            try {
                failureCostChartHtml = SvgChartGenerator.generateFailureCostChart((List<Object>)rawFailureCostData);
            } catch (Exception e) {
                System.debug(LoggingLevel.ERROR, 'Error generating failureCostChart for detail (UUID: ' + uuid + '): ' + e.getMessage() + e.getStackTraceString());
                failureCostChartHtml = '';
            }
        } else {
            System.debug(LoggingLevel.WARN, 'assembleDetailContent: rawFailureCostData is not a List for UUID: ' + uuid + '. Actual: ' + (rawFailureCostData != null ? JSON.serialize(rawFailureCostData) : 'null'));
        }

        String maintenanceCostChartHtml = '';
        Object rawMaintenanceCostData = detailComponents.get('maintenanceCostData');
        if (rawMaintenanceCostData instanceof List<Object>) {
            try {
                maintenanceCostChartHtml = SvgChartGenerator.generateMaintenanceCostChart((List<Object>)rawMaintenanceCostData);
            } catch (Exception e) {
                System.debug(LoggingLevel.ERROR, 'Error generating maintenanceCostChart for detail (UUID: ' + uuid + '): ' + e.getMessage() + e.getStackTraceString());
                maintenanceCostChartHtml = '';
            }
        } else {
            System.debug(LoggingLevel.WARN, 'assembleDetailContent: rawMaintenanceCostData is not a List for UUID: ' + uuid + '. Actual: ' + (rawMaintenanceCostData != null ? JSON.serialize(rawMaintenanceCostData) : 'null'));
        }

        String htmlContent = '<div style="max-width: 900px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; line-height: 1.6; color: #333;">';
        if (String.isNotBlank(detailTitle)) htmlContent += '<header style="text-align:center;margin-bottom:30px;border-bottom:2px solid #0176d3;padding-bottom:20px;"><h1 style="color:#0176d3;font-size:24px;margin:0;">' + detailTitle + '</h1><p style="color: #6c757d; margin-top: 10px;">LSMtron ìœ„í—˜ ë¶„ì„ ì „ë¬¸ê°€ ë³´ê³ ì„œ</p></header>';
        if (String.isNotBlank(riskOverview)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#dc3545;font-size:18px;border-bottom:1px solid #dc3545;padding-bottom:5px;">ğŸš¨ ìœ„í—˜ ê°œìš”</h2><div style="background-color:#fff5f5;padding:15px;border-radius:5px;">' + riskOverview + '</div></section>';
        if (String.isNotBlank(technicalFindings)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#0176d3;font-size:18px;border-bottom:1px solid #0176d3;padding-bottom:5px;">ğŸ”§ ê¸°ìˆ ì  ë°œê²¬ì‚¬í•­</h2><div style="background-color:#f8f9fa;padding:15px;border-radius:5px;">' + technicalFindings + '</div></section>';
        if (String.isNotBlank(rootCauseAnalysis)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#6f42c1;font-size:18px;border-bottom:1px solid #6f42c1;padding-bottom:5px;">ğŸ” ê·¼ë³¸ ì›ì¸</h2><div style="background-color:#f8f7ff;padding:15px;border-radius:5px;">' + rootCauseAnalysis + '</div></section>';
        if (String.isNotBlank(impactAssessment)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#fd7e14;font-size:18px;border-bottom:1px solid #fd7e14;padding-bottom:5px;">ğŸ“ˆ ì˜í–¥ë„ í‰ê°€</h2><div style="background-color:#fff8f0;padding:15px;border-radius:5px;">' + impactAssessment + '</div></section>';

        htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#6610f2;font-size:18px;border-bottom:1px solid #6610f2;padding-bottom:5px;">ğŸ“Š ìœ„í—˜ë„ ë³€í™” ì¶”ì´</h2><div style="text-align:center;background-color:#f8f6ff;padding:20px;border-radius:5px;">' + riskTrendChartHtml + '</div></section>';
        htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#20c997;font-size:18px;border-bottom:1px solid #20c997;padding-bottom:5px;">ğŸ”§ ì£¼ìš” ë¶€í’ˆ ìƒíƒœ</h2><div style="text-align:center;background-color:#f0fff4;padding:20px;border-radius:5px;">' + componentStatusChartHtml + '</div></section>';
        htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#e83e8c;font-size:18px;border-bottom:1px solid #e83e8c;padding-bottom:5px;">ğŸ’° ê³ ì¥ ìœ í˜•ë³„ ì˜ˆìƒ ë¹„ìš©</h2><div style="text-align:center;background-color:#fff0f5;padding:20px;border-radius:5px;">' + failureCostChartHtml + '</div></section>';
        htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#17a2b8;font-size:18px;border-bottom:1px solid #17a2b8;padding-bottom:5px;">ğŸ”¨ ìˆ˜ë¦¬ ë°©ì‹ë³„ ë¹„ìš© ë¹„êµ</h2><div style="text-align:center;background-color:#d1ecf1;padding:20px;border-radius:5px;">' + maintenanceCostChartHtml + '</div></section>';

        if (String.isNotBlank(costAnalysis)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#6f42c1;font-size:18px;border-bottom:1px solid #6f42c1;padding-bottom:5px;">ğŸ’° ê¸°íšŒë¹„ìš© ë¶„ì„</h2><div style="background-color:#f8f7ff;padding:15px;border-radius:5px;">' + costAnalysis + '</div></section>';
        if (String.isNotBlank(emergencyActions)) htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#dc3545;font-size:18px;border-bottom:1px solid #dc3545;padding-bottom:5px;">âš¡ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­</h2><div style="background-color:#f8d7da;padding:15px;border-radius:5px;border:1px solid #dc3545;"><strong style="color:#721c24;">ê¸´ê¸‰:</strong> ' + emergencyActions + '</div></section>';

        htmlContent += '<section style="margin-bottom:25px;"><h2 style="color:#0176d3;font-size:18px;border-bottom:1px solid #0176d3;padding-bottom:5px;">ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„</h2><div style="background-color:#cce7ff;padding:20px;border-radius:5px;text-align:center;"><p style="margin:0 0 15px 0;font-size:16px;font-weight:bold;">ìƒì„¸ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì…¨ë‹¤ë©´, ì´ì œ ìê°€ ì ê²€ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</p><p style="margin:0;color:#495057;">ìê°€ ì ê²€ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤í˜• ì •ë¹„ ê¶Œì¥ì‚¬í•­ê³¼ ë¹„ìš© ë¶„ì„ì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.</p></div></section>';
        htmlContent += '<footer style="text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #dee2e6;"><p style="color:#6c757d;font-size:14px;">LSMtron ìœ„í—˜ ë¶„ì„ ì „ë¬¸ê°€ | ê³ ê°ì§€ì›: support@lsmtron.com</p></footer>';
        htmlContent += '</div>';
        return htmlContent;
    }
}