/************************************************************************************
* File Name   	    : SelfCheckController
* Author	  		: Jiae.Tak
* Date				: 2025-06-02
* Tester	  		:
* Target	  		:
* Description 	    : 
* Modification Log
* ===================================================================================
* Ver      Date            Author          Modification
* ===================================================================================
* 1.0      2025-06-02         Jiae.Tak          Create
************************************************************************************/
public with sharing class SelfCheckController {
    @AuraEnabled(Cacheable=false)
    public static Map<String, Object> getInit(String uuid){
        System.debug('uuid : ' + uuid);
        Map<String, Object> mapReturn = new Map<String, Object>();
        try {
            RiskAnalyzeReport__c objReport = [
                    SELECT  Id, MailContent__c, MailSubject__c, Account__c, Asset__c, Asset__r.Product2Id, Asset__r.ManufactureDate, Asset__r.InstallDate, Asset__r.Product2.Name
                    FROM    RiskAnalyzeReport__c
                    WHERE   UUID__c =: uuid
                    LIMIT   1
            ];

            List<SelfCheckItem__c> listSelfCheckItems = new List<SelfCheckItem__c>([
                SELECT      Id, Sequence__c, Description__c
                FROM        SelfCheckItem__c
                WHERE       RiskAnalyzeReport__c =: objReport.Id
                ORDER BY    Sequence__c
            ]);

            mapReturn.put('selfCheckItems', listSelfCheckItems);
            mapReturn.put('objReport', objReport);
        }catch (Exception e){
            System.debug('Error in getInit: ' + e.getMessage());
            mapReturn.put('error', e.getMessage());
            mapReturn.put('selfCheckItems', new List<SelfCheckItem__c>());
        }

        return mapReturn;
    }

    @AuraEnabled(Cacheable=false)
    public static Map<String, Object> updateSelfCheckItems(List<Id> itemIds){
        Map<String, Object> mapReturn = new Map<String, Object>();
        try{
            if (itemIds != null && !itemIds.isEmpty()) {
                List<SelfCheckItem__c> itemsToUpdate = new List<SelfCheckItem__c>([
                        SELECT  Id, IsChecked__c
                        FROM    SelfCheckItem__c
                        WHERE   Id IN :itemIds
                ]);
                System.debug('itemsToUpdate : ' + itemsToUpdate);
                List<SelfCheckItem__c> listUpdate = new List<SelfCheckItem__c>();
                if (!itemsToUpdate.isEmpty()) {
                    for (SelfCheckItem__c item : itemsToUpdate) {
                        item.IsChecked__c = true;
                        listUpdate.add(item);
                    }
                    update listUpdate;
                    mapReturn.put('status', 'SUCCESS');
                    mapReturn.put('message', 'Successfully updated ' + itemsToUpdate.size() + ' records.');
                } else {
                    mapReturn.put('status', 'ERROR');
                    mapReturn.put('message', 'No matching items found for update.');
                }
            } else {
                mapReturn.put('status', 'ERROR');
                mapReturn.put('message', 'No item IDs provided for update.');
            }
        } catch (Exception e) {
            System.debug('General Error updating SelfCheckItem__c: ' + e.getMessage());
            throw new AuraHandledException('An unexpected error occurred: ' + e.getMessage());
        }
        return mapReturn;
    }

    @AuraEnabled
    public static Map<String, Object> processActionRecAndProduct(RiskAnalyzeReport__c objReport){
        Map<String ,Object> mapReturn = new Map<String, Object>();
        try{
            if (objReport != null) {
                List<SelfCheckItem__c> listCheckItem = new List<SelfCheckItem__c>([
                        SELECT  Id, IsChecked__c, Description__c
                        FROM    SelfCheckItem__c
                        WHERE   RiskAnalyzeReport__c =: objReport.Id
                ]);

                List<Product2> listProduct = new List<Product2>([
                        SELECT  Id, Name, ProductCode, Price__c, Stock__c, Quantity__c, Replacement_Cycle__c
                        FROM    Product2
                        WHERE   Family = :objReport.Asset__r.Product2.Name
                ]);

                List<Case> listCase = new List<Case>([
                        SELECT   Id, AssetId, Subject, Description, Part_Code__c, Part_Name__c, malfuction_type__c
                                ,Malfunction_Type_Detail__c, CreatedDate, Fault_Code__c, Manufacturer__c, Price__c
                                ,Date_Time_Open__c, Date_Time_Close__c
                        FROM        Case
                        WHERE       AssetId = :objReport.Asset__c
                        AND         CreatedDate = LAST_N_DAYS:365
                        ORDER BY    AssetId, CreatedDate DESC
                ]);

                List<Alarm_history__c> listAlarmHistories = new List<Alarm_history__c>([
                        SELECT Error_alarm__c
                        FROM Alarm_history__c
                        WHERE Asset__c = :objReport.Asset__c
                ]);
                System.debug('listAlarmHistories :: ' + listAlarmHistories.size());

                Set<Id> setErrorAlarmId = new Set<Id>();
                for (Alarm_history__c obj : listAlarmHistories) {
                    setErrorAlarmId.add(obj.Error_alarm__c);
                }

                List<Error_alarm__c> listErrorAlarm = new List<Error_alarm__c>([
                        SELECT Id, Code_L__c, Code_M__c, Code_Name_L__c, Code_Name_M__c, Alarm_Ex__c,
                                Occurrence__c, Expectation_1st__c, Expectation_2nd__c, Expectation_3rd__c,
                                Message__c, Reason_1__c, Reason_2__c, Reason_3__c
                        FROM Error_alarm__c
                        WHERE Id = :setErrorAlarmId
                ]);

                String strSystemPrompt = buildSystemPrompt();
                String strUserPrompt = buildUserPrompt(objReport, listCheckItem, listProduct, listCase, listErrorAlarm);

                Gemini2_5FlashApiController.Gemini2_5Request geminiRequest = new Gemini2_5FlashApiController.Gemini2_5Request(strSystemPrompt, strUserPrompt, null);
                geminiRequest.generationConfig.temperature = 0.0;
                geminiRequest.generationConfig.maxOutputTokens = 60000;
                geminiRequest.generationConfig.responseMimeType = 'application/json';
                geminiRequest.generationConfig.responseSchema = getProcessActionRecAndProduct();
                String strResponse = Gemini2_5FlashApiController.askGemini2_5Flash(geminiRequest);

                if (String.isNotBlank(strResponse)) {
                    mapReturn = processGeminiResponse(strResponse);
                    System.debug('strResponse : ' + JSON.serializePretty(strResponse));
                } else {
                    mapReturn.put('hasPredictions', false);
                    mapReturn.put('message', 'Gemini APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    System.debug(LoggingLevel.WARN, 'Gemini API received no valid response.');
                }

            } else {
                mapReturn.put('status', 'ERROR');
                mapReturn.put('message', 'No item IDs provided for update.');
            }
        } catch (Exception e) {
            System.debug('General Error updating SelfCheckItem__c: ' + e.getMessage());
            throw new AuraHandledException('An unexpected error occurred: ' + e.getMessage());
        }
        return mapReturn;
    }

    private static String buildSystemPrompt() {
        return 'ë‹¹ì‹ ì€ ì‚°ì—…ìš© ì‚¬ì¶œì„±í˜•ê¸°ì˜ ê³ ì¥ ë° ìœ„í—˜ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ' +
                'ì‚¬ì¶œì„±í˜•ê¸°ì˜ êµ¬ì¡°, ì‘ë™ ì›ë¦¬, ì¼ë°˜ì ì¸ ê³ ì¥ íŒ¨í„´ì— ëŒ€í•œ ê¹Šì€ ì§€ì‹ì„ ë³´ìœ í•˜ê³  ìˆìœ¼ë©°, ' +
                'Error Alarm ë°ì´í„°ì™€ Case ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í–¥í›„ 1-2ê°œì›” ë‚´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ' +
                'ê¸°ê³„ì  ê³ ì¥, ì„±ëŠ¥ ì €í•˜, ë¶€í’ˆ ë§ˆëª¨ ë“±ì˜ ìœ„í—˜ì„ ì •í™•íˆ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ' +
                'ë°ì´í„° íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¼ë³¸ ì›ì¸ì„ íŒŒì•…í•˜ê³ , ì˜ˆë°© ì •ë¹„ ë°©ì•ˆì„ ì œì‹œí•˜ë©°, ' +
                'ë¹„ìš© íš¨ê³¼ì ì¸ í•´ê²°ì±…ì„ ë„ì¶œí•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ì…ë‹ˆë‹¤. ' +
                'ê³ ê°ì—ê²ŒëŠ” LSMtronì˜ ìœ„í—˜ ë¶„ì„ ì „ë¬¸ Agentë¼ëŠ” ë¸Œëœë“œ ì´ë¯¸ì§€ë¡œ ì†Œê°œë˜ì§€ë§Œ, ' +
                'ì‹¤ì œë¡œëŠ” ì‚¬ì¶œì„±í˜•ê¸° ë¶„ì•¼ì˜ ê¹Šì€ ê¸°ìˆ ì  ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ' +
                'ì‘ë‹µì€ ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.';
    }
    private static String buildUserPrompt(
            RiskAnalyzeReport__c objReport,
            List<SelfCheckItem__c> listCheckItem,
            List<Product2> listProduct,
            List<Case> listCase,
            List<Error_alarm__c> listErrorAlarm
    ) {

        String prompt = 'ğŸ” **ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­** ğŸ”\n\n';
        prompt += 'ğŸ­ **[ASSET ì •ë³´: ' + objReport.Asset__c + ']**\n';
        prompt += 'â€¢ Asset ì œì¡°ì¼ì: ' + (objReport.Asset__r.ManufactureDate != null ? objReport.Asset__r.ManufactureDate.format() : 'N/A') + '\n';
        prompt += 'â€¢ Asset ì„¤ì¹˜ì¼ì: ' + (objReport.Asset__r.InstallDate != null ? objReport.Asset__r.InstallDate.format() : 'N/A') + '\n\n';

        prompt += 'ğŸš¨ **[SelfCheckItem ì‹œì‘]**\n';
        Integer selectNum = 1;
        for (SelfCheckItem__c sc : listCheckItem) {
            prompt += '--- Self Check  #' + selectNum + ' ---\n';
            prompt += 'â€¢ ì„¤ëª…: ' + sc.Description__c + '\n';
            prompt += 'â€¢ ì²´í¬ì—¬ë¶€: ' + sc.IsChecked__c + '\n';
            prompt += '-------------------------\n';
            selectNum++;
        }
        prompt += 'ğŸš¨ **[SelfCheckItem ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì‹œì‘]**\n';
        Integer caseNum = 1;
        for (Case c : listCase) {
            prompt += '--- Case #' + caseNum + ' ---\n';
            prompt += 'â€¢ ì œëª©: ' + c.Subject + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + c.Description + '\n';
            prompt += 'â€¢ ê³ ì¥ìœ í˜•: ' + (c.malfuction_type__c != null ? c.malfuction_type__c : 'N/A') + '\n';
            prompt += 'â€¢ ê³ ì¥ìƒì„¸: ' + (c.Malfunction_Type_Detail__c != null ? c.Malfunction_Type_Detail__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (c.Part_Code__c != null ? c.Part_Code__c : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (c.Part_Name__c != null ? c.Part_Name__c : 'N/A') + '\n';
            prompt += 'â€¢ ìƒì„±ì¼: ' + (c.Date_Time_Open__c != null ? String.valueOf(c.Date_Time_Open__c) : 'N/A') + '\n';
            prompt += 'â€¢ ì¢…ë£Œì¼: ' + (c.Date_Time_Close__c != null ? String.valueOf(c.Date_Time_Close__c) : 'N/A') + '\n';

            prompt += '-------------------------\n';
            caseNum++;
        }
        prompt += 'ğŸš¨ **[CASE ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì‹œì‘]**\n';
        Integer alarmNum = 1;
        for (Error_alarm__c alarm : listErrorAlarm) {
            prompt += '--- Alarm #' + alarmNum + ' ---\n';
            prompt += 'â€¢ ì½”ë“œ: ' + alarm.Code_L__c + '-' + alarm.Code_M__c + '\n';
            prompt += 'â€¢ ì•ŒëŒëª…: ' + (alarm.Code_Name_M__c != null ? alarm.Code_Name_M__c : 'N/A') + '\n';
            prompt += 'â€¢ ì„¤ëª…: ' + (alarm.Alarm_Ex__c != null ? alarm.Alarm_Ex__c : 'N/A') + '\n';
            prompt += 'â€¢ ë°œìƒíšŸìˆ˜: ' + (alarm.Occurrence__c != null ? alarm.Occurrence__c : 0) + '\n';
            prompt += 'â€¢ ì›ì¸1: ' + (alarm.Reason_1__c != null ? alarm.Reason_1__c : 'N/A') + '\n';
            prompt += 'â€¢ ì›ì¸2: ' + (alarm.Reason_2__c != null ? alarm.Reason_2__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼1: ' + (alarm.Expectation_1st__c != null ? alarm.Expectation_1st__c : 'N/A') + '\n';
            prompt += 'â€¢ ì˜ˆìƒê²°ê³¼2: ' + (alarm.Expectation_2nd__c != null ? alarm.Expectation_2nd__c : 'N/A') + '\n';
            prompt += 'â€¢ ë©”ì‹œì§€: ' + (alarm.Message__c != null ? alarm.Message__c : 'N/A') + '\n';
            prompt += '-------------------------\n';
            alarmNum++;
        }
        prompt += 'âš ï¸ **[ERROR ALARM ë°ì´í„° ì¢…ë£Œ]**\n\n';

        prompt += 'âš ï¸ **[Product ë°ì´í„° ì‹œì‘]**\n';
        Integer productNum = 1;
        for (Product2 objProduct: listProduct) {
            prompt += '--- objProduct #' + productNum + ' ---\n';
            prompt += 'â€¢ ë¶€í’ˆëª…: ' + (objProduct.Name != null ? objProduct.Name : 'N/A') + '\n';
            prompt += 'â€¢ ë¶€í’ˆì½”ë“œ: ' + (objProduct.ProductCode != null ? objProduct.ProductCode : 'N/A') + '\n';
            prompt += 'â€¢ ê°€ê²©: ' + (objProduct.Price__c != null ? objProduct.Price__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ì—¬ë¶€: ' + (objProduct.Stock__c != null ? objProduct.Stock__c : 'N/A') + '\n';
            prompt += 'â€¢ ì¬ê³ ìˆ˜: ' + (objProduct.Quantity__c != null ? objProduct.Quantity__c.format() : 'N/A') + '\n';
            prompt += 'â€¢ êµì²´ì£¼ê¸°: ' + (objProduct.Replacement_Cycle__c != null ? objProduct.Replacement_Cycle__c : 'N/A') + '\n';
            prompt += '-------------------------\n';
            productNum++;
        }
        prompt += 'âš ï¸ **[Product ë°ì´í„° ì¢…ë£Œ]**\n\n';
        prompt += 'ğŸ”š **[ì‚¬ì¶œì„±í˜•ê¸° ìœ„í—˜ ë¶„ì„ ìš”ì²­ ì™„ë£Œ]**\n';
        prompt += '==========================================\n\n';

        prompt += 'âœ… **[ë¶„ì„ ìš”êµ¬ì‚¬í•­]**\n\n';
        prompt += 'ğŸ“§ **1. ìê°€ ì ê²€ ê²°ê³¼ ê¸°ë°˜ í–‰ë™ ì¶”ì²œ:**\n';
        prompt += '     - **reportId (String):** í˜„ì¬ ë¶„ì„ ì¤‘ì¸ RiskAnalyzeReport__c ë ˆì½”ë“œì˜ Id.\n'; // âœ¨ ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ âœ¨
        prompt += '     - **analysisSummary (String):** ê³ ê°ì˜ ìê°€ ì ê²€ `IsChecked__c` ê°’ì´ `true`ì¸ í•­ëª©ë“¤ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ í˜„ì¬ ê¸°ê³„ ìƒíƒœì— ëŒ€í•œ ìš”ì•½ê³¼ ì ì¬ì  ë¬¸ì œì ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ' +
                'íŠ¹íˆ `false`ì¸ í•­ëª©ì´ ìˆë‹¤ë©´, ì´ëŠ” ì •ìƒì ì¸ ìƒíƒœë¥¼ ì˜ë¯¸í•˜ë¯€ë¡œ, `true`ì¸ í•­ëª©ì— ë”ìš± ì§‘ì¤‘í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.\n';
        prompt += '     - **recommendedActions (Array of Objects):** ê³ ê°ì˜ ìê°€ ì ê²€ ê²°ê³¼(`IsChecked__c`ê°€ `true`ì¸ í•­ëª©)ì™€ ì œê³µëœ Case, Error Alarm ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ ì¶”ì²œ ëª©ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.\n';
        prompt += '         - **actionIndex (Integer):** ê° ì¶”ì²œ í–‰ë™ì˜ ê³ ìœ  ì¸ë±ìŠ¤.\n';
        prompt += '         - **faultType (String):** ì˜ˆì¸¡ë˜ëŠ” ê³ ì¥ ìœ í˜• (ì˜ˆ: "M)ì œì–´(ì•ŒëŒ/ë™ì‘ì´ìƒ)"). Case ë°ì´í„°ì˜ `malfuction_type__c` ë˜ëŠ” Error Alarmì˜ `Code_Name_M__c`ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultDetailType (String):** ê³ ì¥ ì„¸ë¶€ ìœ í˜• (ì˜ˆ: "M01)í†µì‹ ì•ŒëŒ", "L03)ìœ ì••ìœ  ëˆ„ìœ "). Case ë°ì´í„°ì˜ `Malfunction_Type_Detail__c` ë˜ëŠ” Error Alarmì˜ `Alarm_Ex__c`ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultReason (String):** ì˜ˆìƒë˜ëŠ” ê³ ì¥ ì›ì¸ (ì˜ˆ: "CC10)ì‚¬ìš©/ë¶€í’ˆ/ê¸°ëŠ¥ê³ ì¥", "ì˜¤ì¼ ì—´í™”", "ì„¼ì„œ ì˜¤ì‘ë™"). Error Alarmì˜ `Reason_1__c`, `Reason_2__c` ë˜ëŠ” Caseì˜ `Description`ì„ ì°¸ê³ í•˜ì—¬ ì¶”ë¡ í•©ë‹ˆë‹¤.\n';
        prompt += '         - **faultLocation (String):** ê²°í•¨ ì˜ˆìƒ ìœ„ì¹˜ (ì˜ˆ: "EL)ì „ì¥", "HY)ìœ ì••ë¶€", "MO)ëª¨í„°ë¶€"). Caseë‚˜ Error Alarm ë°ì´í„°ì—ì„œ ìœ ì¶”í•˜ê±°ë‚˜, ìê°€ ì ê²€ ì§ˆë¬¸ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.\n';
        prompt += '         - **actionDescription (String):** í•´ë‹¹ ê³ ì¥ ìœ í˜• ë° ì›ì¸ì— ëŒ€í•œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í–‰ë™ ì¶”ì²œ ë‚´ìš©. (ì˜ˆ: "ì œì–´ë°˜ ë‚´ë¶€ íŒ¬ ì ê²€ ë° ë¨¼ì§€ ì œê±°, í•„ìš”ì‹œ ì—´í™”ìƒ ì¹´ë©”ë¼ë¡œ ì˜¨ë„ ì¸¡ì •", "ìœ ì••ìœ  ìƒíƒœ ì ê²€ ë° êµì²´", "ê´€ë ¨ ì„¼ì„œ ë‹¨ìë¶€ ì²­ì†Œ ë° ì¬ì—°ê²°").\n';
        prompt += '         - **partsNeeded (Array of Objects):** í•´ë‹¹ ì¡°ì¹˜ì— í•„ìš”í•  ìˆ˜ ìˆëŠ” Product2 ë ˆì½”ë“œì˜ **`Product__c` (Id)ì™€ `productCode`ë¥¼ í¬í•¨í•˜ëŠ” ê°ì²´ ë°°ì—´**. ì œê³µëœ Product2 ë°ì´í„°ì—ì„œ, ê´€ë ¨ëœ ë¶€í’ˆì˜ `Id`ë¥¼ `Product__c`ë¡œ, `ProductCode`ë¥¼ `productCode`ë¡œ í¬í•¨í•©ë‹ˆë‹¤.\n\n'; // âœ¨ ì§€ì¹¨ ë³€ê²½ âœ¨

        prompt += 'ğŸ¯ **[ì£¼ìš” ì§€ì¹¨]**\n';
        prompt += 'â€¢ ì œê³µëœ **ìê°€ ì ê²€ ê²°ê³¼(listCheckItem)**ì—ì„œ `IsChecked__c`ê°€ `true`ì¸ í•­ëª©ë“¤ì„ í•µì‹¬ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `true`ë¡œ ì‘ë‹µëœ ìê°€ ì ê²€ í•­ëª©ê³¼ ê³¼ê±° Case, Error Alarm ë°ì´í„°ë¥¼ ìƒí˜¸ ì°¸ì¡°í•˜ì—¬, ì–´ë–¤ ê³ ì¥ ìœ í˜• ë° ì›ì¸ì´ í˜„ì¬ ë°œìƒí•˜ê³  ìˆê±°ë‚˜ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ì€ì§€ ì¶”ë¡ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ ê° ì˜ˆì¸¡ëœ ë¬¸ì œì— ëŒ€í•´ ìš”êµ¬ëœ í•­ëª©ë“¤(faultType, faultDetailType, faultReason, faultLocation, actionDescription, partsNeeded)ì„ ìƒì„¸í•˜ê²Œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `actionDescription`ì€ ê³ ê°ì´ ì§ì ‘ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ìê°€ ì ê²€/ì˜ˆë°© ì •ë¹„ ê´€ì ì—ì„œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n';
        prompt += 'â€¢ `partsNeeded`ëŠ” Product2 ë°ì´í„°ì—ì„œ ê´€ë ¨ ë¶€í’ˆì„ ì°¾ì•„ **í•´ë‹¹ ë¶€í’ˆì˜ `Id`ëŠ” `Product__c` í•„ë“œì—, `ProductCode`ëŠ” `productCode` í•„ë“œì— í¬í•¨í•˜ëŠ” ê°ì²´(`{"Product__c": "...", "productCode": "..."}`) í˜•íƒœë¡œ ì œê³µ**í•©ë‹ˆë‹¤. í•´ë‹¹ ë¶€í’ˆì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ë‘¡ë‹ˆë‹¤.\n'; // âœ¨ ì§€ì¹¨ ë³€ê²½ âœ¨
        prompt += 'â€¢ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n\n';
        prompt += 'â­ ì‘ë‹µ í˜•ì‹:** {"selfCheckReport": {...}}';

        return prompt;
    }

    private static Map<String, Object> getProcessActionRecAndProduct() {
        return new Map<String, Object>{
                'type' => 'object',
                'properties' => new Map<String, Object>{
                        'selfCheckReport' => new Map<String, Object>{
                                'type' => 'object',
                                'properties' => new Map<String, Object>{
                                        'reportId' => new Map<String, Object>{'type' => 'string', 'description' => 'ì—°ê´€ëœ RiskAnalyzeReport__c ë ˆì½”ë“œì˜ Id'}, // âœ¨ ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ âœ¨
                                        'analysisSummary' => new Map<String, Object>{
                                                'type' => 'string',
                                                'description' => 'ê³ ê°ì˜ ìê°€ ì ê²€ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ í˜„ì¬ ê¸°ê³„ ìƒíƒœì™€ ì ì¬ì  ë¬¸ì œì ì„ ì„¤ëª…í•˜ëŠ” ìš”ì•½'
                                        },
                                        'recommendedActions' => new Map<String, Object>{
                                                'type' => 'array',
                                                'items' => new Map<String, Object>{
                                                        'type' => 'object',
                                                        'properties' => new Map<String, Object>{
                                                                'actionIndex' => new Map<String, Object>{'type' => 'integer', 'description' => 'ê° ì¶”ì²œ í–‰ë™ì˜ ê³ ìœ  ì¸ë±ìŠ¤'},
                                                                'faultType' => new Map<String, Object>{'type' => 'string', 'description' => 'ì˜ˆì¸¡ë˜ëŠ” ê³ ì¥ ìœ í˜•'},
                                                                'faultDetailType' => new Map<String, Object>{'type' => 'string', 'description' => 'ê³ ì¥ ì„¸ë¶€ ìœ í˜•'},
                                                                'faultReason' => new Map<String, Object>{'type' => 'string', 'description' => 'ì˜ˆìƒë˜ëŠ” ê³ ì¥ ì›ì¸'},
                                                                'faultLocation' => new Map<String, Object>{'type' => 'string', 'description' => 'ê²°í•¨ ì˜ˆìƒ ìœ„ì¹˜'},
                                                                'actionDescription' => new Map<String, Object>{'type' => 'string', 'description' => 'êµ¬ì²´ì ì¸ í–‰ë™ ì¶”ì²œ ë‚´ìš©'},
                                                                'partsNeeded' => new Map<String, Object>{
                                                                        'type' => 'array',
                                                                        'items' => new Map<String, Object>{
                                                                                'type' => 'object',
                                                                                'properties' => new Map<String, Object>{
                                                                                        'Product__c' => new Map<String, Object>{'type' => 'string', 'description' => 'Product2 ë ˆì½”ë“œì˜ Id'},
                                                                                        'productCode' => new Map<String, Object>{'type' => 'string', 'description' => 'Product2 ë ˆì½”ë“œì˜ ProductCode'}
                                                                                },
                                                                                'required' => new List<String>{'Product__c', 'productCode'}
                                                                        },
                                                                        'description' => 'í•´ë‹¹ ì¡°ì¹˜ì— í•„ìš”í•  ìˆ˜ ìˆëŠ” Product2 ë ˆì½”ë“œì˜ Id ë° ProductCode ëª©ë¡'
                                                                }
                                                        },
                                                        'required' => new List<String>{
                                                                'actionIndex',
                                                                'faultType',
                                                                'faultDetailType',
                                                                'faultReason',
                                                                'faultLocation',
                                                                'actionDescription',
                                                                'partsNeeded'
                                                        }
                                                }
                                        }
                                },
                                'required' => new List<String>{'reportId', 'analysisSummary', 'recommendedActions'}
                        }
                },
                'required' => new List<String>{'selfCheckReport'}
        };
    }

    private static Map<String, Object> processGeminiResponse(String jsonResponse) {
        Map<String, Object> returnMap = new Map<String, Object>();
        returnMap.put('hasPredictions', false); // Default to no predictions

        try {
            Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(jsonResponse);

            // 'errorReportResults' ëŒ€ì‹  'selfCheckReport'ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            Map<String, Object> selfCheckReport = (Map<String, Object>) responseMap.get('selfCheckReport');

            if (selfCheckReport == null || selfCheckReport.isEmpty()) {
                returnMap.put('message', 'No selfCheckReport found in Gemini response.');
                System.debug('No selfCheckReport found in response.');
                return returnMap;
            }

            // 'riskItems' ëŒ€ì‹  'recommendedActions'ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            List<Object> recommendedActions = (List<Object>) selfCheckReport.get('recommendedActions');

            if (recommendedActions == null || recommendedActions.isEmpty()) {
                returnMap.put('message', 'No recommendedActions found in selfCheckReport.');
                return returnMap;
            }

            // ì„ íƒ ì‚¬í•­: reportIdë„ ê°€ì ¸ì™€ì„œ LWCë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            String reportId = (String) selfCheckReport.get('reportId');
            if (reportId != null) {
                returnMap.put('reportId', reportId);
            }

            // ì„ íƒ ì‚¬í•­: analysisSummaryë„ ê°€ì ¸ì™€ì„œ LWCë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            String analysisSummary = (String) selfCheckReport.get('analysisSummary');
            if (analysisSummary != null) {
                returnMap.put('analysisSummary', analysisSummary);
            }

            List<Map<String, Object>> displayRecommendedActions = new List<Map<String, Object>>();

            for (Object actionObj : recommendedActions) {
                Map<String, Object> actionItem = (Map<String, Object>) actionObj;

                Map<String, Object> itemToDisplay = new Map<String, Object>(); // Object íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ List<Object>ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë„ë¡ í•¨
                // Safely get string values for display, handling potential nulls
                itemToDisplay.put('id', String.valueOf(actionItem.get('actionIndex'))); // LWCì˜ key propì„ ìœ„í•´ id ì¶”ê°€
                itemToDisplay.put('actionIndex', actionItem.get('actionIndex'));
                itemToDisplay.put('faultType', String.valueOf(actionItem.get('faultType')));
                itemToDisplay.put('faultDetailType', String.valueOf(actionItem.get('faultDetailType')));
                itemToDisplay.put('faultReason', String.valueOf(actionItem.get('faultReason')));
                itemToDisplay.put('faultLocation', String.valueOf(actionItem.get('faultLocation')));
                itemToDisplay.put('actionDescription', String.valueOf(actionItem.get('actionDescription')));

                // partsNeeded ì²˜ë¦¬ (ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ì— Map<String, String> í˜•íƒœ)
                List<Object> partsNeededRaw = (List<Object>) actionItem.get('partsNeeded');
                List<Map<String, String>> partsNeededFormatted = new List<Map<String, String>>();
                if (partsNeededRaw != null) {
                    for (Object partObj : partsNeededRaw) {
                        Map<String, Object> partMap = (Map<String, Object>) partObj;
                        Map<String, String> formattedPart = new Map<String, String>();
                        formattedPart.put('Product__c', String.valueOf(partMap.get('Product__c'))); // Product2 Id
                        formattedPart.put('productCode', String.valueOf(partMap.get('productCode'))); // ProductCode
                        // RiskAnalyzeReport__cëŠ” partsNeeded ë‚´ë¶€ ê°ì²´ì— í¬í•¨í•˜ëŠ” ê²½ìš° ì—¬ê¸°ì— ì¶”ê°€
                        // formattedPart.put('RiskAnalyzeReport__c', String.valueOf(partMap.get('RiskAnalyzeReport__c')));
                        partsNeededFormatted.add(formattedPart);
                    }
                }
                itemToDisplay.put('partsNeeded', partsNeededFormatted); // LWCë¡œ ì „ë‹¬í•  partsNeeded

                displayRecommendedActions.add(itemToDisplay);
            }

            returnMap.put('hasPredictions', true);
            returnMap.put('recommendedActions', displayRecommendedActions); // 'riskItems' ëŒ€ì‹  'recommendedActions'
            returnMap.put('message', 'ì„±ê³µì ìœ¼ë¡œ ìê°€ ì ê²€ ê¸°ë°˜ í–‰ë™ ì¶”ì²œ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');

            System.debug('Total recommended actions: ' + displayRecommendedActions.size());

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error processing Gemini response for display: ' + e.getMessage() + '\nStack Trace: ' + e.getStackTraceString());
            returnMap.put('message', 'ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }

        System.debug('returnMap : ' + JSON.serializePretty(returnMap));
        return returnMap;
    }
}